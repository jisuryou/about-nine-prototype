<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¸ì¦ë²ˆí˜¸ ì…ë ¥</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>
  </head>
  <body>
    <div class="container">
      <div>
        <h1 class="brand-text">enter the code<br />sent to the message</h1>

        <div class="code-inputs" id="codeInputs">
          <input type="text" class="code-input" maxlength="1" data-index="0" />
          <input type="text" class="code-input" maxlength="1" data-index="1" />
          <input type="text" class="code-input" maxlength="1" data-index="2" />
          <input type="text" class="code-input" maxlength="1" data-index="3" />
          <input type="text" class="code-input" maxlength="1" data-index="4" />
          <input type="text" class="code-input" maxlength="1" data-index="5" />
        </div>

        <span id="error" class="error hidden"></span>

        <div class="timer-text">
          haven't received it? <span id="timer">02:59</span>
          <br>
          <span class="resend-link" id="resendLink" onclick="resendOTP()"
            >resend now</span
          >
        </div>
      </div>

      <button id="nextBtn" onclick="verifyOTP()" disabled>next</button>
    </div>

    <!-- Firebase invisible recaptcha -->
    <div id="recaptcha-container"></div>

    <script src="js/common.js"></script>
    <script>
      const inputs = document.querySelectorAll(".code-input");
      const nextBtn = document.getElementById("nextBtn");
      let timerSeconds = 179; // 2:59
      let timerInterval;
      let resendInProgress = false;

      // ìë™ í¬ì»¤ìŠ¤ ë° ì…ë ¥ ì²˜ë¦¬
      inputs.forEach((input, index) => {
        input.addEventListener("input", (e) => {
          const value = e.target.value.replace(/[^0-9]/g, "");
          e.target.value = value;

          if (value && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }

          checkComplete();
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !e.target.value && index > 0) {
            inputs[index - 1].focus();
          }
        });

        input.addEventListener("paste", (e) => {
          e.preventDefault();
          const pasteData = e.clipboardData
            .getData("text")
            .replace(/[^0-9]/g, "");

          pasteData.split("").forEach((char, i) => {
            if (index + i < inputs.length) {
              inputs[index + i].value = char;
            }
          });

          checkComplete();
        });
      });

      function checkComplete() {
        const code = Array.from(inputs)
          .map((i) => i.value)
          .join("");
        nextBtn.disabled = code.length !== 6;
      }

      function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          timerSeconds--;
          const mins = Math.floor(timerSeconds / 60);
          const secs = timerSeconds % 60;
          document.getElementById("timer").textContent =
            `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;

          if (timerSeconds <= 0) {
            clearInterval(timerInterval);
            document.getElementById("timer").textContent = "00:00";
          }
        }, 1000);
      }

      function resetTimer() {
        timerSeconds = 179;
        startTimer();
      }

      async function resendOTP() {
        if (resendInProgress) return;
        resendInProgress = true;
        hideError("error");

        const phone = getFromLocal("phone");
        if (!phone) {
          showError("error", "phone not found, please go back");
          resendInProgress = false;
          return;
        }

        try {
          showLoading("resending code...");

          if (!window.recaptchaVerifier) {
            initRecaptcha();
          }

          await sendFirebaseOTP(phone);

          inputs.forEach((i) => (i.value = ""));
          inputs[0].focus();
          checkComplete();
          resetTimer();
          hideLoading();
        } catch (e) {
          console.error("RESEND FAIL:", e);
          hideLoading();
          showError("error", "failed to resend code");
        } finally {
          resendInProgress = false;
        }
      }

      async function verifyOTP() {
        const code = Array.from(inputs)
          .map((i) => i.value)
          .join("");

        try {
          console.log("STEP1: verifying firebase");
          const idToken = await verifyFirebaseOTP(code);

          console.log("STEP2: idToken:", idToken);

          console.log("STEP3: calling backend");

          const result = await apiCall("/auth/firebase-login", "POST", {
            idToken,
          });

          saveToLocal("user_id", result.user_id);

          console.log("STEP4: success");

          // ğŸ”¥ ê¸°ì¡´ ìœ ì € vs ì‹ ê·œ ìœ ì € ë¶„ê¸°
          if (result.is_existing_user) {
            console.log("âœ… Existing user â†’ lounge.html");
            navigateTo("lounge.html");
          } else {
            console.log("ğŸ†• New user â†’ birthdate.html");
            navigateTo("birthdate.html");
          }

        } catch (e) {
          console.error("OTP FAIL:", e);
          if (e?.message?.includes("invite required")) {
            showError("error", "invite code required");
          } else {
            showError("error", "invalid code");
          }
        }
      }

      // ì²« ì…ë ¥ì°½ì— ìë™ í¬ì»¤ìŠ¤
      inputs[0].focus();
      startTimer();
    </script>
  </body>
</html>
