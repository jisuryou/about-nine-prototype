<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>인증번호 입력</title>
  <link rel="stylesheet" href="css/style.css">
  <script type="module" src="js/firebase-config.js"></script>
</head>
<body>
  <div class="container">
    <div>
      <h1>enter the code<br>sent to the message</h1>
      
      <div class="code-inputs" id="codeInputs">
        <input type="text" class="code-input" maxlength="1" data-index="0">
        <input type="text" class="code-input" maxlength="1" data-index="1">
        <input type="text" class="code-input" maxlength="1" data-index="2">
        <input type="text" class="code-input" maxlength="1" data-index="3">
        <input type="text" class="code-input" maxlength="1" data-index="4">
        <input type="text" class="code-input" maxlength="1" data-index="5">
      </div>
      
      <span id="error" class="error hidden"></span>
      
      <div class="timer-text">
        haven't received it? <span id="timer">02:59</span>
        <span class="resend-link hidden" id="resendLink" onclick="resendOTP()">resend now</span>
      </div>
    </div>
    
    <button id="nextBtn" onclick="verifyOTP()" disabled>next</button>
  </div>
  
  <script src="js/common.js"></script>
  <script>
    const inputs = document.querySelectorAll('.code-input');
    const nextBtn = document.getElementById('nextBtn');
    let timerSeconds = 179; // 2:59
    let timerInterval;
    
    // 자동 포커스 및 입력 처리
    inputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const value = e.target.value.replace(/[^0-9]/g, '');
        e.target.value = value;
        
        if (value && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
        
        checkComplete();
      });
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          inputs[index - 1].focus();
        }
      });
      
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pasteData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
        
        pasteData.split('').forEach((char, i) => {
          if (index + i < inputs.length) {
            inputs[index + i].value = char;
          }
        });
        
        checkComplete();
      });
    });
    
    function checkComplete() {
      const code = Array.from(inputs).map(i => i.value).join('');
      nextBtn.disabled = code.length !== 6;
    }
    
    function startTimer() {
      timerInterval = setInterval(() => {
        timerSeconds--;
        const mins = Math.floor(timerSeconds / 60);
        const secs = timerSeconds % 60;
        document.getElementById('timer').textContent = 
          `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        
        if (timerSeconds <= 0) {
          clearInterval(timerInterval);
          document.getElementById('timer').classList.add('hidden');
          document.getElementById('resendLink').classList.remove('hidden');
        }
      }, 1000);
    }
    
    async function verifyOTP() {
        const code = Array.from(inputs).map(i => i.value).join('');

        try {
            showLoading('verifying...');
            const idToken = await verifyFirebaseOTP(code);

            await apiCall('/api/auth/firebase-login', 'POST', { idToken });

            hideLoading();
            navigateTo('birthdate.html');
        } catch (e) {
            hideLoading();
            showError('error', 'invalid code');
        }
    }
    
    // 첫 입력창에 자동 포커스
    inputs[0].focus();
    startTimer();

  </script>
</body>
</html>