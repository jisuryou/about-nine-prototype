<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Talk</title>

    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>

    <!-- Agora SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.19.0.js"></script>

    <style>
      .voice-container {
        width: 100%;
        max-width: 480px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 30px 20px;
        font-family: "Merriweather", serif;
        justify-content: space-between;
        overflow: hidden;
      }

      .voice-images {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
        justify-content: center;
      }

      .voice-image-card {
        position: relative;
        border-radius: 20px;
        overflow: hidden;
      }

      .voice-image-card img {
        width: 100%;
        height: 30vh;
        object-fit: cover;
      }

      .voice-image-label {
        position: absolute;
        bottom: 12px;
        right: 12px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 14px;
      }

      .voice-timer {
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 2px;
        margin-bottom: 20px;
      }

      .voice-controls {
        display: flex;
        justify-content: center;
        gap: 40px;
      }

      .control-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #525252;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
      }

      .control-btn svg {
        width: 26px;
        height: 26px;
        stroke: white;
      }

      .control-btn.active {
        background: var(--accent-yellow);
      }

      .control-btn.active svg {
        stroke: black;
      }

      .control-btn.end-call {
        background: #ff4444;
      }

      .life-guide {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 14px;
        margin-top: 10px;
      }

      .life-card {
        background: #e0e0e0;
        border-radius: 16px;
        height: 110px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        color: #222;
        text-transform: lowercase;
      }

      .life-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      .life-modal.active {
        display: flex;
      }

      .life-modal-content {
        background: #e0e0e0;
        border-radius: 20px;
        width: 80%;
        max-width: 360px;
        min-height: 220px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
      }

      .life-modal-category {
        font-size: 12px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: #666;
        margin-bottom: 14px;
      }

      .life-modal-question {
        font-size: 16px;
        color: #222;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <div class="voice-container">
      <div class="card" id="voiceQuestion" style="font-size: 14px"></div>

      <div class="voice-images">
        <div class="voice-image-card">
          <img id="myImage" />
          <div class="voice-image-label" id="myName"></div>
        </div>
        <div class="voice-image-card">
          <img id="partnerImage" />
          <div class="voice-image-label" id="partnerName"></div>
        </div>
      </div>

      <div class="life-guide" id="lifeGuide" style="display: none"></div>

      <div class="voice-timer" id="voiceTimer">00:00</div>

      <div class="voice-controls">
        <!-- ÎßàÏù¥ÌÅ¨ -->
        <button class="control-btn" id="muteBtn" onclick="toggleMute()">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
            <path d="M12 19v4" />
          </svg>
        </button>

        <!-- Ï¢ÖÎ£å -->
        <button
          class="control-btn end-call"
          id="endCallBtn"
          onclick="endCall()"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke-width="2"
            xmlns="http://www.w3.org"
          >
            <path
              d="M6.62 10.79C8.06 13.62 10.38 15.94 13.21 17.38L15.41 15.18C15.68 14.91 16.08 14.82 16.43 14.94C17.55 15.31 18.76 15.51 20 15.51C20.55 15.51 21 15.96 21 16.51V20C21 20.55 20.55 21 20 21C10.61 21 3 13.39 3 4C3 3.45 3.45 3 4 3H7.5C8.05 3 8.5 3.45 8.5 4C8.5 5.24 8.7 6.45 9.07 7.57C9.18 7.92 9.1 8.31 8.82 8.59L6.62 10.79Z"
            />
          </svg>
        </button>
      </div>
    </div>

    <div class="life-modal" id="lifeModal">
      <div class="life-modal-content">
        <div class="life-modal-category" id="lifeModalCategory"></div>
        <div class="life-modal-question" id="lifeModalQuestion"></div>
      </div>
    </div>

    <script src="js/common.js"></script>

    <script type="module">
      import { rtdb, ref, get, update, onValue } from "/js/firebase.js";

      const userId = getFromLocal("user_id");
      if (!userId) navigateTo("index.html");

      const partner = getFromLocal("chat_partner");
      const question = getFromLocal("current_question");
      const mySelection = getFromLocal("user_selection");
      const topic = getFromLocal("current_topic");
      const requestId = getFromLocal("match_request_id");

      const isLifeRound = topic === "life";

      const AGORA_APP_ID = "ebc1a1bf4b4347cd896087d76d9e32db";

      let agoraClient;
      let localAudioTrack;
      let isMuted = false;
      let timer;
      let callStart;

      /* ================= UI ================= */

      if (!partner || !requestId) {
        alert("invalid request");
        navigateTo("lounge.html");
      }

      document.getElementById("voiceQuestion").textContent = isLifeRound
        ? "choose a topic and discuss it freely"
        : question;
      document.getElementById("myName").textContent = "You";
      const first = partner?.firstName || partner?.first_name || "";
      const last = partner?.lastName || partner?.last_name || "";
      document.getElementById("partnerName").textContent =
        `${first} ${last}`.trim() || "your match";

      if (isLifeRound) {
        document.querySelector(".voice-images").style.display = "none";
        document.getElementById("lifeGuide").style.display = "grid";
        renderLifeGuide();
      }

      /* ================= Images ================= */

      async function loadImages() {
        const snap = await get(ref(rtdb, `match_requests/${requestId}`));
        const data = snap.val();
        if (!data) {
          alert("request not found");
          navigateTo("lounge.html");
          return;
        }
        const options = data.options;
        if (!options || !Array.isArray(options)) return;

        const isInitiator = data.initiator === userId;
        const partnerSel = isInitiator
          ? data.receiver_selection
          : data.initiator_selection;

        const myOpt = options.find((o) => o.category === mySelection);
        const partnerOpt = options.find((o) => o.category === partnerSel);

        if (myOpt)
          myImage.src = `/images/${topic}/${myOpt.category}/${myOpt.fileName}`;

        if (partnerOpt)
          partnerImage.src = `/images/${topic}/${partnerOpt.category}/${partnerOpt.fileName}`;
      }

      const GUIDE_QUESTIONS = {
        life: [
          "What's more important in a long-term relationship: stability or excitement?",
          "What's your biggest non-negotiable value in life?",
          "Do you admire your parents' relationship or want something completely different?",
          "Do you believe in second chances after cheating?",
          'What does the phrase "living your best life" mean to you?',
          "Do you think marriage is essential in life?",
          "When your values conflict with your parents' values, whose do you follow?",
          "What's your top priority in life: money, love, or success?",
          "Can you give up reality for your dreams?",
          "What's the proudest moment of your life?",
          "If you had to choose between protecting your family or your partner, which would it be?",
          "Would you rather have the same career for life, or completely change careers every 10 years?",
          'How do you define a "happy life"?',
          "What's the scariest thing about life to you?",
          "If someone loves you intensely but could make you unhappy, would you still choose them?",
          "Do you have any secrets you're keeping from your family?",
          "Would you give up love for success?",
          'Do you believe in "destined encounters"?',
          "If you could achieve only one thing in your entire life, what would you choose?",
          "Do you think people can truly change?",
          "When in your life did you feel most alive, and why?",
          "If you could erase one regret, would you do it‚Äîor do regrets shape who you are?",
          "Do you think happiness comes more from achieving goals or from appreciating what you already have?",
          "What's a value you would never compromise on, even for someone you love deeply?",
        ],
        travel: [
          "Would you rather road-trip across the U.S. or backpack through Asia?",
          "What's more fun: theme parks or national parks?",
          "How do you feel about camping‚Äîromantic or miserable?",
          "Do you prefer tourist spots or hidden gems?",
          "Would you rather do skydiving on vacation or a couples' spa?",
          "Which do you prefer: beach or mountains?",
          "Urban travel or nature travel‚Äîwhich appeals to you more?",
          "Do you like spontaneous trips or thorough planning?",
          "For accommodations, luxury hotel or guesthouse?",
          "If you fight with your partner during a trip, how do you resolve it?",
          "Do you want to do adventurous activities when traveling?",
          "What would you do if your partner has a completely different travel style?",
          "Trying local food vs. sticking to familiar food‚Äîwhich one?",
          "If you could only travel to one country for the rest of your life, where would you go?",
          "Do you think traveling with someone reveals their true personality more than daily life does?",
          "What's one place that changed the way you see the world?",
          "Would you rather visit every country once, or return to one place you love every year?",
          "Do you believe where you go matters more, or who you go with?",
          "If you could design the perfect couples' trip, what emotions would you want it to create‚Äîromance, thrill, peace, or discovery?",
        ],
        money: [
          "Do you think expensive gifts show love, or is thoughtfulness more important?",
          "How would you feel if your partner made way more money than you?",
          "Would you rather invest in a home or travel the world?",
          "If you won the lottery, what's the first thing you'd spend on with your partner?",
          "Do you think money can buy happiness?",
          "Do you think love can be shaken because of money?",
          "If it's something you want to do for life but pays nothing, would you still do it?",
          "If you had to choose between money or time, which would it be?",
          "How much do you think you should know about your partner's financial situation?",
          "When traveling, what's more important: value for money or luxury?",
          "When do you think is the best moment to spend money?",
          "Do you believe you can have a joyful relationship even if you're poor?",
          "If you have more money, does love grow deeper too?",
          "Do you think you can prove love with money?",
          "If you and your partner earned very different salaries, how would you want to handle it?",
          "What's one financial decision you'd want to make together as a couple, not alone?",
          "Would you rather be with someone generous but irresponsible, or disciplined but stingy?",
        ],
        time: [
          "Is daily texting a must, or are you fine with space?",
          "How would you spend a perfect Sunday together?",
          "Do you think long-distance can work if you're both busy?",
          "Are birthdays and anniversaries a big deal to you, or not really?",
          "Would you rather binge a Netflix series together or go out every night?",
          "What feels longer‚Äîwaiting for a text back or sitting in traffic?",
          "Is being on time important to you, or are you usually casual about it?",
          "Do you prefer spontaneous dates or scheduled ones?",
          "Would you give up sleep for more time with your partner?",
          "Are you a morning person or a night owl?",
          "Which do you prefer: morning walks or late-night drives?",
          "Do you spend weekends actively or just relaxing?",
          "Can you tolerate a partner who's bad with time management?",
          "Would you wait for a partner who shows up an hour late to a date?",
          "What time of day do you most want to spend with your partner?",
          'If your partner says "I\'m too busy with work" on a special occasion, can you understand?',
          "Do you need alone time, or do you prefer being together constantly?",
          "How do you feel about spending all day with your partner?",
          "Do you think how someone spends their free time reveals who they truly are?",
          "What's a moment in time you wish you could pause forever?",
          "Do you see time as something you own, or something that owns you?",
          'If love had an "expiration date," how long would be enough for you to feel it was worth it?',
          "Do you think people grow apart more because of lost time together or because of changed priorities?",
        ],
        love: [
          "Do you believe in love at first sight?",
          "Do you like grand romantic gestures or subtle daily ones?",
          "How important is kissing compatibility?",
          'Do you think it\'s normal to say "I love you" within a few months?',
          "Do you think sexual chemistry can make or break a relationship?",
          "What's sexier: confidence or mystery?",
          "Would you ever mix romance with a little bit of risk (like in public)?",
          "Are you okay with public displays of affection?",
          "Do you prefer expressing affection with words or actions?",
          "Are you more proactive when it comes to physical affection?",
          "Do you feel hurt if your partner declines physical affection when you want it?",
          "In physical affection, are you the one who leads or prefers to be led?",
          "If you could only have one form of affection for life, what would you choose? (kissing, hugging, holding hands, etc.)",
          "Do you think love is a choice we make every day, or a feeling we can't control?",
          "What's the smallest gesture from a partner that makes you feel deeply loved?",
          "Do you think long-lasting passion is real, or does it inevitably fade?",
          "Would you rather have a partner who excites you endlessly but is unstable, or one who is steady but less thrilling?",
          "What scares you more in love‚Äîbeing vulnerable or being taken for granted?",
        ],
        relationship: [
          "Do you believe arguments make a relationship stronger or weaker?",
          "What's your biggest dealbreaker in a relationship?",
          "Do you think jealousy is a sign of love or insecurity?",
          "Should couples share passwords or keep digital privacy?",
          'Do you believe in "breaks" in relationships, or is that just a breakup in disguise?',
          "How do you usually handle conflict: talk it out, cool off, or avoid it?",
          "How much independence should partners have in a relationship?",
          'Do you believe "opposites attract," or do similar personalities last longer?',
          "What makes you feel most secure in a relationship‚Äîwords, actions, or consistency?",
          "Do you think long-term relationships should feel easy, or is effort always required?",
          "Do you think love is proven more by how someone treats you on good days or on bad days?",
          "Do you think trust, once broken, can ever be fully restored?",
          "Would you rather have a partner who challenges you constantly or one who always supports you?",
          "Do you think the strongest relationships are built on similarity, or on learning to navigate differences?",
        ],
      };

      function buildLifeQuestions() {
        const stored = getFromLocal("life_guide_questions");
        if (stored && typeof stored === "object") {
          return stored;
        }

        const categories = [
          "life",
          "time",
          "travel",
          "relationship",
          "love",
          "money",
        ];
        const selected = {};
        categories.forEach((cat) => {
          const questions = GUIDE_QUESTIONS[cat];
          selected[cat] =
            questions[Math.floor(Math.random() * questions.length)];
        });

        saveToLocal("life_guide_questions", selected);
        return selected;
      }

      function renderLifeGuide() {
        const categories = [
          "life",
          "time",
          "travel",
          "relationship",
          "love",
          "money",
        ];
        const selectedQuestions = buildLifeQuestions();
        const guideEl = document.getElementById("lifeGuide");
        guideEl.innerHTML = categories
          .map(
            (cat) => `
          <div class="life-card" data-category="${cat}">${cat}</div>
        `,
          )
          .join("");

        guideEl.querySelectorAll(".life-card").forEach((card) => {
          card.onclick = () => {
            const category = card.dataset.category;
            openLifeModal(category, selectedQuestions[category]);
          };
        });
      }

      window.openLifeModal = function (category, questionText) {
        document.getElementById("lifeModalCategory").textContent = category;
        document.getElementById("lifeModalQuestion").textContent = questionText;
        document.getElementById("lifeModal").classList.add("active");
      };

      window.closeLifeModal = function () {
        document.getElementById("lifeModal").classList.remove("active");
      };

      document.getElementById("lifeModal").onclick = (e) => {
        if (e.target.id === "lifeModal") {
          closeLifeModal();
        }
      };

      /* ================= ÌÜµÌôî ÏãúÏûë ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ================= */
      async function syncCallStartTime() {
        const snap = await get(ref(rtdb, `match_requests/${requestId}`));
        const data = snap.val();
        
        if (!data) {
          alert("request not found");
          navigateTo("lounge.html");
          return;
        }

        if (data && data.call_started_at) {
          callStart = data.call_started_at;
          console.log(`‚úÖ ÌÜµÌôî ÏãúÏûë ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî: ${new Date(callStart).toLocaleTimeString()}`);
        } else {
          // Fallback: call_started_atÏù¥ ÏóÜÏúºÎ©¥ ÌòÑÏû¨ ÏãúÍ∞Ñ ÏÇ¨Ïö©
          callStart = Date.now();
          console.log("‚ö†Ô∏è call_started_at ÏóÜÏùå, ÌòÑÏû¨ ÏãúÍ∞Ñ ÏÇ¨Ïö©");
        }
      }

      /* ================= Timer ================= */

      function startTimer() {
        timer = setInterval(() => {
          const now = Date.now();
          const elapsed = Math.floor((now - callStart) / 1000);
          const m = String(Math.floor(elapsed / 60)).padStart(2, "0");
          const s = String(elapsed % 60).padStart(2, "0");
          voiceTimer.textContent = `${m}:${s}`;
        }, 1000);
      }

      /* ================= Agora ================= */

      function getNumericUid(userId) {
        let hash = 0;
        for (let i = 0; i < userId.length; i++) {
          hash = (hash << 5) - hash + userId.charCodeAt(i);
          hash = hash & hash;
        }
        return Math.abs(hash) % 2000000000;
      }

      async function initCall() {
        agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
        const numericUid = getNumericUid(userId);
        console.log(`üî¢ UID Î≥ÄÌôò: ${userId} ‚Üí ${numericUid}`);

        await agoraClient.join(AGORA_APP_ID, requestId, null, numericUid);
        console.log("‚úÖ Agora Ï±ÑÎÑê ÏûÖÏû• ÏôÑÎ£å");

        // üî• UID Îß§Ìïë Ï†ÄÏû• (ÌôîÏûê Î∂ÑÎ¶¨ ÌõÑ ÏãùÎ≥ÑÏö©)
        const requestRef = ref(rtdb, `match_requests/${requestId}`);
        await update(requestRef, {
          [`uid_mapping/${numericUid}`]: userId,
        });
        console.log(`‚úÖ UID Îß§Ìïë Ï†ÄÏû•: ${numericUid} ‚Üí ${userId}`);

        localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
        await agoraClient.publish([localAudioTrack]);
        console.log("‚úÖ Ïò§ÎîîÏò§ ÌçºÎ∏îÎ¶¨Ïãú ÏôÑÎ£å");

        agoraClient.on("user-published", async (user, mediaType) => {
          await agoraClient.subscribe(user, mediaType);
          if (mediaType === "audio") {
            user.audioTrack.play();
            console.log("‚úÖ ÏÉÅÎåÄÎ∞© Ïò§ÎîîÏò§ Ïû¨ÏÉù Ï§ë");
          }
        });
      }

      /* ================= Controls ================= */

      window.toggleMute = () => {
        if (!localAudioTrack) return;
        isMuted = !isMuted;
        localAudioTrack.setEnabled(!isMuted);
        muteBtn.classList.toggle("active", isMuted);
        console.log(`üé§ ÏùåÏÜåÍ±∞: ${isMuted}`);
      };

      window.endCall = async () => {
        console.log("=".repeat(50));
        console.log(">>> endCall Ìò∏Ï∂úÎê®");
        console.log("=".repeat(50));

        if (timer) clearInterval(timer);

        // üî• ÏÑúÎ≤ÑÏóê ÎÖπÌôî Ï¢ÖÎ£å ÏöîÏ≤≠
        try {
          console.log("üì§ ÏÑúÎ≤ÑÏóê ÎÖπÌôî Ï¢ÖÎ£å ÏöîÏ≤≠...");

          const response = await fetch("/api/agora/auto-stop-recording", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ request_id: requestId }),
          });

          const result = await response.json();
          console.log("üì• ÎÖπÌôî Ï¢ÖÎ£å ÏùëÎãµ:", result);

          if (result.success) {
            console.log("‚úÖ ÎÖπÌôî Ï¢ÖÎ£å ÏôÑÎ£å");
            console.log(`   Ï¥ù ${result.totalFiles}Í∞ú ÌååÏùº ÏÉùÏÑ±Îê®`);
          } else {
            console.log("‚ö†Ô∏è ÎÖπÌôî Ï¢ÖÎ£å Ïã§Ìå® ÎòêÎäî ÎÖπÌôî ÏóÜÏùå:", result.message);
          }
        } catch (e) {
          console.error("‚ùå ÎÖπÌôî Ï¢ÖÎ£å ÏöîÏ≤≠ Ïã§Ìå®:", e);
        }

        console.log("üìù Firebase ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...");

        await update(ref(rtdb, `match_requests/${requestId}`), {
          call_ended: true,
          ended_by: userId,
          ended_at: Date.now(),
        });

        console.log("‚úÖ Firebase ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å");

        localAudioTrack?.close();
        if (agoraClient) await agoraClient.leave();

        console.log("üöÄ talk-end.htmlÎ°ú Ïù¥Îèô");
        console.log("=".repeat(50));

        navigateTo("talk-end.html");
      };

      /* ================= Î¶¨Ïä§ÎÑà & Ï¥àÍ∏∞Ìôî ================= */

      onValue(ref(rtdb, `match_requests/${requestId}`), async (snap) => {
        const d = snap.val();
        if (!d) {
          alert("the other person cancelled or the request timed out");
          navigateTo("lounge.html");
          return;
        }
        if (d?.call_ended && d.ended_by !== userId) {
          console.log("‚ö†Ô∏è ÏÉÅÎåÄÎ∞©Ïóê ÏùòÌï¥ ÌÜµÌôî Ï¢ÖÎ£åÎê®");
          await window.endCall();
        }
      });

      window.onload = async () => {
        console.log("üé¨ ÌéòÏù¥ÏßÄ Î°úÎìú ÏãúÏûë");
        console.log("   userId:", userId);
        console.log("   requestId:", requestId);
        console.log("   topic:", topic);

        if (!isLifeRound) {
          await loadImages();
          console.log("‚úÖ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏôÑÎ£å");
        }

        await syncCallStartTime();
        console.log("‚úÖ ÌÜµÌôî ÏãúÏûë ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ÏôÑÎ£å");

        startTimer();
        console.log("‚úÖ ÌÉÄÏù¥Î®∏ ÏãúÏûë");

        await initCall();
        console.log("‚úÖ ÌÜµÌôî Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
      };
    </script>
  </body>
</html>
