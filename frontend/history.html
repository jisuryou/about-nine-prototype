<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>History</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>
    <style>
      .history-user-name {
        font-size: 22px;
        font-weight: 600;
        padding: 4px;
      }

      .history-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .history-card {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .history-card.offline {
        opacity: 0.6;
      }

      .history-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }

      .history-name-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .history-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 6px;
        color: var(--text-secondary);
        font-size: 12px;
        flex-wrap: wrap;
      }

      .history-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .detail-btn {
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-size: 18px;
        padding: 0;
      }

      .history-btn {
        width: 100%;
        padding: 8px 20px;
        font-size: 14px;
        margin-top: 6px;
      }

      .empty-state {
        text-align: center;
        color: var(--text-secondary);
        margin-top: 60px;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div
        class="chat-header brand-text"
        style="text-align: left; color: #8e8e8e"
      >
        about nine
      </div>
      <div class="history-user-name" id="historyUserName"></div>

      <div class="content">
        <div id="historyList" class="card-list history-list"></div>
        <div id="emptyState" class="empty-state hidden">
          no conversations yet
        </div>
      </div>
    </div>

    <nav id="bottomNav" class="bottom-nav"></nav>

    <script src="js/common.js"></script>

    <script type="module">
      import { rtdb, ref, onValue, push, set } from "/js/firebase.js";
      const userId = getFromLocal("user_id");
      if (!userId) {
        navigateTo("index.html");
      }

      let presenceData = {};
      let currentUserProfile = null;

      function roundLabel(topic) {
        if (topic === "life") return "value";
        return topic || "";
      }

      function isOnline(uid) {
        const presence = presenceData[uid];
        return presence && presence.online === true;
      }

      async function loadUserProfile() {
        const profileRes = await apiCall("/users/profile");
        currentUserProfile = profileRes?.user || null;
      }

      async function renderHistory() {
        const listEl = document.getElementById("historyList");
        const emptyEl = document.getElementById("emptyState");
        const nameEl = document.getElementById("historyUserName");

        const myFirst =
          currentUserProfile?.first_name ||
          currentUserProfile?.firstName ||
          getFromLocal("firstName") ||
          "";
        const myLast =
          currentUserProfile?.last_name ||
          currentUserProfile?.lastName ||
          getFromLocal("lastName") ||
          "";
        const myName = `${myFirst} ${myLast}`.trim();
        nameEl.textContent = myName || "your profile";

        const res = await apiCall("/talks/history-list");
        const items = res.items || [];
        if (!items.length) {
          listEl.innerHTML = "";
          emptyEl.classList.remove("hidden");
          return;
        }
        const cards = items.map((item) => {
          const id = item.partner_id;
          const first = item.first_name || "";
          const last = item.last_name || "";
          const name = `${first} ${last}`.trim() || "your match";

          const scores = [];
          [1, 2, 3].forEach((r) => {
            const t = item.talks_by_round?.[r];
            if (!t) return;
            const label = roundLabel(t.topic);
            const s = t.score === null ? "--" : t.score;
            scores.push(`${label}: ${s}`);
          });

          const startAllowed = !item.had_no;
          const isBlocked = item.blocked === true;
          const online = isOnline(id);
          const startEnabled = startAllowed && online && !isBlocked;

          const scoreHtml = scores.length
            ? scores.map((s) => `<span>${s}</span>`).join("")
            : "<span>no scores yet</span>";

          return `
            <div class="history-card ${online ? "" : "offline"}">
              <div class="card">
                <div style="flex:1;">
                  <div class="history-card-header">
                    <div class="history-name-row">
                      <span style="font-size:16px;font-weight:600;">${name}</span>
                      <span class="status-dot ${
                        isBlocked ? "blocked" : online ? "online" : "offline"
                      }"></span>
                    </div>
                    <div class="history-actions">
                      <button class="detail-btn" onclick="openDetail('${id}')">â€º</button>
                    </div>
                  </div>
                  <div class="history-meta">${scoreHtml}</div>
                  <button class="primary history-btn" ${
                    startEnabled ? "" : "disabled"
                  } onclick="startTalk('${id}')">start talk</button>
                </div>
              </div>
            </div>
          `;
        });

        listEl.innerHTML = cards.join("");
        emptyEl.classList.toggle("hidden", cards.length > 0);
      }

      window.openDetail = (partnerId) => {
        navigateTo(`history-detail.html?partnerId=${partnerId}`);
      };

      window.startTalk = async (partnerId) => {
        const partnerRes = await apiCall(`/talks/history-detail/${partnerId}`);
        if (!partnerRes.success || !partnerRes.partner) return;

        const partner = { id: partnerId, ...partnerRes.partner };
        saveToLocal("chat_partner", partner);

        try {
          showLoading("preparing...");
          const roundRes = await apiCall("/talks/calculate-round", "POST", {
            partner_id: partnerId,
          });
          hideLoading();

          if (!roundRes.success) {
            alert("failed to calculate round");
            return;
          }

          const round = roundRes.round;
          const topic = roundRes.topic;
          const question = roundRes.question;
          const options = roundRes.options;

          const requestsRef = ref(rtdb, "match_requests");
          const newRequestRef = push(requestsRef);
          const requestId = newRequestRef.key;
          saveToLocal("match_request_id", requestId);

          const initiatorProfile = currentUserProfile || {
            id: userId,
            first_name: getFromLocal("firstName"),
            last_name: getFromLocal("lastName"),
            age: getFromLocal("age"),
            gender: getFromLocal("gender"),
          };

          const matchData = {
            initiator: userId,
            receiver: partnerId,
            status: "waiting",
            round,
            topic,
            timestamp: Date.now(),
            initiator_profile: initiatorProfile,
          };

          if (question) matchData.question = question;
          if (options) matchData.options = options;

          await set(newRequestRef, matchData);
          navigateTo(`waiting.html?mode=initiator&requestId=${requestId}`);
        } catch (error) {
          hideLoading();
          console.error("Failed to start match request:", error);
          alert("failed to start match request");
        }
      };

      function listenPresence() {
        onValue(ref(rtdb, "presence"), (snap) => {
          presenceData = snap.val() || {};
          renderHistory();
        });
      }

      window.onload = async () => {
        renderBottomNav("history");
        try {
          await loadUserProfile();
          await renderHistory();
          listenPresence();
        } catch (error) {
          console.error("Failed to load history:", error);
        }
      };
    </script>
  </body>
</html>
