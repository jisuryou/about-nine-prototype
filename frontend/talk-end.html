<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Call Ended</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>

    <style>
      .end-container {
        width: 100%;
        max-width: 480px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        padding: calc(256px + var(--safe-top)) 20px
          calc(30px + var(--safe-bottom));
        font-family: "Merriweather", serif;
        text-align: center;
      }

      .end-title {
        font-size: 24px;
        font-weight: 300;
        margin-bottom: 20px;
        color: var(--text-primary);
        font-family: "Merriweather", serif;
      }

      .end-duration {
        font-size: 18px;
        color: var(--text-secondary);
        margin-bottom: 60px;
      }

      .analysis-progress {
        width: 100%;
        max-width: 320px;
        margin: -40px auto 40px;
        text-align: center;
        color: var(--text-secondary);
        font-size: 12px;
      }

      .analysis-bar {
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: #2a2a2a;
        overflow: hidden;
        margin-top: 8px;
      }

      .analysis-bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #ff6ec4, #7873f5);
        transition: width 0.4s ease;
      }

      @supports (height: 100svh) {
        .end-container {
          min-height: 100svh;
        }
      }

      @media (max-width: 420px) {
        .end-container {
          padding: calc(180px + var(--safe-top)) 16px
            calc(24px + var(--safe-bottom));
        }

        .end-title {
          font-size: 22px;
        }

        .end-duration {
          font-size: 16px;
          margin-bottom: 40px;
        }

        .analysis-progress {
          margin: -20px auto 30px;
        }
      }

      @media (max-width: 360px) {
        .end-container {
          padding: calc(150px + var(--safe-top)) 14px
            calc(20px + var(--safe-bottom));
        }

        .end-title {
          font-size: 20px;
        }
      }

      @media (max-height: 700px) {
        .end-container {
          padding: calc(140px + var(--safe-top)) 16px
            calc(20px + var(--safe-bottom));
        }

        .end-duration {
          margin-bottom: 30px;
        }
      }
    </style>
  </head>

  <body>
    <div class="end-container">
      <div>
        <h1 class="end-title">the call has ended</h1>
        <div class="end-duration" id="callDuration">call duration --:--</div>
        <div class="analysis-progress hidden" id="analysisProgress">
          <div id="analysisText">analyzing... 0%</div>
          <div class="analysis-bar">
            <div class="analysis-bar-fill" id="analysisBarFill"></div>
          </div>
        </div>
      </div>
      <button id="nextBtn" class="primary" onclick="handleNext()" disabled>
        next
      </button>
    </div>

    <script src="js/common.js"></script>

    <script type="module">
      import { rtdb, ref, get, remove } from "/js/firebase.js";

      const userId = getFromLocal("user_id");
      const partner = getFromLocal("chat_partner");
      const requestId = getFromLocal("match_request_id");

      let matchData = null;
      let progressTimer = null;
      let progressValue = 0;
      let progressStartAt = null;
      const ANALYSIS_EXPECTED_MS = 45000;
      const ANALYSIS_MAX_PROGRESS = 95;
      let talkId = null;

      /* ================= ì´ˆê¸°í™” ================= */

      window.onload = async () => {
        if (!userId || !partner || !requestId) {
          console.error("âŒ í•„ìˆ˜ ë°ì´í„° ì—†ìŒ");
          alert("invalid request");
          navigateTo("lounge.html");
          return;
        }

        try {
          // RTDBì—ì„œ match_request ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          const snap = await get(ref(rtdb, `match_requests/${requestId}`));
          matchData = snap.val();

          if (!matchData) {
            console.error("âŒ match_request ë°ì´í„° ì—†ìŒ");
            alert("request not found");
            navigateTo("lounge.html");
            return;
          }

          console.log("âœ… match_request ë°ì´í„° ë¡œë“œ:", matchData);

          // í†µí™” ì‹œê°„ í‘œì‹œ
          displayDuration();

          await processAnalysis();

          // NOTE: keep match_request for other participant (cleanup after go/no)
        } catch (e) {
          console.error("âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
          alert("failed to load request");
          navigateTo("lounge.html");
        }
      };

      /* ================= í†µí™” ì‹œê°„ í‘œì‹œ ================= */

      function displayDuration() {
        const callStarted = matchData.call_started_at;
        const callEnded = matchData.ended_at;

        if (!callStarted || !callEnded) {
          callDuration.textContent = "call duration --:--";
          return;
        }

        const durationMs = callEnded - callStarted;
        const durationSec = Math.floor(durationMs / 1000);
        const m = Math.floor(durationSec / 60);
        const s = durationSec % 60;

        callDuration.textContent = `call duration ${m}:${String(s).padStart(
          2,
          "0",
        )}`;
      }

      /* ================= Next ë²„íŠ¼ ================= */

      window.handleNext = async () => {
        navigateTo("talk-result.html");
      };

      /* ================= ðŸ”¥ Firestore ì €ìž¥ (top-level collection) ================= */

      async function saveTalkHistory() {
        const res = await apiCall("/talks/save-history", "POST", {
          request_id: requestId,
        });
        if (!res.success) {
          throw new Error(res.message || "failed to save talk history");
        }
        talkId = res.talk_id;
        saveToLocal("current_talk_id", talkId);
      }

      /* ================= ë¶„ì„ ìš”ì²­ ================= */

      async function analyzeTalk() {
        const response = await fetch("/api/match/analyze-talk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            talk_id: talkId,
          }),
        });
        const raw = await response.text();
        let result = null;
        try {
          result = raw ? JSON.parse(raw) : null;
        } catch (error) {
          throw new Error(raw || "analysis failed");
        }
        if (!response.ok) {
          throw new Error(result?.message || "analysis failed");
        }
        return result;
      }

      function startProgress(startedAt = null) {
        const el = document.getElementById("analysisProgress");
        const textEl = document.getElementById("analysisText");
        const barEl = document.getElementById("analysisBarFill");

        el.classList.remove("hidden");
        progressValue = 0;
        progressStartAt = startedAt || Date.now();
        textEl.textContent = "analyzing... 0%";
        barEl.style.width = "0%";

        progressTimer = setInterval(() => {
          const elapsed = Date.now() - progressStartAt;
          const ratio = elapsed / ANALYSIS_EXPECTED_MS;
          progressValue = Math.min(
            ANALYSIS_MAX_PROGRESS,
            Math.max(2, Math.floor(ratio * 100))
          );
          textEl.textContent = `analyzing... ${progressValue}%`;
          barEl.style.width = `${progressValue}%`;
        }, 600);
      }

      function stopProgress(success = true) {
        const el = document.getElementById("analysisProgress");
        const textEl = document.getElementById("analysisText");
        const barEl = document.getElementById("analysisBarFill");

        if (progressTimer) clearInterval(progressTimer);
        progressTimer = null;

        if (success) {
          progressValue = 100;
          textEl.textContent = "analysis complete 100%";
          barEl.style.width = "100%";
          setTimeout(() => {
            el.classList.add("hidden");
          }, 600);
        } else {
          textEl.textContent = "analysis failed. please try again.";
          barEl.style.width = `${progressValue}%`;
        }
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function fetchTalk() {
        const res = await apiCall(`/talks/history/${talkId}`);
        if (!res.success || !res.talk) {
          throw new Error("talk_history not found");
        }
        return res.talk;
      }

      function isAnalysisComplete(talk) {
        const score = talk?.analysis?.chemistry_score;
        return typeof score === "number" && !Number.isNaN(score);
      }

      function getAnalysisStart(talk) {
        return (
          talk?.analysis_started_at ||
          talk?.analysis?.analyzed_at ||
          null
        );
      }

      async function waitForAnalysis(maxMs = 120000, intervalMs = 2000) {
        const start = Date.now();
        while (Date.now() - start < maxMs) {
          await sleep(intervalMs);
          const talk = await fetchTalk();

          if (talk?.analysis_status === "failed") {
            throw new Error("analysis failed");
          }

          const startedAt = getAnalysisStart(talk);
          if (startedAt && progressStartAt !== startedAt) {
            progressStartAt = startedAt;
          }

          if (isAnalysisComplete(talk)) {
            return true;
          }
        }
        return false;
      }

      async function processAnalysis() {
        const nextBtn = document.getElementById("nextBtn");
        nextBtn.disabled = true;
        startProgress();

        try {
          if (!talkId) {
            await saveTalkHistory();
            console.log("âœ… talk_history ì €ìž¥ ì™„ë£Œ");
          }

          const talk = await fetchTalk();
          if (isAnalysisComplete(talk)) {
            stopProgress(true);
            nextBtn.disabled = false;
            return;
          }

          const startedAt = getAnalysisStart(talk);
          if (startedAt) {
            progressStartAt = startedAt;
          }

          await analyzeTalk();

          const ok = await waitForAnalysis();
          if (!ok) {
            throw new Error("analysis timeout");
          }

          console.log("âœ… ë¶„ì„ ì™„ë£Œ");
          stopProgress(true);
          nextBtn.disabled = false;
        } catch (e) {
          console.error("âŒ ë¶„ì„ ì²˜ë¦¬ ì‹¤íŒ¨:", e);
          stopProgress(false);
          nextBtn.disabled = false;
        }
      }
    </script>
  </body>
</html>
