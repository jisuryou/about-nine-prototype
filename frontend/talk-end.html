<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Call Ended</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>

    <style>
      /* ÏµúÏÜåÌïúÏùò Ï∂îÍ∞Ä Ïä§ÌÉÄÏùºÎßå */
      .end-container {
        width: 100%;
        max-width: 480px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        padding: 256px 20px 30px;
        font-family: "Merriweather", serif;
        text-align: center;
      }

      .end-title {
        font-size: 24px;
        font-weight: 300;
        margin-bottom: 20px;
        color: var(--text-primary);
        font-family: "Merriweather", serif;
      }

      .end-duration {
        font-size: 18px;
        color: var(--text-secondary);
        margin-bottom: 60px;
      }

      .analysis-progress {
        width: 100%;
        max-width: 320px;
        margin: -40px auto 40px;
        text-align: center;
        color: var(--text-secondary);
        font-size: 12px;
      }

      .analysis-bar {
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: #2a2a2a;
        overflow: hidden;
        margin-top: 8px;
      }

      .analysis-bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #ff6ec4, #7873f5);
        transition: width 0.4s ease;
      }
    </style>
  </head>

  <body>
    <div class="end-container">
      <div>
        <h1 class="end-title">the call has ended</h1>
        <div class="end-duration" id="callDuration">call duration --:--</div>
        <div class="analysis-progress hidden" id="analysisProgress">
          <div id="analysisText">analyzing... 0%</div>
          <div class="analysis-bar">
            <div class="analysis-bar-fill" id="analysisBarFill"></div>
          </div>
        </div>
      </div>
      <button id="nextBtn" class="primary" onclick="handleNext()" disabled>
        next
      </button>
      <button id="retryBtn" class="secondary hidden" onclick="retryAnalysis()">
        retry analysis
      </button>
    </div>

    <script src="js/common.js"></script>

    <script type="module">
      import { rtdb, db, ref, get, remove } from "/js/firebase.js";
      import {
        collection,
        doc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const userId = getFromLocal("user_id");
      const partner = getFromLocal("chat_partner");
      const requestId = getFromLocal("match_request_id");

      let matchData = null;
      let progressTimer = null;
      let progressValue = 0;
      let talkId = null;

      /* ================= Ï¥àÍ∏∞Ìôî ================= */

      window.onload = async () => {
        if (!userId || !partner || !requestId) {
          console.error("‚ùå ÌïÑÏàò Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå");
          alert("invalid request");
          navigateTo("lounge.html");
          return;
        }

        try {
          // RTDBÏóêÏÑú match_request Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
          const snap = await get(ref(rtdb, `match_requests/${requestId}`));
          matchData = snap.val();

          if (!matchData) {
            console.error("‚ùå match_request Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå");
            alert("request not found");
            navigateTo("lounge.html");
            return;
          }

          console.log("‚úÖ match_request Îç∞Ïù¥ÌÑ∞ Î°úÎìú:", matchData);

          // ÌÜµÌôî ÏãúÍ∞Ñ ÌëúÏãú
          displayDuration();

          await processAnalysis();

          if (talkId) {
            try {
              await remove(ref(rtdb, `match_requests/${requestId}`));
              console.log("‚úÖ match_request ÏÇ≠Ï†ú ÏôÑÎ£å");
            } catch (cleanupError) {
              console.error("‚ùå match_request ÏÇ≠Ï†ú Ïã§Ìå®:", cleanupError);
            }
          }
        } catch (e) {
          console.error("‚ùå Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", e);
          alert("failed to load request");
          navigateTo("lounge.html");
        }
      };

      /* ================= ÌÜµÌôî ÏãúÍ∞Ñ ÌëúÏãú ================= */

      function displayDuration() {
        const callStarted = matchData.call_started_at;
        const callEnded = matchData.ended_at;

        if (!callStarted || !callEnded) {
          callDuration.textContent = "call duration --:--";
          return;
        }

        const durationMs = callEnded - callStarted;
        const durationSec = Math.floor(durationMs / 1000);
        const m = Math.floor(durationSec / 60);
        const s = durationSec % 60;

        callDuration.textContent = `call duration ${m}:${String(s).padStart(
          2,
          "0",
        )}`;
      }

      /* ================= Next Î≤ÑÌäº ================= */

      window.handleNext = async () => {
        navigateTo("talk-result.html");
      };

      /* ================= üî• Firestore Ï†ÄÏû• (top-level collection) ================= */

      async function saveTalkHistory() {
        const isInitiator = matchData.initiator === userId;
        const partnerId = partner.id;

        const userSelection = isInitiator
          ? matchData.initiator_selection
          : matchData.receiver_selection;
        const partnerSelection = isInitiator
          ? matchData.receiver_selection
          : matchData.initiator_selection;

        // ÌÜµÌôî ÏãúÍ∞Ñ Í≥ÑÏÇ∞
        const duration =
          matchData.call_started_at && matchData.ended_at
            ? Math.floor(
                (matchData.ended_at - matchData.call_started_at) / 1000,
              )
            : 0;

        // üî• top-level talk_history Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞
        const talkData = {
          // Ï∞∏Í∞ÄÏûê (ÏñëÏ™Ω ID Ï†ÄÏû•)
          participants: {
            user_a: userId,
            user_b: partnerId,
          },

          // Round & Topic
          round: matchData.round || 1,
          topic: matchData.topic || "food",
          question:
            matchData.question ||
            (matchData.topic === "life"
              ? "choose a topic and discuss it freely"
              : ""),
          options: matchData.options || [],

          // ÏÑ†ÌÉù (Í∞ÅÏûê IDÎ•º ÌÇ§Î°ú ÏÇ¨Ïö©)
          selections: {
            [userId]: userSelection,
            [partnerId]: partnerSelection,
          },

          // ÏùëÎãµ (go/no)
          initiator_response: null,
          receiver_response: null,

          // ÌÜµÌôî Ï†ïÎ≥¥
          completed: true,
          timestamp: matchData.ended_at || Date.now(),
          duration: duration,
          call_started_at: matchData.call_started_at || null,
          call_ended_at: matchData.ended_at || null,

          // ÎÖπÌôî ÌååÏùº
          recording_files: matchData.recording_file_list || [],
          recording_uploading_status:
            matchData.recording_uploading_status || null,
          uid_mapping: matchData.uid_mapping || {},

          // Î∂ÑÏÑù Í≤∞Í≥º (ÎÇòÏ§ëÏóê ÏóÖÎç∞Ïù¥Ìä∏)
          analysis: null,

          // ÏÉùÏÑ± ÏãúÍ∞Ñ
          created_at: Date.now(),
        };

        // üî• talk_history (top-level collection)Ïóê Ï†ÄÏû•
        const talkRef = doc(collection(db, "talk_history"));
        await setDoc(talkRef, talkData);
        talkId = talkRef.id;

        console.log("‚úÖ talk_history Ï†ÄÏû• (top-level):", talkId);
        console.log("   participants:", talkData.participants);
        console.log("   selections:", talkData.selections);

        // localStorageÏóê talk_id Ï†ÄÏû• (Í≤∞Í≥º ÌéòÏù¥ÏßÄÏóêÏÑú ÏÇ¨Ïö©)
        saveToLocal("current_talk_id", talkId);
      }

      /* ================= Î∂ÑÏÑù ÏöîÏ≤≠ ================= */

      async function analyzeTalk() {
        const response = await fetch("/api/match/analyze-talk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            talk_id: talkId,
          }),
        });
        return await response.json();
      }

      function startProgress() {
        const el = document.getElementById("analysisProgress");
        const textEl = document.getElementById("analysisText");
        const barEl = document.getElementById("analysisBarFill");

        el.classList.remove("hidden");
        progressValue = 0;
        textEl.textContent = "analyzing... 0%";
        barEl.style.width = "0%";

        progressTimer = setInterval(() => {
          const increment = progressValue < 70 ? 4 : 1;
          progressValue = Math.min(95, progressValue + increment);
          textEl.textContent = `analyzing... ${progressValue}%`;
          barEl.style.width = `${progressValue}%`;
        }, 600);
      }

      function stopProgress(success = true) {
        const el = document.getElementById("analysisProgress");
        const textEl = document.getElementById("analysisText");
        const barEl = document.getElementById("analysisBarFill");
        const retryBtn = document.getElementById("retryBtn");

        if (progressTimer) clearInterval(progressTimer);
        progressTimer = null;

        if (success) {
          progressValue = 100;
          textEl.textContent = "analysis complete 100%";
          barEl.style.width = "100%";
          retryBtn.classList.add("hidden");
          setTimeout(() => {
            el.classList.add("hidden");
          }, 600);
        } else {
          textEl.textContent = "analysis failed. please try again.";
          barEl.style.width = `${progressValue}%`;
          retryBtn.classList.remove("hidden");
        }
      }

      async function processAnalysis() {
        const nextBtn = document.getElementById("nextBtn");
        const retryBtn = document.getElementById("retryBtn");
        nextBtn.disabled = true;
        retryBtn.classList.add("hidden");
        startProgress();

        try {
          if (!talkId) {
            await saveTalkHistory();
            console.log("‚úÖ talk_history Ï†ÄÏû• ÏôÑÎ£å");
          }

          const result = await analyzeTalk();
          if (!result?.success) {
            throw new Error(result?.message || "analysis failed");
          }
          console.log("‚úÖ Î∂ÑÏÑù ÏôÑÎ£å");

          stopProgress(true);
          nextBtn.disabled = false;
        } catch (e) {
          console.error("‚ùå Î∂ÑÏÑù Ï≤òÎ¶¨ Ïã§Ìå®:", e);
          stopProgress(false);
          nextBtn.disabled = true;
        }
      }

      window.retryAnalysis = async () => {
        await processAnalysis();
      };
    </script>
  </body>
</html>
