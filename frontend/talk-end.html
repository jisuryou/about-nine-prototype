<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Call Ended</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>

    <style>
      /* ìµœì†Œí•œì˜ ì¶”ê°€ ìŠ¤íƒ€ì¼ë§Œ */
      .end-container {
        width: 100%;
        max-width: 480px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        padding: 256px 20px 30px;
        font-family: "Merriweather", serif;
        text-align: center;
      }

      .end-title {
        font-size: 24px;
        font-weight: 300;
        margin-bottom: 20px;
        color: var(--text-primary);
        font-family: "Merriweather", serif;
      }

      .end-duration {
        font-size: 18px;
        color: var(--text-secondary);
        margin-bottom: 60px;
      }
    </style>
  </head>

  <body>
    <div class="end-container">
      <div>
        <h1 class="end-title">the call has ended</h1>
        <div class="end-duration" id="callDuration">call duration --:--</div>
      </div>
      <button id="nextBtn" class="primary" onclick="handleNext()">next</button>
    </div>

    <script src="js/common.js"></script>

    <script type="module">
      import { rtdb, db, ref, get, remove } from "/js/firebase.js";
      import {
        collection,
        doc,
        setDoc,
        updateDoc,
        arrayUnion,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const userId = getFromLocal("user_id");
      const partner = getFromLocal("chat_partner");
      const requestId = getFromLocal("match_request_id");

      let matchData = null;

      /* ================= ì´ˆê¸°í™” ================= */

      window.onload = async () => {
        if (!userId || !partner || !requestId) {
          console.error("âŒ í•„ìˆ˜ ë°ì´í„° ì—†ìŒ");
          navigateTo("lounge.html");
          return;
        }

        try {
          // RTDBì—ì„œ match_request ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          const snap = await get(ref(rtdb, `match_requests/${requestId}`));
          matchData = snap.val();

          if (!matchData) {
            console.error("âŒ match_request ë°ì´í„° ì—†ìŒ");
            navigateTo("lounge.html");
            return;
          }

          console.log("âœ… match_request ë°ì´í„° ë¡œë“œ:", matchData);

          // í†µí™” ì‹œê°„ í‘œì‹œ
          displayDuration();
        } catch (e) {
          console.error("âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
          navigateTo("lounge.html");
        }
      };

      /* ================= í†µí™” ì‹œê°„ í‘œì‹œ ================= */

      function displayDuration() {
        const callStarted = matchData.call_started_at;
        const callEnded = matchData.ended_at;

        if (!callStarted || !callEnded) {
          callDuration.textContent = "call duration --:--";
          return;
        }

        const durationMs = callEnded - callStarted;
        const durationSec = Math.floor(durationMs / 1000);
        const m = Math.floor(durationSec / 60);
        const s = durationSec % 60;

        callDuration.textContent = `call duration ${m}:${String(s).padStart(
          2,
          "0",
        )}`;
      }

      /* ================= Next ë²„íŠ¼ ================= */

      window.handleNext = async () => {
        const nextBtn = document.getElementById("nextBtn");

        nextBtn.disabled = true;
        showLoading("analyzing your conversation...");

        try {
          // 1. Firestore talk_history ì €ì¥ (ğŸ”¥ top-level collection)
          await saveTalkHistory();
          console.log("âœ… talk_history ì €ì¥ ì™„ë£Œ");

          // 2. ë¶„ì„ ìš”ì²­ (Backend)
          await analyzeTalk();
          console.log("âœ… ë¶„ì„ ì™„ë£Œ");

          // 3. RTDB match_request ì‚­ì œ
          await remove(ref(rtdb, `match_requests/${requestId}`));
          console.log("âœ… match_request ì‚­ì œ ì™„ë£Œ");

          // 4. ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
          navigateTo("talk-result.html");
        } catch (e) {
          console.error("âŒ Next ì²˜ë¦¬ ì‹¤íŒ¨:", e);
          alert("An error occurred. Please try again.");
          nextBtn.disabled = false;
          hideLoading();
        }
      };

      /* ================= ğŸ”¥ Firestore ì €ì¥ (top-level collection) ================= */

      async function saveTalkHistory() {
        const isInitiator = matchData.initiator === userId;
        const partnerId = partner.id;

        const userSelection = isInitiator
          ? matchData.initiator_selection
          : matchData.receiver_selection;
        const partnerSelection = isInitiator
          ? matchData.receiver_selection
          : matchData.initiator_selection;

        // í†µí™” ì‹œê°„ ê³„ì‚°
        const duration =
          matchData.call_started_at && matchData.ended_at
            ? Math.floor(
                (matchData.ended_at - matchData.call_started_at) / 1000,
              )
            : 0;

        // ğŸ”¥ top-level talk_history ë°ì´í„° êµ¬ì¡°
        const talkData = {
          // ì°¸ê°€ì (ì–‘ìª½ ID ì €ì¥)
          participants: {
            user_a: userId,
            user_b: partnerId,
          },

          // Round & Topic
          round: matchData.round || 1,
          topic: matchData.topic || "food",
          question: matchData.question || "",

          // ì„ íƒ (ê°ì IDë¥¼ í‚¤ë¡œ ì‚¬ìš©)
          selections: {
            [userId]: userSelection,
            [partnerId]: partnerSelection,
          },

          // í†µí™” ì •ë³´
          completed: true,
          timestamp: matchData.ended_at || Date.now(),
          duration: duration,

          // ë…¹í™” íŒŒì¼
          recording_files: matchData.recording_file_list || [],

          // ë¶„ì„ ê²°ê³¼ (ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸)
          analysis: null,

          // ìƒì„± ì‹œê°„
          created_at: Date.now(),
        };

        // ğŸ”¥ talk_history (top-level collection)ì— ì €ì¥
        const talkRef = doc(collection(db, "talk_history"));
        await setDoc(talkRef, talkData);
        const talkId = talkRef.id;

        console.log("âœ… talk_history ì €ì¥ (top-level):", talkId);
        console.log("   participants:", talkData.participants);
        console.log("   selections:", talkData.selections);

        // localStorageì— talk_id ì €ì¥ (ê²°ê³¼ í˜ì´ì§€ì—ì„œ ì‚¬ìš©)
        saveToLocal("current_talk_id", talkId);
      }

      /* ================= ë¶„ì„ ìš”ì²­ ================= */

      async function analyzeTalk() {
        await fetch("/api/match/analyze-talk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            talk_id: getFromLocal("current_talk_id")
          })
        });

      }
    </script>
  </body>
</html>