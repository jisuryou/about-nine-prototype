<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Onboarding</title>

    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>
  </head>

  <body>
    <div class="chat-container">
      <div class="chat-header brand-text">COCO</div>
      <div id="chat" class="chat-messages"></div>

      <div class="chat-input-area">
        <div class="chat-input-wrap">
          <select id="select" class="chat-select" disabled></select>

          <div id="ageBox" class="age-range-box">
            <span id="minText" class="age-value">20</span>
            <div class="age-slider-container">
              <div class="age-slider-track">
                <div id="rangeFill" class="age-slider-fill"></div>
                <input id="minAge" type="range" min="20" max="60" value="20" />
                <input id="maxAge" type="range" min="20" max="60" value="60" />
              </div>
            </div>
            <span id="maxText" class="age-value">60</span>
          </div>

          <button id="send" class="chat-send" disabled>➤</button>
        </div>
      </div>
    </div>

    <script src="js/common.js"></script>

    <script>
      /* location guard */
      if (!getFromLocal("location")) {
        navigateTo("location-permission.html");
      }

      /* chat helpers */
      const chat = document.getElementById("chat");
      let lastMessageType = null;

      function scrollBottom() {
        requestAnimationFrame(() => {
          chat.scrollTop = chat.scrollHeight;
        });
      }

      function addBot(t) {
        const showAvatar = lastMessageType !== "bot";

        chat.insertAdjacentHTML(
          "beforeend",
          `<div class="chat-row">
            ${showAvatar ? '<div class="chat-avatar"></div>' : '<div style="width: 36px; flex-shrink: 0;"></div>'}
            <div class="chat-bubble">${t}</div>
          </div>`,
        );

        lastMessageType = "bot";
        scrollBottom();
      }

      function addMine(t) {
        chat.insertAdjacentHTML(
          "beforeend",
          `<div class="chat-row mine">
            <div class="chat-bubble mine">${t}</div>
          </div>`,
        );

        lastMessageType = "user";
        scrollBottom();
      }

      /* questions */
      const firstName = getFromLocal("firstName") || "there";

      const Q = [
        { type: "bot", text: `hi ${firstName}, i'm coco` },
        { type: "bot", text: "let's find someone who really gets you" },
        { type: "bot", text: "to do that," },
        { type: "bot", text: "we need to get to know you first" },

        {
          type: "select",
          id: "gender",
          text: "how do you identify your gender?",
          options: ["woman", "man", "non-binary"],
        },

        { type: "gender_detail" },

        {
          type: "select",
          id: "drink",
          text: "do you drink alcohol?",
          options: ["yes", "no"],
        },
        {
          type: "select",
          id: "smoke",
          text: "do you smoke?",
          options: ["yes", "no"],
        },
        {
          type: "select",
          id: "marijuana",
          text: "do you use marijuana?",
          options: ["yes", "no"],
        },

        {
          type: "select",
          id: "sexual_orientation",
          text: "next, please select your sexual orientation",
          options: [
            "men",
            "women",
            "men and women",
            "men and non-binary people",
            "women and non-binary people",
            "all types of genders",
          ],
        },

        {
          type: "range",
          id: "age_preference",
          text: "what age range are you looking for?",
        },

        { type: "bot", text: "thanks for telling me" },
        { type: "bot", text: "now let's switch gears" },
        {
          type: "bot",
          text: "let's fill your playlist with the music and artists you love",
        },
      ];

      /* state */
      let step = 0;
      const answers = {};

      const select = document.getElementById("select");
      const send = document.getElementById("send");
      const ageBox = document.getElementById("ageBox");

      /* slider logic */
      const minAge = document.getElementById("minAge");
      const maxAge = document.getElementById("maxAge");
      const rangeFill = document.getElementById("rangeFill");
      const minText = document.getElementById("minText");
      const maxText = document.getElementById("maxText");

      function updateRange() {
        let min = +minAge.value;
        let max = +maxAge.value;

        if (min > max) [min, max] = [max, min];

        const pMin = ((min - 20) / 40) * 100;
        const pMax = ((max - 20) / 40) * 100;

        rangeFill.style.left = pMin + "%";
        rangeFill.style.width = pMax - pMin + "%";

        minText.innerText = min;
        maxText.innerText = max;
      }

      minAge.oninput = maxAge.oninput = updateRange;
      updateRange();

      /* flow */
      function next() {
        const q = Q[step];
        if (!q) return finish();

        if (q.type === "bot") {
          select.disabled = true; // 추가: 봇 메시지 중에는 비활성화
          send.disabled = true;
          addBot(q.text);
          step++;
          setTimeout(() => {
            next();
            if (step >= Q.length || Q[step].type !== "bot") {
              send.disabled = false;
            }
          }, 800);
          return;
        }

        if (q.type === "select") {
          addBot(q.text);
          ageBox.classList.remove("active");
          select.style.display = "block"; // 추가: select 보이기
          select.disabled = false; // 활성화
          send.disabled = true;
          select.innerHTML =
            `<option value="">select ${q.id}</option>` + // 수정: placeholder 텍스트
            q.options.map((o) => `<option value="${o}">${o}</option>`).join(""); // 수정: value 추가
          return;
        }

        if (q.type === "range") {
          addBot(q.text);
          ageBox.classList.add("active");
          select.style.display = "none";
          select.disabled = true; // 추가: range일 때는 select 비활성화
          send.disabled = false;
          return;
        }

        if (q.type === "gender_detail") {
          const g = answers.gender;
          const map = {
            woman: [
              "cis woman",
              "trans woman",
              "intersex woman",
              "transfeminine",
              "woman and non-binary",
            ],
            man: [
              "cis man",
              "trans man",
              "intersex man",
              "transmasculine",
              "man and non-binary",
              "or something else",
            ],
            "non-binary": [
              "Agender",
              "Bigender",
              "Genderfluid",
              "Genderqueer",
              "Gender nonconforming",
            ],
          };
          Q.splice(step, 1, {
            type: "select",
            id: "gender_detail",
            text: "okay\nnow, please choose the description that best matches your gender",
            options: map[g],
          });
          next();
        }
      }

      select.onchange = () => (send.disabled = !select.value);

      send.onclick = () => {
        const q = Q[step];

        if (q.type === "select") {
          answers[q.id] = select.value;
          addMine(select.value);
        }

        if (q.type === "range") {
          answers[q.id] = { min: +minAge.value, max: +maxAge.value };
          addMine(`${minAge.value} - ${maxAge.value}`);
        }

        step++;
        setTimeout(() => {
          next();
        }, 600);
      };

      /* finish */
      async function finish() {
        showLoading();
        await apiCall("/onboarding/save", "POST", {
          user_id: getFromLocal("user_id"),
          profile: answers,
        });
        hideLoading();
        navigateTo("playlist.html");
      }

      next();
    </script>
  </body>
</html>
