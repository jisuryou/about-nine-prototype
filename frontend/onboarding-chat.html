<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Onboarding</title>

    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>

    <style>
      body {
        margin: 0;
        background: radial-gradient(
          circle at top,
          #3a3a3a 0%,
          #1c1c1c 60%,
          #111 100%
        );
        color: white;
        font-family: system-ui;
      }

      /* ======================
   layout
====================== */

      .page {
        max-width: 500px;
        margin: auto;
      }

      .header {
        text-align: center;
        font-size: 30px;
        padding: 28px 0;
        font-weight: 600;
      }

      .chat {
        height: calc(100vh - 160px);
        overflow-y: auto;
        padding: 0 20px 20px;
        display: flex;
        flex-direction: column;
      }

      /* ======================
   bubbles
====================== */

      .row {
        display: flex;
        gap: 10px;
        margin-bottom: 14px;
      }

      .mine-row {
        justify-content: flex-end;
      }

      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #d9d9d9;
        flex-shrink: 0;
      }

      .bubble {
        background: #2b2b2b;
        padding: 14px 18px;
        border-radius: 22px;
        max-width: 72%;
        line-height: 1.5;
        white-space: pre-line;
      }

      .mine {
        background: linear-gradient(135deg, #5b7fff, #7b5bff);
      }

      /* ======================
   input area
====================== */

      .input-area {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        background: #151515;
        border-top: 1px solid #2b2b2b;
      }

      .wrap {
        max-width: 500px;
        margin: auto;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      /* select + slider 동일폭 */
      select,
      .range-wrap {
        flex: 1;
      }

      select {
        background: #2a2a2a;
        border: none;
        border-radius: 28px;
        padding: 14px 18px;
        color: white;
      }

      /* send */
      .send {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #5b7fff, #7b5bff);
        color: white;
        font-size: 20px;
      }

      /* ======================
   dual slider
====================== */

      .range-wrap {
        padding: 12px 16px;
        background: #2a2a2a;
        border-radius: 24px;
      }

      .range-values {
        text-align: center;
        font-size: 14px;
        margin-bottom: 8px;
      }

      .range-track {
        position: relative;
        height: 36px;
      }

      .range-track::before {
        content: "";
        position: absolute;
        top: 16px;
        left: 0;
        right: 0;
        height: 4px;
        background: #444;
        border-radius: 4px;
      }

      .range-fill {
        position: absolute;
        top: 16px;
        height: 4px;
        background: #7b5bff;
        border-radius: 4px;
      }

      .range-track input {
        position: absolute;
        width: 100%;
        height: 36px;
        pointer-events: none;
        background: none;
        -webkit-appearance: none;
      }

      .range-track input::-webkit-slider-thumb {
        pointer-events: auto;
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #7b5bff;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <div class="header">COCO</div>
      <div id="chat" class="chat"></div>
    </div>

    <div class="input-area">
      <div class="wrap">
        <select id="select" disabled></select>

        <div id="ageBox" class="range-wrap" style="display: none">
          <div id="ageText" class="range-values">20 - 60</div>
          <div class="range-track">
            <div id="rangeFill" class="range-fill"></div>
            <input id="minAge" type="range" min="20" max="60" value="20" />
            <input id="maxAge" type="range" min="20" max="60" value="60" />
          </div>
        </div>

        <button id="send" class="send" disabled>➤</button>
      </div>
    </div>

    <script src="js/common.js"></script>

    <script>
      /* ======================
   location guard
====================== */

      if (!getFromLocal("location")) {
        navigateTo("location-permission.html");
      }

      /* ======================
   chat helpers
====================== */

      const chat = document.getElementById("chat");

      function scrollBottom() {
        requestAnimationFrame(() => {
          chat.scrollTop = chat.scrollHeight;
        });
      }

      function addBot(t) {
        chat.insertAdjacentHTML(
          "beforeend",
          `<div class="row">
      <div class="avatar"></div>
      <div class="bubble">${t}</div>
    </div>`,
        );
        scrollBottom();
      }

      function addMine(t) {
        chat.insertAdjacentHTML(
          "beforeend",
          `<div class="row mine-row">
      <div class="bubble mine">${t}</div>
    </div>`,
        );
        scrollBottom();
      }

      /* ======================
   questions
====================== */

      const firstName = getFromLocal("firstName") || "there";

      const Q = [
        { type: "bot", text: `hi ${firstName}, i’m coco` },
        { type: "bot", text: "let’s find someone who really gets you" },
        { type: "bot", text: "to do that,\nwe need to get to know you first" },

        {
          type: "select",
          id: "gender",
          text: "how do you identify your gender?",
          options: ["woman", "man", "non-binary"],
        },

        { type: "gender_detail" },

        {
          type: "select",
          id: "drink",
          text: "do you drink alcohol?",
          options: ["yes", "no"],
        },
        {
          type: "select",
          id: "smoke",
          text: "do you smoke?",
          options: ["yes", "no"],
        },
        {
          type: "select",
          id: "marijuana",
          text: "do you use marijuana?",
          options: ["yes", "no"],
        },

        {
          type: "select",
          id: "sexual_orientation",
          text: "next, please select your sexual orientation",
          options: [
            "men",
            "women",
            "men and women",
            "men and non-binary people",
            "women and non-binary people",
            "all types of genders",
          ],
        },

        {
          type: "range",
          id: "age_preference",
          text: "what age range are you looking for?",
        },

        { type: "bot", text: "thanks for telling me" },
        { type: "bot", text: "now let’s switch gears" },
        {
          type: "bot",
          text: "let’s fill your playlist with the music and artists you love",
        },
      ];

      /* ======================
   state
====================== */

      let step = 0;
      const answers = {};

      const select = document.getElementById("select");
      const send = document.getElementById("send");
      const ageBox = document.getElementById("ageBox");

      /* ======================
   slider logic
====================== */

      const minAge = document.getElementById("minAge");
      const maxAge = document.getElementById("maxAge");
      const rangeFill = document.getElementById("rangeFill");
      const ageText = document.getElementById("ageText");

      function updateRange() {
        let min = +minAge.value;
        let max = +maxAge.value;

        if (min > max) [min, max] = [max, min];

        const pMin = ((min - 20) / 40) * 100;
        const pMax = ((max - 20) / 40) * 100;

        rangeFill.style.left = pMin + "%";
        rangeFill.style.width = pMax - pMin + "%";

        ageText.innerText = `${min} - ${max}`;
      }

      minAge.oninput = maxAge.oninput = updateRange;
      updateRange();

      /* ======================
   flow
====================== */

      function next() {
        const q = Q[step];
        if (!q) return finish();

        if (q.type === "bot") {
          addBot(q.text);
          step++;
          setTimeout(next, 800);
          return;
        }

        if (q.type === "select") {
          addBot(q.text);
          select.style.display = "block";
          ageBox.style.display = "none";
          select.disabled = false;
          send.disabled = true;
          select.innerHTML =
            "<option value=''>select</option>" +
            q.options.map((o) => `<option>${o}</option>`).join("");
          return;
        }

        if (q.type === "range") {
          addBot(q.text);
          select.style.display = "none";
          ageBox.style.display = "block";
          send.disabled = false;
          return;
        }

        if (q.type === "gender_detail") {
          const g = answers.gender;
          const map = {
            woman: [
              "cis woman",
              "trans woman",
              "intersex woman",
              "transfeminine",
              "woman and non-binary",
            ],
            man: [
              "cis man",
              "trans man",
              "intersex man",
              "transmasculine",
              "man and non-binary",
              "or something else",
            ],
            "non-binary": [
              "Agender",
              "Bigender",
              "Genderfluid",
              "Genderqueer",
              "Gender nonconforming",
            ],
          };
          Q.splice(step, 1, {
            type: "select",
            id: "gender_detail",
            text: "okay\nnow, please choose the description that best matches your gender",
            options: map[g],
          });
          next();
        }
      }

      select.onchange = () => (send.disabled = !select.value);

      send.onclick = () => {
        const q = Q[step];

        if (q.type === "select") {
          answers[q.id] = select.value;
          addMine(select.value);
        }

        if (q.type === "range") {
          answers[q.id] = { min: +minAge.value, max: +maxAge.value };
          addMine(`${minAge.value} - ${maxAge.value}`);
        }

        step++;
        next();
      };

      /* ======================
   finish
====================== */

      async function finish() {
        showLoading();
        await apiCall("/onboarding/save", "POST", {
          user_id: getFromLocal("user_id"),
          profile: answers,
        });
        hideLoading();
        navigateTo("playlist.html");
      }

      next();
    </script>
  </body>
</html>
