<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Session</title>
  <link rel="stylesheet" href="css/style.css">
  <script type="module" src="js/firebase.js"></script>
  <style>
    body {
      padding: 0;
    }
    
    .session-container {
      width: 100%;
      max-width: 500px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    
    .session-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .timer {
      font-size: 48px;
      font-weight: 600;
      color: var(--accent-yellow);
      margin-bottom: 10px;
    }
    
    .session-info {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .participants {
      display: flex;
      justify-content: space-around;
      margin-bottom: 40px;
    }
    
    .participant {
      text-align: center;
    }
    
    .participant-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg-card);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 15px;
      border: 3px solid var(--border-color);
      transition: all 0.3s;
    }
    
    .participant-avatar.speaking {
      border-color: var(--accent-yellow);
      box-shadow: 0 0 20px var(--accent-yellow);
      animation: pulse 1s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .participant-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .transcript-container {
      flex: 1;
      background: var(--bg-card);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      overflow-y: auto;
      max-height: 300px;
    }
    
    .transcript-title {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
    }
    
    .transcript-message {
      margin-bottom: 15px;
      padding: 12px;
      background: var(--bg-darker);
      border-radius: 10px;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .transcript-speaker {
      font-size: 12px;
      color: var(--accent-yellow);
      margin-bottom: 5px;
      font-weight: 600;
    }
    
    .transcript-text {
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.6;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 28px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .control-btn.end {
      background: var(--error-red);
    }
    
    .control-btn:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <div class="session-container">
    <div class="session-header">
      <div class="timer" id="timer">20:00</div>
      <div class="session-info">1st session - 20 minutes</div>
    </div>
    
    <div class="participants">
      <div class="participant">
        <div class="participant-avatar" id="myAvatar">üë§</div>
        <div class="participant-name">You</div>
      </div>
      <div class="participant">
        <div class="participant-avatar" id="partnerAvatar">üë§</div>
        <div class="participant-name" id="partnerName">Partner</div>
      </div>
    </div>
    
    <div class="transcript-container">
      <div class="transcript-title">conversation transcript</div>
      <div id="transcript">
        <p style="text-align: center; color: var(--text-secondary); font-size: 14px;">
          conversation will be transcribed here...
        </p>
      </div>
    </div>
    
    <div class="controls">
      <button class="control-btn end" onclick="endSession()" title="End call">
        ‚òéÔ∏è
      </button>
    </div>
  </div>
  
  <script src="js/common.js"></script>
  <script>
    const partner = getFromLocal('chat_partner');
    
    // ÌååÌä∏ÎÑà Ïù¥Î¶Ñ ÌëúÏãú
    if (partner) {
      document.getElementById('partnerName').textContent = partner.firstName;
    }
    
    // ÌÉÄÏù¥Î®∏ (20Î∂Ñ = 1200Ï¥à, ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ: 30Ï¥àÎ°ú Îã®Ï∂ï)
    let totalSeconds = 30; // ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ: 30Ï¥à
    const timerEl = document.getElementById('timer');
    
    const timerInterval = setInterval(() => {
      totalSeconds--;
      
      const mins = Math.floor(totalSeconds / 60);
      const secs = totalSeconds % 60;
      timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      
      if (totalSeconds <= 0) {
        clearInterval(timerInterval);
        endSession();
      }
    }, 1000);
    
    // ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ: ÎçîÎØ∏ ÎåÄÌôî ÏãúÎÆ¨Î†àÏù¥ÏÖò
    const dummyConversation = [
      { speaker: 'You', text: 'Hi! Nice to meet you!', delay: 2000 },
      { speaker: partner?.firstName || 'Partner', text: 'Hello! Great to meet you too!', delay: 4000 },
      { speaker: 'You', text: 'So what kind of music do you like?', delay: 7000 },
      { speaker: partner?.firstName || 'Partner', text: 'I love indie rock and electronic music!', delay: 10000 },
      { speaker: 'You', text: 'That\'s awesome! I\'m into similar stuff.', delay: 13000 }
    ];
    
    const transcriptEl = document.getElementById('transcript');
    const myAvatar = document.getElementById('myAvatar');
    const partnerAvatar = document.getElementById('partnerAvatar');
    
    // ÎåÄÌôî ÏãúÎÆ¨Î†àÏù¥ÏÖò
    dummyConversation.forEach(msg => {
      setTimeout(() => {
        // Speaking Ïï†ÎãàÎ©îÏù¥ÏÖò
        const avatar = msg.speaker === 'You' ? myAvatar : partnerAvatar;
        avatar.classList.add('speaking');
        
        // Ìä∏ÎûúÏä§ÌÅ¨Î¶ΩÌä∏ Ï∂îÍ∞Ä
        const messageDiv = document.createElement('div');
        messageDiv.className = 'transcript-message';
        messageDiv.innerHTML = `
          <div class="transcript-speaker">${msg.speaker}</div>
          <div class="transcript-text">${msg.text}</div>
        `;
        
        // Ï≤òÏùå Î©îÏãúÏßÄÎ©¥ ÏïàÎÇ¥ ÌÖçÏä§Ìä∏ Ï†úÍ±∞
        if (transcriptEl.querySelector('p')) {
          transcriptEl.innerHTML = '';
        }
        
        transcriptEl.appendChild(messageDiv);
        transcriptEl.scrollTop = transcriptEl.scrollHeight;
        
        // 2Ï¥à ÌõÑ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†úÍ±∞
        setTimeout(() => {
          avatar.classList.remove('speaking');
        }, 2000);
      }, msg.delay);
    });
    
    function endSession() {
      clearInterval(timerInterval);
      
      // ÎåÄÌôî ÎÇ¥Ïö© Ï†ÄÏû•
      const transcriptMessages = Array.from(document.querySelectorAll('.transcript-message')).map(msg => ({
        speaker: msg.querySelector('.transcript-speaker').textContent,
        text: msg.querySelector('.transcript-text').textContent
      }));
      
      saveToLocal('session_transcript', transcriptMessages);
      
      // Chat End ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
      navigateTo('chat-end.html');
    }
  </script>
</body>
</html>