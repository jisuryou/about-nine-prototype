<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Profile</title>
    <link rel="stylesheet" href="css/style.css" />

    <style>
      .card {
        margin-bottom: 12px;
        flex-direction: column;
        align-items: stretch;
      }

      .card.clickable {
        cursor: pointer;
      }

      .card.clickable:hover {
        background: #2f2f2f;
      }

      .profile-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .profile-label {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .profile-value {
        font-size: 12px;
        color: var(--text-primary);
        font-weight: 500;
        text-align: right;
      }

      .profile-value.editable {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        transition: background 0.2s;
      }

      .profile-value.editable:hover {
        background: var(--bg-card);
      }

      .section-title {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        padding-left: 4px;
      }

      /* Bio ÌÖçÏä§Ìä∏ ÏòÅÏó≠ */
      .card textarea {
        width: 100%;
        min-height: 80px;
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-size: 12px;
        font-family: "Merriweather", serif;
        resize: vertical;
        padding: 0;
        margin: 0;
      }

      .card textarea:focus {
        outline: none;
        border: none;
      }

      .card textarea::placeholder {
        color: var(--text-secondary);
        opacity: 0.5;
      }

      /* Ïä¨ÎùºÏù¥Îçî */
      .age-slider-track::before {
        background: var(--border-color);
      }

      /* üî• ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ïπ© ÏòÅÏó≠ */
      .playlist-chips-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 50px;
        align-items: center;
        justify-content: center;
      }

      .playlist-empty-state {
        color: var(--text-secondary);
        font-size: 12px;
        text-align: center;
        width: 100%;
      }

      /* üî• select Ïä§ÌÉÄÏùº */
      .profile-select {
        width: auto;
        padding: 4px 8px;
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        text-align: right;
        appearance: none;
        margin-bottom: 0;
      }

      .profile-select:focus {
        outline: none;
        background: var(--bg-card);
        border-radius: 6px;
      }

      /* ÌïòÎã® Î≤ÑÌäºÎì§ */
      .action-btn.sign-out {
        color: var(--text-primary);
      }

      .action-btn.delete {
        color: var(--error-red);
      }

      .action-btn:hover {
        opacity: 0.7;
        transform: none;
        box-shadow: none;
      }

      /* Ï†ÄÏû• Ï§ë ÌëúÏãú */
      .saving-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-green);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 1000;
      }

      .saving-indicator.show {
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <div class="saving-indicator" id="savingIndicator">saved ‚úì</div>

    <div class="main-container">
      <div
        class="chat-header brand-text"
        style="text-align: left; color: #8e8e8e"
      >
        about nine
      </div>

      <div class="tabs">
        <button id="aboutTab" class="tab active">about you</button>
        <button id="recommendationTab" class="tab">recommendation</button>
      </div>

      <div class="content">
        <!-- About You ÌÉ≠ -->
        <div id="aboutContent" class="tab-pane active">
          <!-- Age & Gender -->
          <div class="card">
            <div class="profile-row">
              <span class="profile-label">age</span>
              <span class="profile-value" id="ageValue">-</span>
            </div>
            <div class="profile-row">
              <span class="profile-label">gender</span>
              <span class="profile-value" id="genderValue">-</span>
            </div>
          </div>

          <!-- üî• Playlist - Ï†ÑÏ≤¥ ÌÅ¥Î¶≠ Í∞ÄÎä• -->
          <div class="section-title">playlist</div>
          <div class="card clickable" onclick="editPlaylist()">
            <div id="playlistChips" class="playlist-chips-container"></div>
          </div>

          <!-- Drinking, Smoking, Marijuana -->
          <div class="card">
            <div class="profile-row">
              <span class="profile-label">drinking</span>
              <select
                class="profile-select"
                id="drinkSelect"
                onchange="updateField('drink', this.value)"
              >
                <option value="yes">yes</option>
                <option value="no">no</option>
              </select>
            </div>
            <div class="profile-row">
              <span class="profile-label">smoking</span>
              <select
                class="profile-select"
                id="smokeSelect"
                onchange="updateField('smoke', this.value)"
              >
                <option value="yes">yes</option>
                <option value="no">no</option>
              </select>
            </div>
            <div class="profile-row">
              <span class="profile-label">marijuana</span>
              <select
                class="profile-select"
                id="marijuanaSelect"
                onchange="updateField('marijuana', this.value)"
              >
                <option value="yes">yes</option>
                <option value="no">no</option>
              </select>
            </div>
          </div>

          <!-- Bio -->
          <div class="section-title">additional information</div>
          <div class="card">
            <textarea
              id="bioText"
              placeholder="tell us more about yourself..."
            ></textarea>
          </div>

          <!-- Contact -->
          <div class="section-title">contact</div>
          <div class="card">
            <div
              style="color: var(--text-primary); font-size: 14px"
              id="phoneValue"
            >
              -
            </div>
          </div>

          <!-- Bottom Actions -->
          <button id="saveButton1" onclick="saveProfile()" style="margin: 8px 0 20px 0;">save</button>
          <div class="bottom-text sign-out" onclick="signOut()">
            sign out
          </div>
          <div class="bottom-text delete" onclick="deleteAccount()">
            delete account
          </div>
        </div>

        <!-- Recommendation ÌÉ≠ -->
        <div id="recommendationContent" class="tab-pane">
          <!-- Who I Want to Meet -->
          <div class="card">
            <div class="profile-row">
              <span class="profile-label">who i want to meet</span>
              <select
                class="profile-select"
                id="orientationSelect"
                onchange="updateField('sexual_orientation', this.value)"
              >
                <option value="men">men</option>
                <option value="women">women</option>
                <option value="men and women">men and women</option>
                <option value="men and non-binary people">men and non-binary</option>
                <option value="women and non-binary people">women and non-binary</option>
                <option value="all types of genders">all types</option>
              </select>
            </div>
          </div>

          <!-- Age Range Slider -->
        <div class="section-title">age range</div>
          <div class="card">
            <div class="age-range-box active">
              <span class="age-value" id="minAgeDisplay">20</span>
              <div class="age-slider-container">
                <div class="age-slider-track">
                  <div class="age-slider-fill" id="sliderFill"></div>
                  <input
                    type="range"
                    id="minAgeSlider"
                    min="20"
                    max="60"
                    value="20"
                  />
                  <input
                    type="range"
                    id="maxAgeSlider"
                    min="20"
                    max="60"
                    value="60"
                  />
                </div>
              </div>
              <span class="age-value" id="maxAgeDisplay">60</span>
            </div>
          </div>

          <!-- Bottom Actions -->
          <button id="saveButton2" onclick="saveProfile()" style="margin-top: 8px;">save</button>
        </div>
      </div>
    </div>

    <!-- ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <nav id="bottomNav" class="bottom-nav"></nav>

    <script src="js/common.js"></script>

    <script>
      let userId = null;
      let profileData = null;
      let hasChanges = false;

      /* ======================
         ÌÉ≠ Ï†ÑÌôò
      ====================== */
      const aboutTab = document.getElementById("aboutTab");
      const recommendationTab = document.getElementById("recommendationTab");
      const aboutContent = document.getElementById("aboutContent");
      const recommendationContent = document.getElementById(
        "recommendationContent",
      );

      aboutTab.onclick = () => {
        aboutTab.classList.add("active");
        recommendationTab.classList.remove("active");
        aboutContent.classList.add("active");
        recommendationContent.classList.remove("active");
      };

      recommendationTab.onclick = () => {
        recommendationTab.classList.add("active");
        aboutTab.classList.remove("active");
        recommendationContent.classList.add("active");
        aboutContent.classList.remove("active");
      };

      /* ======================
         ÌîÑÎ°úÌïÑ Î°úÎìú
      ====================== */
      async function loadProfile() {
        try {
          userId = getFromLocal("user_id");
          if (!userId) {
            navigateTo("index.html");
            return;
          }

          showLoading("loading profile...");

          const res = await apiCall("/users/profile");

          if (!res.success) {
            hideLoading();
            alert("profile not found");
            navigateTo("index.html");
            return;
          }

          profileData = res.user;

          if (!profileData.onboarding_profile) {
            profileData.onboarding_profile = {};
          }

          hideLoading();

          updateUI();
        } catch (error) {
          hideLoading();
          console.error("Failed to load profile:", error);
          alert("failed to load profile");
        }
      }

      /* ======================
         UI ÏóÖÎç∞Ïù¥Ìä∏
      ====================== */
      function updateUI() {
        // About You ÌÉ≠
        document.getElementById("ageValue").textContent =
          profileData.age || "-";
        document.getElementById("genderValue").textContent =
          profileData.gender_detail || profileData.gender || "-";
        document.getElementById("phoneValue").textContent =
          profileData.phone || "-";

        const profile = profileData.onboarding_profile || {};
        
        // üî• select Í∞í ÏÑ§Ï†ï
        document.getElementById("drinkSelect").value = profile.drink || "no";
        document.getElementById("smokeSelect").value = profile.smoke || "no";
        document.getElementById("marijuanaSelect").value = profile.marijuana || "no";

        document.getElementById("bioText").value = profileData.bio || "";

        // üî• ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ïπ© Î†åÎçîÎßÅ
        renderPlaylistChips();

        // Recommendation ÌÉ≠
        document.getElementById("orientationSelect").value =
          profile.sexual_orientation || "all types of genders";

        const agePref = profile.age_preference || { min: 20, max: 60 };
        document.getElementById("minAgeSlider").value = agePref.min;
        document.getElementById("maxAgeSlider").value = agePref.max;
        updateSlider();

        hasChanges = false;
        updateSaveButton();
      }

      /* ======================
         üî• ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ïπ© Î†åÎçîÎßÅ
      ====================== */
      function renderPlaylistChips() {
        const container = document.getElementById("playlistChips");
        const playlist = profileData.playlist || [];

        if (playlist.length === 0) {
          container.innerHTML =
            '<div class="playlist-empty-state">tap to select songs</div>';
          return;
        }

        container.innerHTML = playlist
          .map(
            (track) => `
          <div class="track-chip">
            <span class="track-chip-text">${track.name}</span>
          </div>
        `,
          )
          .join("");
      }

      /* ======================
         üî• ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ìé∏Ïßë
      ====================== */
      function editPlaylist() {
        saveToLocal("selected_tracks", profileData.playlist || []);
        navigateTo("playlist.html");
      }

      /* ======================
         üî• ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏ (select Î≥ÄÍ≤Ω Ïãú)
      ====================== */
      function updateField(field, value) {
        if (!profileData.onboarding_profile) {
          profileData.onboarding_profile = {};
        }

        profileData.onboarding_profile[field] = value;
        markChanged();
      }

      /* ======================
         Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌëúÏãú
      ====================== */
      function markChanged() {
        hasChanges = true;
        updateSaveButton();
      }

      function updateSaveButton() {
        const saveButton1 = document.getElementById("saveButton1");
        const saveButton2 = document.getElementById("saveButton2");

        if (hasChanges) {
          saveButton1.disabled = false;
          saveButton1.textContent = "save";
          saveButton2.disabled = false;
          saveButton2.textContent = "save";
        } else {
          saveButton1.disabled = true;
          saveButton1.textContent = "no changes";
          saveButton2.disabled = true;
          saveButton2.textContent = "no changes";
        }
      }

      /* ======================
         Ïä¨ÎùºÏù¥Îçî Î°úÏßÅ
      ====================== */
      const minSlider = document.getElementById("minAgeSlider");
      const maxSlider = document.getElementById("maxAgeSlider");
      const sliderFill = document.getElementById("sliderFill");
      const minDisplay = document.getElementById("minAgeDisplay");
      const maxDisplay = document.getElementById("maxAgeDisplay");

      function updateSlider() {
        let min = parseInt(minSlider.value);
        let max = parseInt(maxSlider.value);

        if (min > max) {
          [min, max] = [max, min];
          minSlider.value = min;
          maxSlider.value = max;
        }

        const minPercent = ((min - 20) / 40) * 100;
        const maxPercent = ((max - 20) / 40) * 100;

        sliderFill.style.left = minPercent + "%";
        sliderFill.style.width = maxPercent - minPercent + "%";

        minDisplay.textContent = min;
        maxDisplay.textContent = max;
      }

      minSlider.oninput = () => {
        updateSlider();

        if (!profileData.onboarding_profile) {
          profileData.onboarding_profile = {};
        }

        profileData.onboarding_profile.age_preference = {
          min: parseInt(minSlider.value),
          max: parseInt(maxSlider.value),
        };

        markChanged();
      };

      maxSlider.oninput = () => {
        updateSlider();

        if (!profileData.onboarding_profile) {
          profileData.onboarding_profile = {};
        }

        profileData.onboarding_profile.age_preference = {
          min: parseInt(minSlider.value),
          max: parseInt(maxSlider.value),
        };

        markChanged();
      };

      /* ======================
         Bio Î≥ÄÍ≤Ω Í∞êÏßÄ
      ====================== */
      document.getElementById("bioText").addEventListener("input", (e) => {
        if (!profileData) return;
        profileData.bio = e.target.value;
        markChanged();
      });

      /* ======================
         Ï†ÄÏû•
      ====================== */
      async function saveProfile() {
        if (!hasChanges) {
          return;
        }

        try {
          showLoading("saving...");

          const res = await apiCall("/users/profile", "POST", {
            onboarding_profile: profileData.onboarding_profile,
            bio: profileData.bio || "",
            sexual_orientation:
              profileData.onboarding_profile.sexual_orientation,
            age_preference: profileData.onboarding_profile.age_preference,
          });

          hideLoading();

          if (res.success) {
            showSaveIndicator();
            hasChanges = false;
            updateSaveButton();
          } else {
            alert("failed to save profile");
          }
        } catch (error) {
          hideLoading();
          console.error("Failed to save profile:", error);
          alert("failed to save profile");
        }
      }

      function showSaveIndicator() {
        const indicator = document.getElementById("savingIndicator");
        indicator.classList.add("show");
        setTimeout(() => {
          indicator.classList.remove("show");
        }, 2000);
      }

      /* ======================
         Actions
      ====================== */
      function signOut() {
        if (confirm("are you sure you want to sign out?")) {
          localStorage.clear();
          navigateTo("index.html");
        }
      }

      function deleteAccount() {
        const confirmation = prompt(
          'type "DELETE" to confirm account deletion:',
        );
        if (confirmation === "DELETE") {
          // TODO: API call to delete account
          alert("account deletion is not yet implemented");
        }
      }

      /* ======================
         Init
      ====================== */
      window.onload = () => {
        renderBottomNav("profile");
        loadProfile();
      };
    </script>
  </body>
</html>