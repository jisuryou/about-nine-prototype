<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Playlist</title>
  <link rel="stylesheet" href="css/style.css">
  <script type="module" src="js/firebase-config.js"></script>
  <style>
    body {
      padding: 20px;
      align-items: flex-start;
    }
    
    .playlist-container {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      padding-bottom: 100px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .header p {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .search-box {
      position: relative;
      margin-bottom: 30px;
    }
    
    .search-input {
      width: 100%;
      padding: 16px 50px 16px 20px;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 25px;
      color: var(--text-primary);
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .search-input:focus {
      border-color: var(--accent-yellow);
      outline: none;
    }
    
    .search-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-yellow);
      border: none;
      color: var(--bg-dark);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .search-btn:hover {
      transform: translateY(-50%) scale(1.05);
    }
    
    .selected-section {
      margin-bottom: 30px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .track-count {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 400;
    }
    
    .track-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .track-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--bg-card);
      border-radius: 12px;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    .track-item:hover {
      border-color: var(--border-color);
    }
    
    .track-image {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      background: var(--border-color);
      margin-right: 15px;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .track-info {
      flex: 1;
      min-width: 0;
    }
    
    .track-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 15px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .track-artist {
      color: var(--text-secondary);
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .track-action {
      flex-shrink: 0;
      margin-left: 10px;
    }
    
    .add-btn, .remove-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .add-btn {
      background: var(--success-green);
      color: white;
    }
    
    .remove-btn {
      background: var(--error-red);
      color: white;
    }
    
    .add-btn:hover, .remove-btn:hover {
      transform: scale(1.1);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .next-btn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 40px);
      max-width: 460px;
      padding: 16px;
      background: white;
      color: var(--bg-dark);
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    
    .next-btn:hover:not(:disabled) {
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
    }
    
    .next-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .min-tracks-notice {
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
      margin-top: 10px;
    }
    
    .loading-spinner {
      text-align: center;
      padding: 20px;
    }
    
    .spinner-small {
      width: 30px;
      height: 30px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-yellow);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div class="playlist-container">
    <div class="header">
      <h1>build your playlist</h1>
      <p>add at least 3 songs you love</p>
    </div>
    
    <div class="search-box">
      <input 
        type="text" 
        class="search-input" 
        id="searchInput" 
        placeholder="search for songs or artists..."
        autocomplete="off"
      >
      <button class="search-btn" onclick="searchMusic()">üîç</button>
    </div>
    
    <div class="selected-section" id="selectedSection">
      <div class="section-title">
        your playlist
        <span class="track-count" id="trackCount">0 / 10</span>
      </div>
      <div class="track-list" id="selectedList">
        <div class="empty-state">
          your selected songs will appear here
        </div>
      </div>
    </div>
    
    <div class="selected-section" id="searchSection" style="display: none;">
      <div class="section-title">search results</div>
      <div id="searchLoading" class="loading-spinner" style="display: none;">
        <div class="spinner-small"></div>
      </div>
      <div class="track-list" id="searchResults"></div>
    </div>
    
    <button class="next-btn" id="nextBtn" onclick="finishPlaylist()" disabled>
      next
    </button>
    <p class="min-tracks-notice" id="minNotice">select at least 3 songs to continue</p>
  </div>
  
  <script src="js/common.js"></script>
  <script>
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const selectedList = document.getElementById('selectedList');
    const trackCount = document.getElementById('trackCount');
    const nextBtn = document.getElementById('nextBtn');
    const minNotice = document.getElementById('minNotice');
    const searchSection = document.getElementById('searchSection');
    const searchLoading = document.getElementById('searchLoading');
    
    const MAX_TRACKS = 10;
    const MIN_TRACKS = 3;
    let selectedTracks = [];
    
    // ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ Î™®Îìú: Spotify API ÎåÄÏã† ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
    const USE_MOCK = true;
    
    // ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ: ÎçîÎØ∏ ÏùåÏïÖ Îç∞Ïù¥ÌÑ∞
    const mockTracks = [
      { id: '1', name: 'Blinding Lights', artist: 'The Weeknd', album: 'After Hours', image: 'https://i.scdn.co/image/ab67616d0000b2738863bc11d2aa12b54f5aeb36' },
      { id: '2', name: 'Levitating', artist: 'Dua Lipa', album: 'Future Nostalgia', image: 'https://i.scdn.co/image/ab67616d0000b273be841ba4bc24340152e3a79a' },
      { id: '3', name: 'Save Your Tears', artist: 'The Weeknd', album: 'After Hours', image: 'https://i.scdn.co/image/ab67616d0000b2738863bc11d2aa12b54f5aeb36' },
      { id: '4', name: 'Good 4 U', artist: 'Olivia Rodrigo', album: 'SOUR', image: 'https://i.scdn.co/image/ab67616d0000b273a91c10fe9472d9bd89802e5a' },
      { id: '5', name: 'Peaches', artist: 'Justin Bieber', album: 'Justice', image: 'https://i.scdn.co/image/ab67616d0000b273e6f407c7f3a0ec98845e4431' },
      { id: '6', name: 'drivers license', artist: 'Olivia Rodrigo', album: 'SOUR', image: 'https://i.scdn.co/image/ab67616d0000b273a91c10fe9472d9bd89802e5a' },
      { id: '7', name: 'Kiss Me More', artist: 'Doja Cat ft. SZA', album: 'Planet Her', image: 'https://i.scdn.co/image/ab67616d0000b273be841ba4bc24340152e3a79a' },
      { id: '8', name: 'Heat Waves', artist: 'Glass Animals', album: 'Dreamland', image: 'https://i.scdn.co/image/ab67616d0000b27361cb4483c0f6c8c63fb48235' },
      { id: '9', name: 'Stay', artist: 'The Kid LAROI & Justin Bieber', album: 'Stay', image: 'https://i.scdn.co/image/ab67616d0000b273e6f407c7f3a0ec98845e4431' },
      { id: '10', name: 'Montero', artist: 'Lil Nas X', album: 'MONTERO', image: 'https://i.scdn.co/image/ab67616d0000b273be841ba4bc24340152e3a79a' },
      { id: '11', name: 'Shivers', artist: 'Ed Sheeran', album: '=', image: 'https://i.scdn.co/image/ab67616d0000b273863bc11d2aa12b54f5aeb36' },
      { id: '12', name: 'As It Was', artist: 'Harry Styles', album: "Harry's House", image: 'https://i.scdn.co/image/ab67616d0000b273b46f74097655d7f353caab14' },
    ];
    
    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Í∏∞Ï°¥ ÏÑ†ÌÉù Î°úÎìú
    window.onload = () => {
      const saved = getFromLocal('selected_tracks');
      if (saved && Array.isArray(saved)) {
        selectedTracks = saved;
        updateSelectedList();
      }
    };
    
    // Enter ÌÇ§Î°ú Í≤ÄÏÉâ
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchMusic();
    });
    
    // ÏùåÏïÖ Í≤ÄÏÉâ
    async function searchMusic() {
      const query = searchInput.value.trim();
      if (!query) return;
      
      searchSection.style.display = 'block';
      searchLoading.style.display = 'block';
      searchResults.innerHTML = '';
      
      try {
        let tracks;
        
        if (USE_MOCK) {
          // ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ: ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ
          await new Promise(resolve => setTimeout(resolve, 500)); // Î°úÎî© ÏãúÎÆ¨Î†àÏù¥ÏÖò
          tracks = mockTracks.filter(track => 
            track.name.toLowerCase().includes(query.toLowerCase()) ||
            track.artist.toLowerCase().includes(query.toLowerCase())
          );
        } else {
          // Ïã§Ï†ú Spotify API Ìò∏Ï∂ú
          const result = await apiCall(`/music/search?q=${encodeURIComponent(query)}`);
          tracks = result.tracks || [];
        }
        
        searchLoading.style.display = 'none';
        displaySearchResults(tracks);
        
      } catch (error) {
        searchLoading.style.display = 'none';
        searchResults.innerHTML = '<div class="empty-state">search failed. please try again.</div>';
      }
    }
    
    // Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú
    function displaySearchResults(tracks) {
      if (tracks.length === 0) {
        searchResults.innerHTML = '<div class="empty-state">no results found</div>';
        return;
      }
      
      searchResults.innerHTML = tracks.map(track => {
        const isSelected = selectedTracks.some(t => t.id === track.id);
        const isMaxReached = selectedTracks.length >= MAX_TRACKS;
        
        return `
          <div class="track-item">
            <img src="${track.image || 'https://via.placeholder.com/50'}" alt="album" class="track-image" onerror="this.src='https://via.placeholder.com/50'">
            <div class="track-info">
              <div class="track-name">${track.name}</div>
              <div class="track-artist">${track.artist}</div>
            </div>
            <div class="track-action">
              ${isSelected ? 
                '<span style="color: var(--success-green); font-size: 12px;">‚úì added</span>' :
                (isMaxReached ? 
                  '<span style="color: var(--text-secondary); font-size: 12px;">max reached</span>' :
                  `<button class="add-btn" onclick='addTrack(${JSON.stringify(track).replace(/'/g, "&apos;")})'>+</button>`
                )
              }
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Í≥° Ï∂îÍ∞Ä
    function addTrack(track) {
      if (selectedTracks.length >= MAX_TRACKS) {
        alert(`maximum ${MAX_TRACKS} songs allowed`);
        return;
      }
      
      if (selectedTracks.some(t => t.id === track.id)) {
        return;
      }
      
      selectedTracks.push(track);
      updateSelectedList();
      
      // Í≤ÄÏÉâ Í≤∞Í≥º Í∞±Ïã†
      if (searchInput.value) {
        searchMusic();
      }
    }
    
    // Í≥° ÏÇ≠Ï†ú
    function removeTrack(index) {
      selectedTracks.splice(index, 1);
      updateSelectedList();
      
      // Í≤ÄÏÉâ Í≤∞Í≥º Í∞±Ïã†
      if (searchInput.value) {
        searchMusic();
      }
    }
    
    // ÏÑ†ÌÉùÎêú Í≥° Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
    function updateSelectedList() {
      trackCount.textContent = `${selectedTracks.length} / ${MAX_TRACKS}`;
      
      if (selectedTracks.length === 0) {
        selectedList.innerHTML = '<div class="empty-state">your selected songs will appear here</div>';
      } else {
        selectedList.innerHTML = selectedTracks.map((track, index) => `
          <div class="track-item">
            <img src="${track.image || 'https://via.placeholder.com/50'}" alt="album" class="track-image" onerror="this.src='https://via.placeholder.com/50'">
            <div class="track-info">
              <div class="track-name">${track.name}</div>
              <div class="track-artist">${track.artist}</div>
            </div>
            <div class="track-action">
              <button class="remove-btn" onclick="removeTrack(${index})">√ó</button>
            </div>
          </div>
        `).join('');
      }
      
      // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      nextBtn.disabled = selectedTracks.length < MIN_TRACKS;
      
      if (selectedTracks.length >= MIN_TRACKS) {
        minNotice.style.display = 'none';
      } else {
        minNotice.style.display = 'block';
        minNotice.textContent = `select at least ${MIN_TRACKS - selectedTracks.length} more song${MIN_TRACKS - selectedTracks.length > 1 ? 's' : ''} to continue`;
      }
      
      // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
      saveToLocal('selected_tracks', selectedTracks);
    }
    
    // ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ ÏôÑÎ£å
    async function finishPlaylist() {
      if (selectedTracks.length < MIN_TRACKS) {
        alert(`please select at least ${MIN_TRACKS} songs`);
        return;
      }
      
      try {
        showLoading('saving your playlist...');
        
        // ÏÑúÎ≤ÑÏóê Ï†ÄÏû•
        await apiCall('/playlist/save', 'POST', {
          user_id: getFromLocal('user_id'),
          tracks: selectedTracks
        });
        
        hideLoading();
        
        // Ïò®Î≥¥Îî© ÏôÑÎ£å ÌëúÏãú
        saveToLocal('playlist_completed', true);
        
        // ÎùºÏö¥ÏßÄÎ°ú Ïù¥Îèô
        navigateTo('lounge.html');
        
      } catch (error) {
        hideLoading();
        console.error('ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ï†ÄÏû• Ïò§Î•ò:', error);
        
        // ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ: ÏóêÎü¨ Î¨¥ÏãúÌïòÍ≥† ÏßÑÌñâ
        saveToLocal('playlist_completed', true);
        navigateTo('lounge.html');
      }
    }
  </script>
</body>
</html>