<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Playlist</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase-config.js"></script>

    <!-- ‚úÖ UI Ïä§ÌÉÄÏùº 100% Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ -->
    <style>
      body {
        padding: 20px;
        align-items: flex-start;
      }
      .playlist-container {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        padding-bottom: 100px;
      }
      .header {
        text-align: center;
        margin-bottom: 40px;
      }
      .header h1 {
        font-size: 32px;
        margin-bottom: 10px;
      }
      .header p {
        color: var(--text-secondary);
        font-size: 14px;
      }
      .search-box {
        position: relative;
        margin-bottom: 30px;
      }
      .search-input {
        width: 100%;
        padding: 16px 50px 16px 20px;
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-radius: 25px;
        color: var(--text-primary);
      }
      .search-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent-yellow);
        border: none;
        cursor: pointer;
      }
      .track-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .track-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: var(--bg-card);
        border-radius: 12px;
      }
      .track-image {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        margin-right: 15px;
        object-fit: cover;
      }
      .track-info {
        flex: 1;
        min-width: 0;
      }
      .track-name {
        font-weight: 600;
      }
      .track-artist {
        font-size: 13px;
        color: var(--text-secondary);
      }
      .add-btn,
      .remove-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
      }
      .add-btn {
        background: var(--success-green);
        color: white;
      }
      .remove-btn {
        background: var(--error-red);
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }
      .next-btn {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 460px;
        padding: 16px;
        border-radius: 25px;
      }
    </style>
  </head>

  <body>
    <div class="playlist-container">
      <div class="header">
        <h1>build your playlist</h1>
        <p>add at least 3 songs you love</p>
      </div>

      <!-- Í≤ÄÏÉâ -->
      <div class="search-box">
        <input
          id="searchInput"
          class="search-input"
          placeholder="search for songs or artists..."
        />
        <button class="search-btn" onclick="searchMusic()">üîç</button>
      </div>

      <!-- ÏÑ†ÌÉù -->
      <div class="selected-section">
        <div class="section-title">
          your playlist
          <span id="trackCount">0 / 10</span>
        </div>
        <div id="selectedList" class="track-list">
          <div class="empty-state">your selected songs will appear here</div>
        </div>
      </div>

      <!-- Í≤ÄÏÉâÍ≤∞Í≥º -->
      <div id="searchSection" style="display: none">
        <div class="section-title">search results</div>
        <div id="searchResults" class="track-list"></div>
      </div>

      <button id="nextBtn" class="next-btn" disabled onclick="finishPlaylist()">
        next
      </button>
    </div>

    <script src="js/common.js"></script>

    <script>
      const MAX = 10;
      const MIN = 3;

      let selectedTracks = [];

      const input = document.getElementById("searchInput");
      const results = document.getElementById("searchResults");
      const selected = document.getElementById("selectedList");
      const count = document.getElementById("trackCount");
      const nextBtn = document.getElementById("nextBtn");
      const searchSection = document.getElementById("searchSection");

      // =====================
      // Í≤ÄÏÉâ (YouTube backend)
      // =====================

      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") searchMusic();
      });

      async function searchMusic() {
        const q = input.value.trim();
        if (!q) return;

        searchSection.style.display = "block";
        results.innerHTML = "loading...";

        try {
          const res = await apiCall(`/music/search?q=${encodeURIComponent(q)}`);
          renderResults(res.tracks);
        } catch {
          results.innerHTML = "<div class='empty-state'>search failed</div>";
        }
      }

      // =====================
      // Í≤∞Í≥º ÌëúÏãú
      // =====================

      function renderResults(tracks) {
        if (!tracks.length) {
          results.innerHTML = "<div class='empty-state'>no results</div>";
          return;
        }

        results.innerHTML = tracks
          .map(
            (t) => `
    <div class="track-item">
      <img src="${t.image}" class="track-image">
      <div class="track-info">
        <div class="track-name">${t.name}</div>
        <div class="track-artist">${t.artist}</div>
      </div>
      <button class="add-btn" onclick='addTrack(${JSON.stringify(t)})'>+</button>
    </div>
  `,
          )
          .join("");
      }

      // =====================
      // Ï∂îÍ∞Ä/ÏÇ≠Ï†ú
      // =====================

      function addTrack(t) {
        if (selectedTracks.length >= MAX) return;
        if (selectedTracks.some((x) => x.id === t.id)) return;
        selectedTracks.push(t);
        update();
      }

      function removeTrack(i) {
        selectedTracks.splice(i, 1);
        update();
      }

      // =====================
      // ÏÑ†ÌÉù Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
      // =====================

      function update() {
        count.textContent = `${selectedTracks.length} / ${MAX}`;

        if (!selectedTracks.length) {
          selected.innerHTML =
            "<div class='empty-state'>your selected songs will appear here</div>";
        } else {
          selected.innerHTML = selectedTracks
            .map(
              (t, i) => `
      <div class="track-item">
        <img src="${t.image}" class="track-image">
        <div class="track-info">
          <div class="track-name">${t.name}</div>
          <div class="track-artist">${t.artist}</div>
        </div>
        <button class="remove-btn" onclick="removeTrack(${i})">√ó</button>
      </div>
    `,
            )
            .join("");
        }

        nextBtn.disabled = selectedTracks.length < MIN;
        saveToLocal("selected_tracks", selectedTracks);
      }

      // =====================
      // ÏôÑÎ£å
      // =====================

      async function finishPlaylist() {
        if (selectedTracks.length < MIN) return;

        try {
          showLoading("saving...");

          await apiCall("/users/playlist", "POST", {
            tracks: selectedTracks,
          });

          hideLoading();
          navigateTo("lounge.html");
        } catch (e) {
          hideLoading();
          alert("failed to save playlist");
        }
      }
    </script>
  </body>
</html>
