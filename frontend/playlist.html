<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Playlist</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>
  </head>
  <style>
    .music-title {
      font-size: 14px;
      flex: 1;
      color: var(--text-primary);
    }

    .empty-results {
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }
  </style>
  <body>
    <div class="playlist-container">
      <!-- ÏÉÅÎã® ÏΩòÌÖêÏ∏† Í∑∏Î£π -->
      <div class="playlist-content">
        <div class="chat-header brand-text">
          fill your playlist with <br />
          the sounds you love
        </div>

        <!-- Í≤ÄÏÉâ -->
        <div class="search-box">
          <input
            id="searchInput"
            class="search-input"
            placeholder="song name, artist..."
          />
          <button class="search-btn" onclick="searchMusic()"></button>
        </div>

        <!-- ÏÑ†ÌÉùÎêú Í≥° -->
        <div id="chips" class="track-chips"></div>

        <!-- Í≤ÄÏÉâ Í≤∞Í≥º (Ïä§ÌÅ¨Î°§ ÏòÅÏó≠) -->
        <div id="results" class="card-list"></div>
      </div>

      <!-- ÌïòÎã® Î≤ÑÌäº Í∑∏Î£π -->
      <div>
        <div class="bottom-text" onclick="skip()">maybe later</div>
        <button id="nextBtn" disabled>next</button>
      </div>
    </div>

    <script src="js/common.js"></script>

    <script>
      const MAX = 10;
      const MIN = 3;

      let selectedTracks = [];
      let fromProfile = false; // üî• edit-profileÏóêÏÑú ÏôîÎäîÏßÄ Ï∂îÏ†Å

      const input = document.getElementById("searchInput");
      const chips = document.getElementById("chips");
      const results = document.getElementById("results");
      const nextBtn = document.getElementById("nextBtn");

      /* üî• Ï¥àÍ∏∞Ìôî - Í∏∞Ï°¥ ÏÑ†ÌÉù Î∂àÎü¨Ïò§Í∏∞ */
      window.onload = () => {
        const saved = getFromLocal("selected_tracks");
        if (saved && Array.isArray(saved)) {
          selectedTracks = saved;
          update();
        }
        
        // edit-profileÏóêÏÑú Ïò® Í≤ΩÏö∞ Ï≤¥ÌÅ¨
        fromProfile = document.referrer.includes("edit-profile.html");
      };

      /* Í≤ÄÏÉâ */
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") searchMusic();
      });

      async function searchMusic() {
        const q = input.value.trim();
        if (!q) return;

        results.innerHTML = "";
        showLoading('searching...');

        try {
          const res = await apiCall(`/music/search?q=${encodeURIComponent(q)}`);
          hideLoading();
          renderResults(res.tracks || []);
        } catch {
          hideLoading();
          results.innerHTML =
            "<div style='text-align: center; padding: 20px; color: var(--error-red);'>search failed</div>";
        }
      }

      /* Í≤∞Í≥º Î†åÎçîÎßÅ */
      function renderResults(list) {
        results.innerHTML = "";
        if (!list.length) {
          results.innerHTML =
            "<div class='empty-results'>no results. try another query.</div>";
          return;
        }
        list.forEach((t) => {
          const d = document.createElement("div");
          d.className = "card";

          d.setAttribute("data-track-id", t.id);

          const isSelected = selectedTracks.some((x) => x.id === t.id);
          if (isSelected) {
            d.classList.add("selected");
          }

          d.onclick = () => addTrack(t);
          d.innerHTML = `
            <img src="${t.image}" alt="${t.name}">
            <div class="music-title">${t.name}</div>
          `;
          results.appendChild(d);
        });
      }

      /* ÏÑ†ÌÉù */
      function addTrack(t) {
        if (selectedTracks.length >= MAX) return;
        if (selectedTracks.some((x) => x.id === t.id)) return;
        selectedTracks.push(t);
        update();
      }

      function removeTrack(i) {
        selectedTracks.splice(i, 1);
        update();
      }

      /* UI Í∞±Ïã† */
      function update() {
        chips.innerHTML = "";

        selectedTracks.forEach((t, i) => {
          const d = document.createElement("div");
          d.className = "track-chip";
          d.innerHTML = `
            <span class="track-chip-text">${t.name}</span>
            <button class="track-chip-remove" onclick="removeTrack(${i})">√ó</button>
          `;
          chips.appendChild(d);
        });

        nextBtn.disabled = selectedTracks.length < MIN;
        saveToLocal("selected_tracks", selectedTracks);

        // üî• Í≤ÄÏÉâ Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏ - IDÎ°ú ÎπÑÍµê
        if (results.children.length > 0) {
          Array.from(results.children).forEach((el) => {
            const trackId = el.getAttribute("data-track-id");
            if (trackId) {
              const isSelected = selectedTracks.some((t) => t.id === trackId);
              if (isSelected) {
                el.classList.add("selected");
              } else {
                el.classList.remove("selected");
              }
            }
          });
        }
      }

      /* üî• ÏôÑÎ£å - edit-profileÏóêÏÑú ÏôîÏúºÎ©¥ ÎèåÏïÑÍ∞ÄÍ∏∞ */
      async function finish() {
        if (selectedTracks.length < MIN) return;
        showLoading("saving...");
        try {
          await apiCall("/users/playlist", "POST", { tracks: selectedTracks });
          hideLoading();

          // üî• edit-profileÏóêÏÑú ÏôîÏúºÎ©¥ Îã§Ïãú ÎèåÏïÑÍ∞ÄÍ∏∞
          if (fromProfile) {
            navigateTo("edit-profile.html");
          } else {
            navigateTo("lounge.html");
          }
        } catch (error) {
          console.error("Failed to save playlist:", error);
          hideLoading();
          alert("failed to save playlist. please try again.");
        }
      }

      function skip() {
        // üî• edit-profileÏóêÏÑú ÏôîÏúºÎ©¥ Îã§Ïãú ÎèåÏïÑÍ∞ÄÍ∏∞
        if (fromProfile) {
          navigateTo("edit-profile.html");
        } else {
          navigateTo("lounge.html");
        }
      }

      nextBtn.onclick = finish;
    </script>
  </body>
</html>
