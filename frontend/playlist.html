<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Playlist</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>
  </head>

  <body>
    <div class="playlist-container">
      <!-- 상단 콘텐츠 그룹 -->
      <div class="playlist-content">
        <div class="chat-header brand-text">
          fill your playlist with <br />
          the sounds you love
        </div>

        <!-- 검색 -->
        <div class="search-box">
          <input
            id="searchInput"
            class="search-input"
            placeholder="song name, artist..."
          />
          <button class="search-btn" onclick="searchMusic()"></button>
        </div>

        <!-- 선택된 곡 -->
        <div id="chips" class="track-chips"></div>

        <!-- 검색 결과 (스크롤 영역) -->
        <div id="results" class="search-results"></div>
      </div>

      <!-- 하단 버튼 그룹 -->
      <div>
        <div class="bottom-text" onclick="skip()">maybe later</div>
        <button id="nextBtn" disabled>next</button>
      </div>
    </div>

    <script src="js/common.js"></script>

    <script>
      const MAX = 10;
      const MIN = 3;

      let selectedTracks = [];

      const input = document.getElementById("searchInput");
      const chips = document.getElementById("chips");
      const results = document.getElementById("results");
      const nextBtn = document.getElementById("nextBtn");

      /* 검색 */
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") searchMusic();
      });

      async function searchMusic() {
        const q = input.value.trim();
        if (!q) return;

        results.innerHTML = "";
        showLoading('searching...');

        try {
          const res = await apiCall(`/music/search?q=${encodeURIComponent(q)}`);
          hideLoading();
          renderResults(res.tracks || []);
        } catch {
          hideLoading();
          results.innerHTML =
            "<div style='text-align: center; padding: 20px; color: var(--error-red);'>search failed</div>";
        }
      }

      /* 결과 렌더링 */
      function renderResults(list) {
        results.innerHTML = "";
        list.forEach((t) => {
          const d = document.createElement("div");
          d.className = "search-result";

          const isSelected = selectedTracks.some((x) => x.id === t.id);
          if (isSelected) {
            d.classList.add("selected");
          }

          d.onclick = () => addTrack(t);
          d.innerHTML = `
            <img src="${t.image}" alt="${t.name}">
            <div class="search-result-title">${t.name}</div>
          `;
          results.appendChild(d);
        });
      }

      /* 선택 */
      function addTrack(t) {
        if (selectedTracks.length >= MAX) return;
        if (selectedTracks.some((x) => x.id === t.id)) return;
        selectedTracks.push(t);
        update();
      }

      function removeTrack(i) {
        selectedTracks.splice(i, 1);
        update();
      }

      /* UI 갱신 */
      function update() {
        chips.innerHTML = "";

        selectedTracks.forEach((t, i) => {
          const d = document.createElement("div");
          d.className = "track-chip";
          d.innerHTML = `
            <span class="track-chip-text">${t.name}</span>
            <button class="track-chip-remove" onclick="removeTrack(${i})">×</button>
          `;
          chips.appendChild(d);
        });

        nextBtn.disabled = selectedTracks.length < MIN;
        saveToLocal("selected_tracks", selectedTracks);

        // 검색 결과 업데이트
        if (results.children.length > 0) {
          Array.from(results.children).forEach((el) => {
            const trackName = el.querySelector(
              ".search-result-title",
            )?.textContent;
            if (trackName) {
              const isSelected = selectedTracks.some(
                (t) => `${t.name}` === trackName,
              );
              if (isSelected) {
                el.classList.add("selected");
              } else {
                el.classList.remove("selected");
              }
            }
          });
        }
      }

      /* 완료 / 스킵 */
      async function finish() {
        if (selectedTracks.length < MIN) return;
        showLoading("saving...");
        await apiCall("/users/playlist", "POST", { tracks: selectedTracks });
        hideLoading();
        navigateTo("lounge.html");
      }

      function skip() {
        navigateTo("lounge.html");
      }

      nextBtn.onclick = finish;
    </script>
  </body>
</html>
