<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Waiting</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>

    <style>
      .waiting-container {
        width: 100%;
        max-width: 480px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        text-align: center;
        position: relative;
        font-family: "Merriweather", serif;
        padding: 60px 20px 40px;
      }

      /* ìš°ì¸¡ ìƒë‹¨ íƒ€ì´ë¨¸ */
      .timer {
        position: absolute;
        top: 30px;
        right: 40px;
        color: #8e8e8e;
        font-size: 14px;
      }

      /* ìƒë‹¨ í…ìŠ¤íŠ¸ ì˜ì—­ */
      .waiting-header {
        flex: 0 0 auto;
      }

      .waiting-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.4;
        margin-top: 80px;
        margin-bottom: 14px;
        min-height: 84px;
      }

      .partner-name {
        text-decoration: underline;
      }

      /* ì¤‘ì•™ ì• ë‹ˆë©”ì´ì…˜ */
      .waiting-animation {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .pulse-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6ec4 0%, #7873f5 100%);
        animation: pulse 2s ease-in-out infinite;
        box-shadow: 0 0 40px rgba(255, 110, 196, 0.6);
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      /* í•˜ë‹¨ í…ìŠ¤íŠ¸ & ë²„íŠ¼ ì˜ì—­ */
      .waiting-footer {
        flex: 0 0 auto;
        min-height: 200px;
        width: 100%;
        position: relative;
        padding-bottom: 80px;
      }

      .waiting-question {
        font-size: 20px;
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 80px;
        margin-bottom: 0;
      }

      .waiting-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        width: 100%;
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>
  </head>

  <body>
    <div class="waiting-container">
      <!-- íƒ€ì´ë¨¸ -->
      <div class="timer" id="timer">10</div>

      <!-- ìƒë‹¨ -->
      <div class="waiting-header">
        <div class="waiting-title" id="waitingTitle"></div>
      </div>

      <!-- ì¤‘ì•™ ì• ë‹ˆë©”ì´ì…˜ -->
      <div class="waiting-animation">
        <div class="pulse-circle"></div>
      </div>

      <!-- í•˜ë‹¨ -->
      <div class="waiting-footer">
        <div class="waiting-question" id="waitingQuestion"></div>
        <div class="waiting-buttons" id="waitingButtons"></div>
      </div>
    </div>

    <script src="js/common.js"></script>

    <script type="module">
      import { rtdb, ref, onValue, update, get, remove } from "/js/firebase.js";

      (() => {
      const userId = getFromLocal("user_id");
      if (!userId) {
        navigateTo("index.html");
      }

      // URL íŒŒë¼ë¯¸í„°
      const params = new URLSearchParams(window.location.search);
      const mode = params.get("mode"); // "initiator" or "receiver"
      const requestId = params.get("requestId");

      if (!mode || !requestId) {
        alert("invalid request");
        navigateTo("lounge.html");
        return;
      }

      let partner = getFromLocal("chat_partner");
      const getPartnerName = () => {
        const partnerFirst = partner?.first_name || partner?.firstName || "";
        const partnerLast = partner?.last_name || partner?.lastName || "";
        return `${partnerFirst} ${partnerLast}`.trim() || "your match";
      };

      /* ====================== ğŸ”¥ ì£¼ì œ ì„¤ì • ====================== */

      const TOPICS = {
        1: {
          name: "food",
          question: "let's see if you two vibe when it comes to food",
        },
        2: {
          name: "visual",
          question: "let's see if you two vibe when it comes to visual taste",
        },
        3: {
          name: "life",
          question: "feel free to be open about your expectations for life",
        },
      };

      /* ====================== ğŸ”¥ ë§¤ì¹­ ìš”ì²­ ë¡œë“œ & UI ì´ˆê¸°í™” ====================== */

      async function initUI() {
        try {
          // ğŸ”¥ Firebaseì—ì„œ match_request ì½ê¸°
          const requestRef = ref(rtdb, `match_requests/${requestId}`);
          const snapshot = await get(requestRef);

          if (!snapshot.exists()) {
            alert("request not found");
            navigateTo("lounge.html");
            return;
          }

          const matchRequest = snapshot.val();
          const round = matchRequest.round || 1;
          const topic = matchRequest.topic || "food";

          console.log(`ğŸ¯ Match Request - Round ${round}: ${topic}`);

          if (!partner && mode === "receiver" && matchRequest.initiator_profile) {
            partner = matchRequest.initiator_profile;
            saveToLocal("chat_partner", partner);
          }

          const partnerName = getPartnerName();

          // ğŸ”¥ ë¼ìš´ë“œì— ë§ëŠ” ì§ˆë¬¸ í‘œì‹œ
          const topicData = TOPICS[round];
          const question = topicData.question;

          const titleEl = document.getElementById("waitingTitle");
          const questionEl = document.getElementById("waitingQuestion");
          const buttonsEl = document.getElementById("waitingButtons");

          if (mode === "initiator") {
            // ë‚´ê°€ ìš”ì²­í•œ ê²½ìš°
            titleEl.innerHTML = `waiting for a chat with<br><span class="partner-name">${partnerName}</span>`;
            questionEl.textContent = question;
            buttonsEl.innerHTML = ""; // ë²„íŠ¼ ì—†ìŒ
          } else {
            // ìƒëŒ€ê°€ ìš”ì²­í•œ ê²½ìš°
            titleEl.innerHTML = `<span class="partner-name">${partnerName}</span><br>wants to start a chat<br>with you`;
            questionEl.textContent = question;
            buttonsEl.innerHTML = `
            <button onclick="acceptMatch()">enter</button>
            <div class="bottom-text" onclick="rejectMatch()" style="cursor: pointer; margin-top: 16px;">maybe later</div>
          `;
          }

          // ğŸ”¥ localStorageì— ì €ì¥ (option-select.htmlì—ì„œ ì‚¬ìš©)
          saveToLocal("current_round", round);
          saveToLocal("current_topic", topic);

          // Firebase ë¦¬ìŠ¤ë‹ ì‹œì‘
          startListening();
        } catch (error) {
          console.error("Failed to load match request:", error);
          alert("failed to load match request");
          navigateTo("lounge.html");
        }
      }

      /* ====================== íƒ€ì´ë¨¸ ====================== */

      let timeLeft = 10;
      const timerEl = document.getElementById("timer");

      const timerInterval = setInterval(() => {
        timeLeft--;
        timerEl.textContent = timeLeft;

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          handleTimeout();
        }
      }, 1000);

      /* ====================== Firebase ë¦¬ìŠ¤ë‹ ====================== */

      function startListening() {
        const requestRef = ref(rtdb, `match_requests/${requestId}`);

        onValue(requestRef, (snapshot) => {
          const data = snapshot.val();
          if (!data) {
            clearInterval(timerInterval);
            alert("the other person cancelled or the request timed out");
            navigateTo("lounge.html");
            return;
          }

          if (data.status === "accepted") {
            clearInterval(timerInterval);
            saveToLocal("match_request_id", requestId);
            navigateTo(`option-select.html?requestId=${requestId}`);
          } else if (data.status === "rejected") {
            clearInterval(timerInterval);
            alert("the other person declined");
            navigateTo("lounge.html");
          } else if (data.status === "timeout") {
            clearInterval(timerInterval);
            alert("request timed out");
            navigateTo("lounge.html");
          }
        });
      }

      /* ====================== ì•¡ì…˜ ====================== */

      // ìˆ˜ë½
      window.acceptMatch = async function () {
        const requestRef = ref(rtdb, `match_requests/${requestId}`);
        await update(requestRef, {
          status: "accepted",
        });
      };

      // ê±°ì ˆ
      window.rejectMatch = async function () {
        const requestRef = ref(rtdb, `match_requests/${requestId}`);
        await update(requestRef, {
          status: "rejected",
        });
        await remove(requestRef);
        navigateTo("lounge.html");
      };

      // íƒ€ì„ì•„ì›ƒ
      async function handleTimeout() {
        const requestRef = ref(rtdb, `match_requests/${requestId}`);
        await update(requestRef, {
          status: "timeout",
        });
        await remove(requestRef);
        navigateTo("lounge.html");
      }

      /* ====================== ì •ë¦¬ ====================== */

      window.addEventListener("beforeunload", () => {
        clearInterval(timerInterval);
      });

      /* ====================== Init ====================== */

      window.onload = () => {
        initUI();
      };
      })();
    </script>
  </body>
</html>
