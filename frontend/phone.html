<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>íœ´ëŒ€í° ë²ˆí˜¸ ì…ë ¥</title>
  <link rel="stylesheet" href="css/style.css" />
  <script type="module" src="js/firebase-config.js"></script>

  <style>
    .phone-row {
      display: flex;
      gap: 8px;
    }

    .country-select {
      width: 110px;
      padding: 12px;
      font-size: 14px;
    }

    .phone-input {
      flex: 1;
    }
  </style>
</head>

<body>
  <div class="container">
    <div>
      <h1>tell us your<br />phone number</h1>

      <!-- êµ­ê°€ + ë²ˆí˜¸ ì…ë ¥ -->
      <div class="phone-row">
        <select id="country" class="country-select">
          <option value="+1" selected>ğŸ‡ºğŸ‡¸ +1</option>
          <option value="+82">ğŸ‡°ğŸ‡· +82</option>
          <option value="+81">ğŸ‡¯ğŸ‡µ +81</option>
          <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
          <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
        </select>

        <input
          type="tel"
          id="phone"
          class="phone-input"
          placeholder="10-1234-5678"
          autocomplete="tel"
        />
      </div>

      <span id="error" class="error hidden"></span>

      <div class="terms-text">
        by signing up, you are agreeing to our
        <a href="#">terms of service</a> and
        <a href="#">privacy policy</a>
      </div>
    </div>

    <button onclick="sendOTP()">next</button>
  </div>

  <!-- Firebase invisible recaptcha -->
  <div id="recaptcha-container"></div>

  <script src="js/common.js"></script>

  <script>
    const phoneInput = document.getElementById('phone');
    const countrySelect = document.getElementById('country');


    // =========================================
    // ìˆ«ìë§Œ ì…ë ¥
    // =========================================
    phoneInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });


    // =========================================
    // E.164 í˜•ì‹ ìƒì„±
    // =========================================
    function buildE164() {
      const country = countrySelect.value;
      let number = phoneInput.value.replace(/[^0-9]/g, '');

      if (!number) return null;

      // í•œêµ­/ì¼ë³¸ ë“± ì• 0 ì œê±°
      if (number.startsWith('0')) {
        number = number.slice(1);
      }

      return country + number;
    }


    // =========================================
    // OTP ì „ì†¡ (Firebase)
    // =========================================
    async function sendOTP() {
        hideError('error');

        const countryCode = countrySelect.value;
        const raw = phoneInput.value.replace(/[^0-9]/g, '');

        if (!raw || raw.length < 8) {
            showError('error', 'please enter a valid phone number');
            return;
        }

        let formatted = raw;
        if (countryCode === '+82' && raw.startsWith('0')) {
            formatted = raw.slice(1);
        }

        const fullPhone = countryCode + formatted;

        try {
            showLoading('sending code...');

            // â­â­â­ ì—¬ê¸°ì„œ ìµœì´ˆ 1íšŒ ìƒì„±
            if (!window.recaptchaVerifier) {
            initRecaptcha();
            }

            await sendFirebaseOTP(fullPhone);

            saveToLocal('phone', fullPhone);

            hideLoading();
            navigateTo('otp.html');

        } catch (e) {
            console.error(e);
            hideLoading();
            showError('error', 'failed to send verification code');
        }
    }


    // Enter í‚¤
    phoneInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendOTP();
    });
  </script>
</body>
</html>
