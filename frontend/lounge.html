<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>About Nine</title>

    <link rel="stylesheet" href="css/style.css" />

    <!-- firebase -->
    <script type="module" src="js/firebase.js"></script>
    <script type="module" src="js/presence.js"></script>

    <style>
      .user-card-wrapper {
        position: relative;
      }

      .user-card-wrapper.offline {
        opacity: 0.6;
      }

      .user-card-button {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: auto;
        padding: 8px 20px;
        font-size: 14px;
      }

      .subtitle-text {
        text-align: center;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 400;
      }

      /* Îπà ÏÉÅÌÉú Î∞ïÏä§ */
      .empty-state-box {
        background: var(--bg-card);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 260px);
      }

      .empty-state-box img {
        width: 48px;
        height: 48px;
        margin-bottom: 24px;
        opacity: 0.9;
      }

      .empty-state-box .message {
        font-size: 16px;
        line-height: 1.6;
        color: var(--text-primary);
        max-width: 300px;
        text-align: center;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: "Merriweather", serif;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: var(--bg-card);
        padding: 30px 20px 20px;
        border-radius: 16px;
        width: 90%;
        max-width: 400px;
      }

      .modal-content h3 {
        font-size: 20px;
        margin-bottom: 20px;
        color: var(--text-primary);
      }

      .taste-signature {
        position: relative;
        height: 220px;
        border-radius: 18px;
        overflow: hidden;
        background: #1f1f1f;
        margin-bottom: 18px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .taste-signature::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 18px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
        pointer-events: none;
      }

      .taste-gradient {
        position: absolute;
        inset: -35%;
        background:
          radial-gradient(
            circle at 18% 20%,
            var(--sig-c1, #f08a5d) 0%,
            rgba(0, 0, 0, 0) 55%
          ),
          radial-gradient(
            circle at 78% 30%,
            var(--sig-c2, #6a7ff2) 0%,
            rgba(0, 0, 0, 0) 60%
          ),
          radial-gradient(
            circle at 40% 80%,
            var(--sig-c3, #f6d365) 0%,
            rgba(0, 0, 0, 0) 65%
          );
        filter: blur(12px) saturate(135%);
        animation: tasteFloat 14s ease-in-out infinite;
      }

      .taste-overlay {
        position: relative;
        z-index: 1;
        height: 100%;
        padding: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        gap: 6px;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.5) 70%,
          rgba(0, 0, 0, 0.72) 100%
        );
      }

      .taste-title {
        font-size: 14px;
        letter-spacing: 0.4px;
        text-transform: lowercase;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
      }

      .taste-words {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
      }

      .preview-status {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.65);
        text-align: center;
        margin-top: 6px;
      }

      .taste-spark {
        position: absolute;
        right: 14px;
        top: 14px;
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.85);
        text-transform: lowercase;
        letter-spacing: 0.3px;
      }

      @keyframes tasteFloat {
        0% {
          transform: translate3d(-2%, -1%, 0) scale(1);
        }
        50% {
          transform: translate3d(2%, 2%, 0) scale(1.04);
        }
        100% {
          transform: translate3d(-2%, -1%, 0) scale(1);
        }
      }
    </style>
  </head>

  <body>
    <div class="main-container">
      <div
        class="chat-header brand-text"
        style="text-align: left; color: #8e8e8e"
      >
        about nine
      </div>

      <div class="tabs">
        <button id="loungeTab" class="tab active">lounge</button>
        <button id="aiTab" class="tab">ai match</button>
      </div>

      <div class="content">
        <!-- lounge -->
        <div id="loungeContent">
          <div id="userList" class="card-list"></div>
        </div>

        <!-- ai -->
        <div id="aiContent" style="display: none">
          <div id="aiUserList" class="card-list"></div>
        </div>
      </div>
    </div>

    <!-- ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <nav id="bottomNav" class="bottom-nav"></nav>

    <!-- modal -->
    <div class="modal" id="playlistModal">
      <div class="modal-content">
        <h3 id="modalName"></h3>
        <div class="taste-signature" id="tasteSignature">
          <div class="taste-gradient"></div>
          <div class="taste-spark">taste signature</div>
          <div class="taste-overlay">
            <div class="taste-title" id="tasteTitle"></div>
            <div class="taste-words" id="tasteWords"></div>
          </div>
        </div>
        <div class="preview-status" id="previewStatus"></div>
        <audio id="tastePreviewAudio" preload="auto"></audio>
      </div>
    </div>

    <script src="js/common.js"></script>

    <script type="module">
      import { rtdb, ref, onValue, set, push } from "/js/firebase.js";

      const userId = getFromLocal("user_id");
      if (!userId) {
        navigateTo("index.html");
      }

      let users = [];
      let aiUsers = [];
      let selectedUser = null;
      let presenceData = {};
      let currentUserProfile = null;

      /* ====================== Ï£ºÏ†ú ÏÑ§Ï†ï ====================== */

      const TOPICS = {
        1: {
          name: "food",
          question: "let's see if you two vibe when it comes to food",
        },
        2: {
          name: "visual",
          question: "let's see if you two vibe when it comes to visual taste",
        },
        3: {
          name: "life",
          question: "feel free to be open about your expectations for life",
        },
      };

      /* ====================== ÌÉ≠ ====================== */

      const loungeTab = document.getElementById("loungeTab");
      const aiTab = document.getElementById("aiTab");
      const loungeContent = document.getElementById("loungeContent");
      const aiContent = document.getElementById("aiContent");

      loungeTab.onclick = () => switchTab("lounge");
      aiTab.onclick = () => switchTab("ai");

      function switchTab(tab) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));

        if (tab === "lounge") {
          loungeTab.classList.add("active");
          loungeContent.style.display = "block";
          aiContent.style.display = "none";
          return;
        }

        aiTab.classList.add("active");
        loungeContent.style.display = "none";
        aiContent.style.display = "block";

        if (!isAIMatchTime()) {
          document.getElementById("aiUserList").innerHTML = `
      <div class="empty-state-box">
        <img src="images/asterisk.png" alt="asterisk">
        <div class="message">the matching begins at 8 p.m.<br>and closes at 2 a.m.</div>
      </div>
    `;
          return;
        }

        if (!aiUsers.length) buildAIMatch();
      }

      function isAIMatchTime() {
        const h = new Date().getHours();
        return h >= 20 || h < 2;
      }

      /* ====================== ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ ====================== */

      async function updateLocation() {
        if (!navigator.geolocation) return;

        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            async (pos) => {
              try {
                await apiCall("/users/update-location", "POST", {
                  lat: pos.coords.latitude,
                  lng: pos.coords.longitude,
                });
              } catch (error) {
                console.error("Failed to update location:", error);
              } finally {
                resolve();
              }
            },
            () => resolve(),
          );
        });
      }

      /* ====================== Ïú†Ï†Ä Î∂àÎü¨Ïò§Í∏∞ ====================== */

      async function loadUsers() {
        console.log("üîç Loading users...");
        try {
          const res = await apiCall("/users/list");
          console.log("üìä API Response:", res);
          console.log("üë• Users count:", res.users?.length || 0);
          console.log("üë• Users data:", res.users);

          users = res.users || [];
          renderUsers(users, "userList", "lounge");
        } catch (error) {
          console.error("Failed to load users:", error);
          users = [];
          renderUsers(users, "userList", "lounge");
        }
      }

      /* ====================== AI Ï∂îÏ≤ú ====================== */

      async function buildAIMatch() {
        try {
          const res = await apiCall("/match/recommend");
          const list = Array.isArray(res)
            ? res
            : Array.isArray(res?.users)
              ? res.users
              : Object.values(res?.users || {});
          aiUsers = list.slice(0, 5);
          renderUsers(aiUsers, "aiUserList", "ai");
        } catch (error) {
          console.error("Failed to load ai match:", error);
          aiUsers = [];
          renderUsers(aiUsers, "aiUserList", "ai");
        }
      }

      /* ====================== üî• Ïò®ÎùºÏù∏ ÏÉÅÌÉú ÌôïÏù∏ ====================== */

      function getUserId(u) {
        return u?.id || u?.user_id || u?.uid || u?.userId || null;
      }

      const PRESENCE_TTL_MS = 90000;

      function isOnline(userId) {
        if (!userId) return false;
        const presence = presenceData[userId];
        if (!presence || presence.online !== true) return false;
        const updatedAt = Number(presence.updated_at || 0);
        if (!updatedAt) return false;
        return Date.now() - updatedAt <= PRESENCE_TTL_MS;
      }

      /* ====================== üî• Î†åÎçî (Ï†ïÎ†¨ + ÎπÑÌôúÏÑ±Ìôî) ====================== */

      function renderUsers(list, containerId, mode = "lounge") {
        const el = document.getElementById(containerId);

        if (!list.length) {
          el.innerHTML = `
      <div class="empty-state-box">
        <img src="images/asterisk.png" alt="asterisk">
        <div class="message">no one nearby right now.<br>check back soon!</div>
      </div>
    `;
          return;
        }

        const isAi = mode === "ai";

        const subtitleText = isAi
          ? "our recommended matches"
          : "pick whoever feels right";

        const sortedList = [...list].sort((a, b) => {
          const aOnline = isOnline(getUserId(a));
          const bOnline = isOnline(getUserId(b));
          if (aOnline && !bOnline) return -1;
          if (!aOnline && bOnline) return 1;
          return 0;
        });

        const cardsHtml = sortedList
          .map((u) => {
            const uid = getUserId(u);
            const online = isOnline(uid);

            return `
      <div class="user-card-wrapper ${online ? "" : "offline"}">
        <div 
          class="card"
          ${!isAi ? `data-id="${uid}" style="cursor:pointer; padding-right:120px;"` : `style="padding-right:120px;"`}
        >
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:6px;">
              <span style="font-size:16px;font-weight:600;">
                ${u.first_name || u.firstName} ${u.last_name || u.lastName}
              </span>
              <span class="status-dot ${online ? "online" : "offline"}"></span>
            </div>

            ${
              !isAi
                ? `<div style="font-size:12px;color:var(--text-secondary);margin-top:2px;">
                     check out ${u.first_name || u.firstName}'s playlist
                   </div>`
                : ""
            }
          </div>
        </div>

        <button class="primary user-card-button" data-user-id="${uid}" ${
          online ? "" : "disabled"
        }>
          start talk
        </button>
      </div>
    `;
          })
          .join("");

        el.innerHTML = `
    <div class="subtitle-text">${subtitleText}</div>
    ${cardsHtml}
  `;

        // üî• loungeÏóêÏÑúÎßå playlist ÌÅ¥Î¶≠ ÌóàÏö©
        if (!isAi) {
          el.querySelectorAll(".card").forEach((card) => {
            card.onclick = (e) => {
              const id = card.dataset.id;
              const user = sortedList.find((x) => getUserId(x) === id);
              openPlaylist(user);
            };
          });
        }

        // start talk Î≤ÑÌäº
        el.querySelectorAll(".user-card-button").forEach((btn) => {
          btn.onclick = async (e) => {
            const id = btn.dataset.userId;
            const user = sortedList.find((x) => getUserId(x) === id);
            await startMatchRequest(user);
          };
        });
      }

      /* ====================== üî• Îß§Ïπ≠ ÏöîÏ≤≠ ÏãúÏûë ====================== */

      async function startMatchRequest(partner) {
        saveToLocal("chat_partner", partner);

        try {
          showLoading("preparing...");

          // üî• Backend APIÎ°ú round Í≥ÑÏÇ∞ (ÏñëÏ™Ω talk_history ÌôïÏù∏)
          const roundRes = await apiCall("/talks/calculate-round", "POST", {
            partner_id: getUserId(partner),
          });

          hideLoading();

          if (!roundRes.success) {
            alert("failed to calculate round");
            return;
          }

          const round = roundRes.round;
          const topic = roundRes.topic;
          const question = roundRes.question; // üî• BackendÍ∞Ä ÏÑ†ÌÉùÌïú ÏßàÎ¨∏
          const options = roundRes.options; // üî• BackendÍ∞Ä ÏÑ†ÌÉùÌïú ÏòµÏÖò

          console.log(`üéØ Backend calculated - Round ${round}: ${topic}`);
          if (question) {
            console.log(`   Question: ${question}`);
            console.log(`   Options:`, options);
          }

          // rtdbÏóê Îß§Ïπ≠ ÏöîÏ≤≠ ÏÉùÏÑ±
          const requestsRef = ref(rtdb, "match_requests");
          const newRequestRef = push(requestsRef);
          const requestId = newRequestRef.key;
          saveToLocal("match_request_id", requestId);

          const initiatorProfile = currentUserProfile || {
            id: userId,
            first_name: getFromLocal("firstName"),
            last_name: getFromLocal("lastName"),
            age: getFromLocal("age"),
            gender: getFromLocal("gender"),
          };

          const matchData = {
            initiator: userId,
            receiver: getUserId(partner),
            status: "waiting",
            round: round,
            topic: topic,
            timestamp: Date.now(),
            initiator_profile: initiatorProfile,
          };

          // üî• ÏßàÎ¨∏/ÏòµÏÖò Ï∂îÍ∞Ä (food/visualÎßå)
          if (question) {
            matchData.question = question;
          }
          if (options) {
            matchData.options = options;
          }

          await set(newRequestRef, matchData);

          navigateTo(`waiting.html?mode=initiator&requestId=${requestId}`);
        } catch (error) {
          hideLoading();
          console.error("Failed to start match request:", error);
          alert("failed to start match request");
        }
      }

      /* ====================== Îß§Ïπ≠ ÏöîÏ≤≠ Î¶¨Ïä§Îãù ====================== */

      function listenMatchRequests() {
        const requestsRef = ref(rtdb, "match_requests");

        onValue(requestsRef, (snapshot) => {
          const requests = snapshot.val();
          if (!requests) return;

          for (const [requestId, request] of Object.entries(requests)) {
            if (request.receiver === userId && request.status === "waiting") {
              const initiator = users.find((u) => u.id === request.initiator);
              if (initiator) {
                saveToLocal("chat_partner", initiator);
                navigateTo(`waiting.html?mode=receiver&requestId=${requestId}`);
              }
              break;
            }
          }
        });
      }

      /* ====================== presence Î¶¨Ïä§Îãù ====================== */

      function listenPresence() {
        onValue(ref(rtdb, "presence"), (snap) => {
          presenceData = snap.val() || {};

          // üî• ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïóê Îî∞Îùº Ïû¨Î†åÎçîÎßÅ
          const currentTab = loungeTab.classList.contains("active")
            ? "lounge"
            : "ai";

          if (currentTab === "lounge" && users.length > 0) {
            renderUsers(users, "userList", "lounge");
          } else if (
            currentTab === "ai" &&
            aiUsers.length > 0 &&
            isAIMatchTime()
          ) {
            renderUsers(aiUsers, "aiUserList", "ai");
          }
        });
      }

      /* ====================== playlist modal ====================== */

      const TASTE_WORDS = [
        "hazy",
        "luminous",
        "velvet",
        "warm",
        "noir",
        "airy",
        "crisp",
        "amber",
        "glossy",
        "moody",
        "silk",
        "sunlit",
        "deep",
        "soft",
        "neon",
        "drift",
        "mellow",
        "bold",
        "dusty",
        "bright",
      ];

      function hashString(value) {
        let hash = 2166136261;
        for (let i = 0; i < value.length; i += 1) {
          hash ^= value.charCodeAt(i);
          hash +=
            (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
        }
        return hash >>> 0;
      }

      function pickTasteWords(seed) {
        const words = [];
        let cursor = seed;
        while (words.length < 3) {
          const word = TASTE_WORDS[cursor % TASTE_WORDS.length];
          if (!words.includes(word)) words.push(word);
          cursor = Math.floor(cursor / 7) + 13;
        }
        return words;
      }

      function signatureColors(seed) {
        const base = seed % 360;
        const c1 = `hsl(${base}, 70%, 60%)`;
        const c2 = `hsl(${(base + 50 + (seed % 25)) % 360}, 74%, 54%)`;
        const c3 = `hsl(${(base + 210) % 360}, 68%, 52%)`;
        return [c1, c2, c3];
      }

      const previewAudio = document.getElementById("tastePreviewAudio");
      const previewStatusEl = document.getElementById("previewStatus");
      let previewQueue = [];
      let previewIndex = 0;

      function extractPreviewUrls(tracks) {
        return (tracks || [])
          .map((track) => {
            return (
              track.preview_url ||
              track.previewUrl ||
              track.preview ||
              track.preview_url_30 ||
              track.audio_url ||
              track.audioUrl ||
              ""
            );
          })
          .filter((url) => typeof url === "string" && url.trim() !== "");
      }

      function updatePreviewStatus() {
        if (!previewQueue.length) {
          previewStatusEl.textContent = "no preview available";
          return;
        }
        previewStatusEl.textContent = "";
      }

      function playPreviewAt(index) {
        if (!previewQueue.length) return;
        previewIndex = index % previewQueue.length;
        previewAudio.src = previewQueue[previewIndex];
        updatePreviewStatus();
        previewAudio
          .play()
          .catch(() => {
            previewStatusEl.textContent = "tap to play preview";
          });
      }

      previewAudio.addEventListener("ended", () => {
        if (!previewQueue.length) return;
        setTimeout(() => {
          playPreviewAt(previewIndex + 1);
        }, 300);
      });

      document
        .getElementById("tasteSignature")
        .addEventListener("click", () => {
          if (!previewQueue.length) return;
          playPreviewAt(previewIndex);
        });

      function openPlaylist(u) {
        selectedUser = u;

        const firstName = u.first_name || u.firstName;
        document.getElementById("modalName").innerText =
          firstName + "'s playlist";

        const playlistSeed = (u.playlist || [])
          .map((track) => `${track.name || ""}${track.artist || ""}`)
          .join("");
        const signatureSeed = hashString(`${firstName}${playlistSeed}`);
        const [c1, c2, c3] = signatureColors(signatureSeed);
        const signatureEl = document.getElementById("tasteSignature");
        signatureEl.style.setProperty("--sig-c1", c1);
        signatureEl.style.setProperty("--sig-c2", c2);
        signatureEl.style.setProperty("--sig-c3", c3);
        document.getElementById("tasteTitle").innerText = `${firstName}'s taste`;
        document.getElementById("tasteWords").innerText = pickTasteWords(
          signatureSeed,
        ).join(" ¬∑ ");

        previewQueue = extractPreviewUrls(u.playlist || []);
        previewIndex = 0;
        updatePreviewStatus();
        if (previewQueue.length) {
          playPreviewAt(0);
        }

        document.getElementById("playlistModal").classList.add("active");
      }

      document.getElementById("playlistModal").onclick = (e) => {
        // Î™®Îã¨ Î∞∞Í≤ΩÎßå ÌÅ¥Î¶≠ÌñàÏùÑ ÎïåÎßå Îã´Í∏∞
        if (e.target.id === "playlistModal") {
          previewAudio.pause();
          previewAudio.removeAttribute("src");
          previewQueue = [];
          previewIndex = 0;
          document.getElementById("playlistModal").classList.remove("active");
        }
      };

      // ÎòêÎäî ESC ÌÇ§Î°úÎèÑ Îã´ÏùÑ Ïàò ÏûàÍ≤å
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          previewAudio.pause();
          previewAudio.removeAttribute("src");
          previewQueue = [];
          previewIndex = 0;
          document.getElementById("playlistModal").classList.remove("active");
        }
      });

      /* ====================== init ====================== */

      window.onload = async () => {
        try {
          const profileRes = await apiCall("/users/profile");
          currentUserProfile = profileRes.user || null;
        } catch (error) {
          console.error("Session check failed:", error);
          removeFromLocal("user_id");
          navigateTo("index.html");
          return;
        }

        renderBottomNav("lounge");
        await updateLocation();
        listenPresence();
        await loadUsers();
        if (isAIMatchTime()) {
          switchTab("ai");
        } else {
          switchTab("lounge");
        }
        listenMatchRequests();
      };
    </script>
  </body>
</html>
