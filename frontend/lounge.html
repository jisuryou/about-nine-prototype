<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>About Nine</title>

    <link rel="stylesheet" href="css/style.css" />

    <!-- firebase -->
    <script type="module" src="js/firebase.js"></script>
    <script type="module" src="js/presence.js"></script>

    <style>
      .user-card-wrapper {
        position: relative;
      }

      .user-card-wrapper.offline {
        opacity: 0.6;
      }

      .user-card-button {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: auto;
        padding: 8px 20px;
        font-size: 14px;
      }

      .match-badge {
        background: var(--accent-yellow);
        color: black;
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        position: absolute;
        right: 120px;
        top: 50%;
        transform: translateY(-50%);
      }

      .subtitle-text {
        text-align: center;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 400;
      }

      /* Îπà ÏÉÅÌÉú Î∞ïÏä§ */
      .empty-state-box {
        background: var(--bg-card);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 260px);
      }

      .empty-state-box img {
        width: 48px;
        height: 48px;
        margin-bottom: 24px;
        opacity: 0.9;
      }

      .empty-state-box .message {
        font-size: 16px;
        line-height: 1.6;
        color: var(--text-primary);
        max-width: 300px;
        text-align: center;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: "Merriweather", serif;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: var(--bg-card);
        padding: 30px 20px 20px;
        border-radius: 16px;
        width: 90%;
        max-width: 400px;
      }

      .modal-content h3 {
        font-size: 20px;
        margin-bottom: 20px;
        color: var(--text-primary);
      }

      .modal-tracks {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
      }

      .modal-track-item {
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
      }

      .modal-track-item:last-child {
        border-bottom: none;
      }

      .modal-track-name {
        color: var(--text-primary);
        font-weight: 500;
      }

      .modal-track-artist {
        color: var(--text-secondary);
        font-size: 12px;
        margin-top: 2px;
      }
    </style>
  </head>

  <body>
    <div class="main-container">
      <div
        class="chat-header brand-text"
        style="text-align: left; color: #8e8e8e"
      >
        about nine
      </div>

      <div class="tabs">
        <button id="loungeTab" class="tab active">lounge</button>
        <button id="aiTab" class="tab">ai match</button>
      </div>

      <div class="content">
        <!-- lounge -->
        <div id="loungeContent">
          <div id="userList" class="card-list"></div>
        </div>

        <!-- ai -->
        <div id="aiContent" style="display: none">
          <div id="aiUserList" class="card-list"></div>
        </div>
      </div>
    </div>

    <!-- ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <nav id="bottomNav" class="bottom-nav"></nav>

    <!-- modal -->
    <div class="modal" id="playlistModal">
      <div class="modal-content">
        <h3 id="modalName"></h3>
        <div id="modalTracks" class="modal-tracks"></div>
      </div>
    </div>

    <script src="js/common.js"></script>

    <script type="module">
      import { rtdb, ref, onValue } from "/js/firebase.js";

      let users = [];
      let aiUsers = [];
      let selectedUser = null;
      let presenceData = {}; // üî• presence ÏÉÅÌÉú Ï†ÄÏû•

      /* ====================== ÌÉ≠ ====================== */

      const loungeTab = document.getElementById("loungeTab");
      const aiTab = document.getElementById("aiTab");
      const loungeContent = document.getElementById("loungeContent");
      const aiContent = document.getElementById("aiContent");

      loungeTab.onclick = () => switchTab("lounge");
      aiTab.onclick = () => switchTab("ai");

      function switchTab(tab) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));

        if (tab === "lounge") {
          loungeTab.classList.add("active");
          loungeContent.style.display = "block";
          aiContent.style.display = "none";
          return;
        }

        aiTab.classList.add("active");
        loungeContent.style.display = "none";
        aiContent.style.display = "block";

        if (!isAIMatchTime()) {
          document.getElementById("aiUserList").innerHTML = `
      <div class="empty-state-box">
        <img src="images/asterisk.png" alt="asterisk">
        <div class="message">the matching begins at 8 p.m.<br>and closes at 2 a.m.</div>
      </div>
    `;
          return;
        }

        if (!aiUsers.length) buildAIMatch();
      }

      function isAIMatchTime() {
        const h = new Date().getHours();
        return h >= 20 || h < 2;
      }

      /* ====================== ÏúÑÏπò ‚Üí ÏÑúÎ≤Ñ ÏóÖÎç∞Ïù¥Ìä∏ ====================== */

      async function updateLocation() {
        if (!navigator.geolocation) return;

        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            async (pos) => {
              await apiCall("/users/update-location", "POST", {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
              });
              resolve();
            },
            () => resolve(),
          );
        });
      }

      /* ====================== Ïú†Ï†Ä Î∂àÎü¨Ïò§Í∏∞ ====================== */

      async function loadUsers() {
        console.log("üîç Loading users...");
        const res = await apiCall("/users/list");
        console.log("üìä API Response:", res);
        console.log("üë• Users count:", res.users?.length || 0);
        console.log("üë• Users data:", res.users);

        users = res.users || [];
        renderUsers(users, "userList");
      }

      /* ====================== AI Ï∂îÏ≤ú ====================== */

      function buildAIMatch() {
        aiUsers = [...users]
          .sort(() => Math.random() - 0.5)
          .slice(0, 3)
          .map((u) => ({ ...u, score: 70 + Math.floor(Math.random() * 30) }));

        renderUsers(aiUsers, "aiUserList", true);
      }

      /* ====================== üî• Ïò®ÎùºÏù∏ ÏÉÅÌÉú ÌôïÏù∏ ====================== */

      function isOnline(userId) {
        const presence = presenceData[userId];
        return presence && presence.online === true;
      }

      /* ====================== üî• Î†åÎçî (Ï†ïÎ†¨ + ÎπÑÌôúÏÑ±Ìôî) ====================== */

      function renderUsers(list, containerId, showScore = false) {
        const el = document.getElementById(containerId);

        if (!list.length) {
          el.innerHTML = `
      <div class="empty-state-box">
        <img src="images/asterisk.png" alt="asterisk">
        <div class="message">no one nearby right now.<br>check back soon!</div>
      </div>
    `;
          return;
        }

        // ‚úÖ Ïú†Ï†ÄÍ∞Ä ÏûàÏùÑ ÎïåÎßå ÏïàÎÇ¥ ÌÖçÏä§Ìä∏ ÌëúÏãú
        const isAiMatch = containerId === "aiUserList";
        const subtitleText = isAiMatch
          ? "our recommended matches"
          : "pick whoever feels right";

        // üî• Ïò®ÎùºÏù∏ Ïú†Ï†Ä Î®ºÏ†Ä, Ïò§ÌîÑÎùºÏù∏ Ïú†Ï†Ä ÎÇòÏ§ëÏóê Ï†ïÎ†¨
        const sortedList = [...list].sort((a, b) => {
          const aOnline = isOnline(a.id);
          const bOnline = isOnline(b.id);

          if (aOnline && !bOnline) return -1;
          if (!aOnline && bOnline) return 1;
          return 0;
        });

        const cardsHtml = sortedList
          .map((u) => {
            const online = isOnline(u.id);

            return `
            <div class="user-card-wrapper ${online ? "" : "offline"}">
              <div class="card" data-id="${u.id}" style="cursor: pointer; padding-right: ${showScore ? "140px" : "120px"};">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 16px; font-weight: 600;">${u.first_name || u.firstName} ${u.last_name || u.lastName}</span>
                    <span class="status-dot ${online ? "online" : "offline"}" data-id="${u.id}"></span>
                  </div>
                  <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
                    check out ${u.first_name || u.firstName}'s playlist
                  </div>
                </div>
              </div>
              ${showScore ? `<div class="match-badge">${u.score}%</div>` : ""}
              <button class="primary user-card-button" data-user-id="${u.id}" ${online ? "" : "disabled"}>
                start talk
              </button>
            </div>
          `;
          })
          .join("");

        // ‚úÖ ÏïàÎÇ¥ ÌÖçÏä§Ìä∏ + Ïú†Ï†Ä Ïπ¥Îìú
        el.innerHTML = `
    <div class="subtitle-text">${subtitleText}</div>
    ${cardsHtml}
  `;

        // Ïπ¥Îìú ÌÅ¥Î¶≠ÏúºÎ°ú ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ïó¥Í∏∞
        el.querySelectorAll(".card").forEach((card) => {
          card.onclick = (e) => {
            if (e.target.tagName === "BUTTON") return;
            const id = card.dataset.id;
            const user = sortedList.find((x) => x.id === id);
            openPlaylist(user);
          };
        });

        // Î≤ÑÌäº ÌÅ¥Î¶≠ÏúºÎ°ú ÎåÄÌôî ÏãúÏûë (Ïò®ÎùºÏù∏Ïù∏ Í≤ΩÏö∞Îßå)
        el.querySelectorAll(".user-card-button").forEach((btn) => {
          btn.onclick = (e) => {
            e.stopPropagation();

            // üî• ÎπÑÌôúÏÑ±ÌôîÎêú Î≤ÑÌäºÏùÄ Î¨¥Ïãú
            if (btn.disabled) return;

            const id = btn.dataset.userId;
            const user = sortedList.find((x) => x.id === id);
            saveToLocal("chat_partner", user);
            navigateTo("waiting.html");
          };
        });
      }

      /* ====================== üî• presence realtime (Ïû¨Î†åÎçîÎßÅ) ====================== */

      function listenPresence() {
        onValue(ref(rtdb, "presence"), (snap) => {
          presenceData = snap.val() || {};

          // üî• ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïóê Îî∞Îùº Ïû¨Î†åÎçîÎßÅ
          const currentTab = loungeTab.classList.contains("active")
            ? "lounge"
            : "ai";

          if (currentTab === "lounge" && users.length > 0) {
            renderUsers(users, "userList");
          } else if (
            currentTab === "ai" &&
            aiUsers.length > 0 &&
            isAIMatchTime()
          ) {
            renderUsers(aiUsers, "aiUserList", true);
          }
        });
      }

      /* ====================== playlist modal ====================== */

      function openPlaylist(u) {
        selectedUser = u;

        const firstName = u.first_name || u.firstName;
        document.getElementById("modalName").innerText =
          firstName + "'s playlist";

        document.getElementById("modalTracks").innerHTML = (u.playlist || [])
          .map(
            (t) => `
      <div class="modal-track-item">
        <div class="modal-track-name">${t.name}</div>
        <div class="modal-track-artist">${t.artist}</div>
      </div>
    `,
          )
          .join("");

        document.getElementById("playlistModal").classList.add("active");
      }

      document.getElementById("playlistModal").onclick = (e) => {
        // Î™®Îã¨ Î∞∞Í≤ΩÎßå ÌÅ¥Î¶≠ÌñàÏùÑ ÎïåÎßå Îã´Í∏∞
        if (e.target.id === "playlistModal") {
          document.getElementById("playlistModal").classList.remove("active");
        }
      };

      // ÎòêÎäî ESC ÌÇ§Î°úÎèÑ Îã´ÏùÑ Ïàò ÏûàÍ≤å
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document.getElementById("playlistModal").classList.remove("active");
        }
      });

      /* ====================== init ====================== */

      window.onload = async () => {
        renderBottomNav("lounge");
        await updateLocation();
        listenPresence();
        await loadUsers();
      };
    </script>
  </body>
</html>
