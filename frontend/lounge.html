<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>About Nine</title>

  <link rel="stylesheet" href="css/style.css" />

  <!-- firebase -->
  <script type="module" src="js/firebase.js"></script>
  <script type="module" src="js/presence.js"></script>

  <style>
    body{padding:0;align-items:flex-start;}

    .main-container{
      width:100%;
      max-width:500px;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .header{
      padding:20px;
      text-align:center;
      border-bottom:1px solid var(--border-color);
    }

    .tabs{
      display:flex;
      border-bottom:1px solid var(--border-color);
    }

    .tab{
      flex:1;
      padding:14px;
      background:none;
      border:none;
      color:var(--text-secondary);
      cursor:pointer;
    }

    .tab.active{
      color:var(--text-primary);
      border-bottom:3px solid var(--accent-yellow);
    }

    .content{
      flex:1;
      padding:20px;
      overflow-y:auto;
    }

    .subtitle{
      text-align:center;
      color:var(--text-secondary);
      font-size:14px;
      margin-bottom:20px;
    }

    .user-list{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .user-card{
      background:var(--bg-card);
      padding:16px;
      border-radius:14px;
      border:2px solid var(--border-color);
      cursor:pointer;
    }

    .user-info{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .avatar{
      width:44px;
      height:44px;
      border-radius:50%;
      background:var(--border-color);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .status-dot{
      width:10px;
      height:10px;
      border-radius:50%;
      display:inline-block;
      margin-left:6px;
    }

    .online{background:#2ecc71;}
    .offline{background:#555;}

    .match-score{
      background:var(--accent-yellow);
      color:black;
      padding:4px 10px;
      border-radius:10px;
      font-size:12px;
    }

    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      align-items:center;
      justify-content:center;
    }

    .modal.active{display:flex;}

    .modal-content{
      background:var(--bg-card);
      padding:20px;
      border-radius:16px;
      width:90%;
      max-width:400px;
    }
  </style>
</head>

<body>

<div class="main-container">

  <div class="header">
    <h2>about nine</h2>
  </div>

  <div class="tabs">
    <button id="loungeTab" class="tab active">lounge</button>
    <button id="aiTab" class="tab">ai match</button>
  </div>

  <div class="content">

    <!-- lounge -->
    <div id="loungeContent">
      <p class="subtitle">people within 10km</p>
      <div id="userList" class="user-list"></div>
    </div>

    <!-- ai -->
    <div id="aiContent" style="display:none;">
      <p class="subtitle">ai powered matches</p>
      <div id="aiUserList" class="user-list"></div>
    </div>

  </div>
</div>

<!-- modal -->
<div class="modal" id="playlistModal">
  <div class="modal-content">
    <h3 id="modalName"></h3>
    <div id="modalTracks"></div>
    <button id="talkBtn">start talk</button>
  </div>
</div>


<script src="js/common.js"></script>

<script type="module">
import { rtdb, ref, onValue } from "/js/firebase.js";

let users=[]
let aiUsers=[]
let selectedUser=null


/* ======================
   ÌÉ≠
====================== */

const loungeTab=document.getElementById("loungeTab")
const aiTab=document.getElementById("aiTab")

loungeTab.onclick=()=>switchTab("lounge")
aiTab.onclick=()=>switchTab("ai")

function switchTab(tab){

  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"))

  if(tab==="lounge"){
    loungeTab.classList.add("active")
    loungeContent.style.display="block"
    aiContent.style.display="none"
    return
  }

  aiTab.classList.add("active")
  loungeContent.style.display="none"
  aiContent.style.display="block"

  if(!isAIMatchTime()){
    document.getElementById("aiUserList").innerHTML=
      "<p style='opacity:.5;text-align:center'>matching available 8pm-2am</p>"
    return
  }

  if(!aiUsers.length) buildAIMatch()
}

function isAIMatchTime(){
  const h=new Date().getHours()
  return (h>=20 || h<2)
}


/* ======================
   ÏúÑÏπò ‚Üí ÏÑúÎ≤Ñ ÏóÖÎç∞Ïù¥Ìä∏
====================== */

async function updateLocation(){
  if(!navigator.geolocation) return

  return new Promise(resolve=>{
    navigator.geolocation.getCurrentPosition(async pos=>{
      await apiCall("/users/update-location","POST",{
        lat:pos.coords.latitude,
        lng:pos.coords.longitude
      })
      resolve()
    },()=>resolve())
  })
}


/* ======================
   Ïú†Ï†Ä Î∂àÎü¨Ïò§Í∏∞
====================== */

async function loadUsers(){
  const res=await apiCall("/users/list")
  users=res.users||[]
  renderUsers(users,"userList")
}


/* ======================
   AI Ï∂îÏ≤ú
====================== */

function buildAIMatch(){
  aiUsers=[...users]
    .sort(()=>Math.random()-0.5)
    .slice(0,3)
    .map(u=>({...u,score:70+Math.floor(Math.random()*30)}))

  renderUsers(aiUsers,"aiUserList",true)
}


/* ======================
   Î†åÎçî
====================== */

function renderUsers(list,containerId,showScore=false){

  const el=document.getElementById(containerId)

  if(!list.length){
    el.innerHTML="<p style='opacity:.5'>no users</p>"
    return
  }

  el.innerHTML=list.map(u=>`
    <div class="user-card" data-id="${u.id}">
      <div style="display:flex;justify-content:space-between;">
        <div class="user-info">
          <div class="avatar">üë§</div>
          <div>
            ${u.firstName}
            <span class="status-dot offline" data-id="${u.id}"></span>
            <div style="font-size:12px;color:gray">${u.age} yrs</div>
          </div>
        </div>
        ${showScore?`<div class="match-score">${u.score}%</div>`:""}
      </div>
    </div>
  `).join("")

  // ÏïàÏ†ÑÌïú ÌÅ¥Î¶≠ Î∞îÏù∏Îî©
  el.querySelectorAll(".user-card").forEach(card=>{
    card.onclick=()=>{
      const id=card.dataset.id
      const user=list.find(x=>x.id===id)
      openPlaylist(user)
    }
  })
}


/* ======================
   presence realtime
====================== */

function listenPresence(){
  onValue(ref(rtdb,"presence"),snap=>{
    const pres=snap.val()||{}

    document.querySelectorAll(".status-dot").forEach(dot=>{
      const p=pres[dot.dataset.id]
      dot.className="status-dot "+(p&&p.online?"online":"offline")
    })
  })
}


/* ======================
   playlist modal
====================== */

function openPlaylist(u){
  selectedUser=u

  modalName.innerText=u.firstName+"'s playlist"

  modalTracks.innerHTML=(u.playlist||[])
    .map(t=>`<div>${t.name} - ${t.artist}</div>`)
    .join("")

  playlistModal.classList.add("active")
}

talkBtn.onclick=()=>{
  saveToLocal("chat_partner",selectedUser)
  navigateTo("waiting.html")
}

playlistModal.onclick=e=>{
  if(e.target.id==="playlistModal")
    playlistModal.classList.remove("active")
}


/* ======================
   init
====================== */

window.onload=async()=>{
  await updateLocation()
  await loadUsers()
  listenPresence()
}
</script>

</body>
</html>
