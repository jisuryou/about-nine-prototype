<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chemistry Score</title>
    <link rel="stylesheet" href="css/style.css" />
    <script type="module" src="js/firebase.js"></script>

    <style>
      /* Ï±ó Ïª®ÌÖåÏù¥ÎÑà */
      .result-chat-container {
        width: 100%;
        max-width: 480px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: "Merriweather", serif;
        overflow: hidden;
        background: linear-gradient(180deg, #4a4a4a 0%, #1a1a1a 100%);
      }

      /* Ìó§Îçî */
      .result-header {
        text-align: center;
        padding: 30px 20px 20px;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }

      /* Ï±ó Î©îÏãúÏßÄ ÏòÅÏó≠ */
      .result-messages {
        flex: 1;
        overflow-y: auto;
        padding: 0 20px 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* Î©îÏãúÏßÄ (COCO) */
      .coco-message {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        opacity: 0;
        animation: fadeIn 0.3s forwards;
      }

      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }

      .coco-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #c471ed 0%, #f64f59 100%);
        flex-shrink: 0;
      }

      .coco-avatar-spacer {
        width: 36px;
        height: 36px;
        flex-shrink: 0;
      }

      .coco-bubble {
        background: #525252;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 6px 14px;
        border-radius: 22px;
        max-width: 70%;
        line-height: 1.5;
        font-size: 14px;
        color: var(--text-primary);
      }

      /* Î©îÏãúÏßÄ (USER) */
      .user-message {
        display: flex;
        justify-content: flex-end;
        opacity: 0;
        animation: fadeIn 0.3s forwards;
      }

      .user-bubble {
        background: linear-gradient(135deg, #5b7fff, #7b5bff);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 6px 14px;
        border-radius: 22px;
        max-width: 70%;
        line-height: 1.5;
        font-size: 14px;
        color: var(--text-primary);
      }

      /* Chemistry Score Ïπ¥Îìú */
      .chemistry-card {
        padding: 20px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .chemistry-card:active {
        transform: scale(0.98);
      }

      .chemistry-score-text {
        font-size: 15px;
        margin-bottom: 12px;
        color: var(--text-primary);
      }

      .chemistry-score-text strong {
        font-weight: 700;
      }

      .view-details-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        width: auto;
      }

      /* ÏûÖÎ†• ÏòÅÏó≠ (ÎìúÎ°≠Îã§Ïö¥ + Ï†ÑÏÜ°) */
      .result-input-area {
        padding: 16px 20px calc(30px + var(--safe-bottom));
        background: transparent;
        display: flex;
        gap: 10px;
        align-items: stretch;
      }

      .choice-dropdown {
        flex: 1;
        background: #3a3a3a;
        border: none;
        border-radius: 28px;
        padding: 12px 18px;
        color: white;
        font-size: 16px;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 18px center;
        padding-right: 45px;
        cursor: pointer;
      }

      .send-btn {
        width: 47px;
        height: 47px;
        border-radius: 50%;
        background: linear-gradient(135deg, #5b7fff, #7b5bff);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
        transition: transform 0.2s;
      }

      .send-btn:active {
        transform: scale(0.95);
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .send-btn::before {
        content: "";
        width: 20px;
        height: 20px;
        background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M4 10H16M16 10L11 5M16 10L11 15' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
      }

      /* Waiting Î©îÏãúÏßÄ */
      .waiting-message {
        text-align: center;
        padding: 12px;
        color: var(--text-secondary);
        font-size: 13px;
        font-style: italic;
      }

      /* ÌîÑÎ°úÌïÑ Ïπ¥Îìú */
      .profile-card {
        padding: 20px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .profile-name {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 12px;
      }

      /* Go to Lounge Î≤ÑÌäº */
      .lounge-button-container {
        padding: 16px 20px calc(30px + var(--safe-bottom));
        background: transparent;
      }

      .lounge-btn {
        width: 100%;
        padding: 16px;
        border-radius: 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }

      /* Î∞îÌÖÄÏãúÌä∏ Ïò§Î≤ÑÎ†àÏù¥ */
      .bottom-sheet-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 999;
      }

      .bottom-sheet-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      /* Î∂ÑÏÑù Î∞îÌÖÄÏãúÌä∏ */
      .analysis-bottom-sheet {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%) translateY(100%);
        width: 100%;
        max-width: 480px;
        height: 100vh;
        background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
        border-radius: 20px 20px 0 0;
        padding: 20px;
        transition: transform 0.3s;
        z-index: 1000;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: "Merriweather", serif;
      }

      .analysis-bottom-sheet.active {
        transform: translateX(-50%) translateY(0);
      }

      .sheet-handle {
        width: 40px;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
      }

      /* ÏõêÌòï Í∑∏ÎûòÌîΩ */
      .score-circle-container {
        position: relative;
        width: 280px;
        height: 280px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
      }

      .score-circle-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 70%
        );
      }

      .score-circle-pattern {
        position: absolute;
        width: 200px;
        height: 200px;
        border-radius: 50%;
      }

      .score-circle-pattern svg {
        width: 100%;
        height: 100%;
      }

      .score-circle-text {
        position: relative;
        z-index: 2;
        text-align: center;
      }

      .score-rating {
        font-size: 45px;
        font-weight: 300;
        color: white;
      }

      .score-number {
        font-size: 38px;
        font-weight: 700;
        color: white;
      }

      /* ÌÇ§ÏõåÎìú ÏòÅÏó≠ */
      .keywords-area {
        width: 100%;
        text-align: center;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
        line-height: 2;
        word-spacing: 0.5em;
      }

      /* ÌîÑÎ°úÌïÑ Î∞îÌÖÄÏãúÌä∏ (Ï†ÑÏ≤¥ ÌôîÎ©¥) */
      .profile-bottom-sheet {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%) translateY(100%);
        width: 100%;
        max-width: 480px;
        height: 100vh;
        background: #1a1a1a;
        transition: transform 0.3s;
        z-index: 1000;
        overflow-y: auto;
        padding: 40px 20px calc(30px + var(--safe-bottom));
        font-family: "Merriweather", serif;
      }

      .profile-bottom-sheet.active {
        transform: translateX(-50%) translateY(0);
      }

      .profile-sheet-handle {
        width: 40px;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
      }

      .profile-sheet-name {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .profile-sheet-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 10px;
      }

      .profile-info-card {
        background: #2a2a2a;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 18px 20px;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .profile-info-card.locked {
        filter: blur(6px);
        pointer-events: none;
      }

      .profile-info-card.stacked {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .profile-info-row {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .profile-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      .profile-label {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .profile-value {
        font-size: 12px;
        color: var(--text-primary);
        font-weight: 500;
        text-align: right;
      }

      .profile-info-label {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .profile-info-value {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .playlist-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .playlist-chip {
        background: #3a3a3a;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
        color: white;
      }

      .profile-trials-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 8px;
      }

      .profile-trial-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .profile-trial-title {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: lowercase;
      }

      .profile-trial-score {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .unlock-text {
        text-align: center;
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: 30px;
      }

      @supports (height: 100svh) {
        .result-chat-container,
        .analysis-bottom-sheet,
        .profile-bottom-sheet {
          height: 100svh;
        }
      }

      @media (max-width: 420px) {
        .result-header {
          padding: 20px 16px 12px;
        }

        .result-messages {
          padding: 0 16px 16px;
          gap: 10px;
        }

        .result-input-area {
          padding: 12px 16px calc(20px + var(--safe-bottom));
        }

        .lounge-button-container {
          padding: 12px 16px calc(20px + var(--safe-bottom));
        }

        .choice-dropdown {
          font-size: 15px;
          padding: 10px 16px;
          padding-right: 40px;
        }

        .send-btn {
          width: 44px;
          height: 44px;
        }

        .coco-bubble,
        .user-bubble {
          max-width: 78%;
          font-size: 13px;
        }

        .chemistry-card,
        .profile-card {
          padding: 16px;
        }

        .analysis-bottom-sheet {
          padding: calc(20px + var(--safe-top)) 16px
            calc(24px + var(--safe-bottom));
        }

        .profile-bottom-sheet {
          padding: calc(32px + var(--safe-top)) 16px
            calc(24px + var(--safe-bottom));
        }

        .score-circle-container {
          width: 220px;
          height: 220px;
          margin-bottom: 28px;
        }

        .score-rating {
          font-size: 36px;
        }

        .score-number {
          font-size: 30px;
        }

        .keywords-area {
          font-size: 13px;
          word-spacing: 0.4em;
        }

        .profile-info-card {
          padding: 14px 16px;
        }
      }

      @media (max-height: 700px) {
        .score-circle-container {
          width: 210px;
          height: 210px;
          margin-bottom: 24px;
        }

        .result-header {
          padding-top: 18px;
        }
      }
    </style>
  </head>

  <body>
    <div class="result-chat-container chat-container">
      <!-- Ìó§Îçî -->
      <div class="result-header chat-header brand-text">COCO</div>

      <!-- Î©îÏãúÏßÄ ÏòÅÏó≠ -->
      <div class="result-messages chat-messages" id="messages"></div>

      <!-- ÏûÖÎ†• ÏòÅÏó≠ (ÎìúÎ°≠Îã§Ïö¥ + Ï†ÑÏÜ°) -->
      <div class="result-input-area chat-input-area chat-input-wrap" id="inputArea" style="display: none">
        <select class="choice-dropdown chat-select" id="choiceSelect">
          <option value="">go or no</option>
          <option value="go">go</option>
          <option value="no">no</option>
        </select>
        <button class="send-btn chat-send" id="sendBtn" onclick="submitChoice()"></button>
      </div>

      <!-- Go to Lounge Î≤ÑÌäº -->
      <div
        class="lounge-button-container"
        id="loungeContainer"
        style="display: none"
      >
        <button class="lounge-btn" onclick="navigateTo('lounge.html')">
          go to lounge
        </button>
      </div>
    </div>

    <!-- Î∞îÌÖÄÏãúÌä∏ Ïò§Î≤ÑÎ†àÏù¥ -->
    <div
      class="bottom-sheet-overlay"
      id="sheetOverlay"
      onclick="closeSheet()"
    ></div>

    <!-- Î∂ÑÏÑù ÏÉÅÏÑ∏ Î∞îÌÖÄÏãúÌä∏ -->
    <div class="analysis-bottom-sheet" id="analysisSheet">
      <div class="sheet-handle"></div>

      <!-- ÏõêÌòï Í∑∏ÎûòÌîΩ -->
      <div class="score-circle-container">
        <div class="score-circle-bg"></div>
        <div class="score-circle-pattern">
          <svg viewBox="0 0 200 200">
            <circle
              cx="100"
              cy="100"
              r="80"
              fill="none"
              stroke="rgba(255,255,255,0.2)"
              stroke-width="1"
            />
            <circle
              cx="100"
              cy="100"
              r="60"
              fill="none"
              stroke="rgba(255,255,255,0.15)"
              stroke-width="1"
            />
            <circle
              cx="100"
              cy="100"
              r="40"
              fill="none"
              stroke="rgba(255,255,255,0.1)"
              stroke-width="1"
            />
          </svg>
        </div>
        <div class="score-circle-text">
          <div class="score-rating" id="sheetRating">fair</div>
          <div class="score-number" id="sheetScore">80</div>
        </div>
      </div>

      <!-- ÌÇ§ÏõåÎìú -->
      <div class="keywords-area" id="sheetKeywords">
        empathic words empathic words empathic empathic words empathic words
        empathic empathic words empathic words empathic empathic words empathic
        words empathic empathic words empathic words empathic
      </div>
    </div>

    <!-- ÌîÑÎ°úÌïÑ Î∞îÌÖÄÏãúÌä∏ -->
    <div class="profile-bottom-sheet" id="profileSheet">
      <div class="profile-sheet-handle"></div>
      <div class="profile-sheet-header">
        <div class="profile-sheet-name" id="profileName">tommy hills</div>
      </div>

      <div class="profile-sheet-subtitle" id="profileTrials"></div>

      <div id="profileCards"></div>

      <div class="unlock-text" id="unlockText"></div>
    </div>

    <script src="js/common.js"></script>

    <script type="module">

      const userId = getFromLocal("user_id");
      let effectiveUserId = userId;
      let talkId = getFromLocal("current_talk_id");
      const partner = getFromLocal("chat_partner");
      const requestId = getFromLocal("match_request_id");

      let talkData = null;
      let analysisScore = null;
      let currentRound = 1;
      let myChoice = null;
      let partnerPollTimer = null;
      let lastMessageType = null;

      /* ================= Ï¥àÍ∏∞Ìôî ================= */

      window.onload = async () => {
        if (!userId || !partner) {
          console.error("‚ùå ÌïÑÏàò Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå");
          alert("invalid request");
          navigateTo("lounge.html");
          return;
        }

        try {
          const res = await loadTalkHistory();
          if (!res?.talk) {
            console.error("‚ùå talk_history ÏóÜÏùå");
            removeFromLocal("current_talk_id");
            navigateTo("lounge.html");
            return;
          }

          talkData = res.talk;
          currentRound = talkData.round || 1;
          analysisScore = extractAnalysisScore(talkData);

          console.log("‚úÖ talk_history Î°úÎìú:", talkData);

          if (analysisScore === null) {
            waitForAnalysis();
          }

          startChat();
        } catch (e) {
          console.error("‚ùå Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", e);
          navigateTo("lounge.html");
        }
      };

      /* ================= Ï±ó ÏßÑÌñâ ================= */

      async function startChat() {
        await addCocoMessage("yes", 500);

        const partnerName = getPartnerName();
        await addCocoMessage(
          `here's your chemistry score with ${partnerName}`,
          1000
        );

        await addScoreCard(1500);

        await addCocoMessage("go or no?", 2000);

        showInputArea(2500);
      }

      function getPartnerName() {
        const first = partner?.firstName || partner?.first_name || "";
        const last = partner?.lastName || partner?.last_name || "";
        return `${first} ${last}`.trim() || "your match";
      }

      /* ================= Î©îÏãúÏßÄ Ï∂îÍ∞Ä ================= */

      async function addCocoMessage(text, delay = 0) {
        await sleep(delay);

        const messages = document.getElementById("messages");
        const showAvatar = lastMessageType !== "coco";

        const messageDiv = document.createElement("div");
        messageDiv.className = "coco-message chat-row";

        messageDiv.innerHTML = `
          ${showAvatar ? '<div class="coco-avatar chat-avatar"></div>' : '<div class="coco-avatar-spacer"></div>'}
          <div class="coco-bubble chat-bubble">${text}</div>
        `;

        messages.appendChild(messageDiv);
        lastMessageType = "coco";
        scrollToBottom();
      }

      async function addUserMessage(text, delay = 0) {
        await sleep(delay);
        const messages = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = "user-message chat-row mine";
        messageDiv.innerHTML = `<div class="user-bubble chat-bubble mine">${text}</div>`;
        messages.appendChild(messageDiv);
        lastMessageType = "user";
        scrollToBottom();
      }

      async function addScoreCard(delay = 0) {
        await sleep(delay);

        const score = calculateScore();
        const rating = getScoreRating(score);
        const scoreText = score === null ? "--" : score;

        const messages = document.getElementById("messages");

        const cardDiv = document.createElement("div");
        cardDiv.className = "coco-message";

        cardDiv.innerHTML = `
          <div class="coco-avatar"></div>
          <div class="coco-bubble" style="max-width: 80%; padding: 0;">
            <div class="chemistry-card" onclick="openAnalysisSheet()">
              <div class="chemistry-score-text">
                chemistry score:
                <strong id="chemistryScoreValue">${scoreText}</strong>
                (<span id="chemistryScoreRating">${rating}</span>)
              </div>
              <button class="view-details-btn">view details</button>
            </div>
          </div>
        `;

        messages.appendChild(cardDiv);
        scrollToBottom();
      }

      /* ================= ÏûÖÎ†• ÏòÅÏó≠ ÌëúÏãú ================= */

      async function showInputArea(delay = 0) {
        await sleep(delay);
        document.getElementById("inputArea").style.display = "flex";
      }

      /* ================= ÏÑ†ÌÉù Ï†úÏ∂ú ================= */

      window.submitChoice = async () => {
        const select = document.getElementById("choiceSelect");
        const choice = select.value;

        if (!choice) {
          alert("Please select go or no");
          return;
        }

        myChoice = choice;
        console.log(`‚úÖ ÏÑ†ÌÉù: ${choice}`);

        // ÏûÖÎ†• ÏòÅÏó≠ Ïà®Í∏∞Í∏∞
        document.getElementById("inputArea").style.display = "none";
        document.getElementById("sendBtn").disabled = true;

        // ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù Î©îÏãúÏßÄ ÌëúÏãú
        await addUserMessage(choice, 150);

        try {
          const ensured = await ensureTalkId(true);
          if (!ensured) {
            throw new Error("talk_id not ready");
          }

          const res = await apiCall("/talks/respond", "POST", {
            talk_id: talkId,
            choice,
          });
          if (!res.success) {
            throw new Error(res.message || "failed to submit response");
          }

          // üîé ÏÑúÎ≤Ñ Í∏∞Ï§ÄÏúºÎ°ú ÎÇ¥ user_id Ïû¨ÌôïÏù∏ (Î°úÏª¨ user_idÍ∞Ä Ïñ¥Í∏ãÎÇú Í≤ΩÏö∞ ÎåÄÏùë)
          try {
            const rtdbRes = await fetchGoNoGoStatus();
            const latest = rtdbRes ? null : await apiCall(`/talks/history/${talkId}`);
            const goNoGo = rtdbRes?.go_no_go || extractGoNoGoMap(latest?.talk);
            const ids = Object.keys(goNoGo);
            if (ids.length === 1) {
              effectiveUserId = ids[0];
            } else if (effectiveUserId && ids.includes(effectiveUserId)) {
              // keep as-is
            } else if (userId && ids.includes(userId)) {
              effectiveUserId = userId;
            }
          } catch (e) {
            // ignore sync errors
          }
        } catch (error) {
          console.error("Failed to submit response:", error);
          alert("failed to submit response");
          document.getElementById("inputArea").style.display = "flex";
          document.getElementById("sendBtn").disabled = false;
          return;
        }

        // ÎåÄÍ∏∞ Î©îÏãúÏßÄ
        await addCocoMessage("waiting for your match's response...", 300);

        // ÏÉÅÎåÄÎ∞© ÏùëÎãµ Î¶¨Ïä§ÎÑà
        listenForPartnerResponse();
      };

      /* ================= ÏÉÅÎåÄÎ∞© ÏùëÎãµ ÎåÄÍ∏∞ ================= */

      function extractGoNoGoMap(talk) {
        const map =
          talk?.go_no_go && typeof talk.go_no_go === "object"
            ? { ...talk.go_no_go }
            : {};
        if (talk && typeof talk === "object") {
          Object.keys(talk).forEach((key) => {
            if (key.startsWith("go_no_go.")) {
              const id = key.slice("go_no_go.".length);
              map[id] = talk[key];
            }
          });
        }
        return map;
      }

      function getApiBase() {
        try {
          const stored = localStorage.getItem("api_base");
          if (stored) return stored;
        } catch {}
        if (window.__API_BASE__) return window.__API_BASE__;
        return `${window.location.origin}/api`;
      }

      async function fetchGoNoGoStatus() {
        const id = requestId || talkId;
        if (!id) return null;
        try {
          const response = await fetch(`${getApiBase()}/talks/go-no-go/${id}`, {
            credentials: "include",
          });
          if (!response.ok) return null;
          const res = await response.json();
          if (!res?.success) return null;
          return res;
        } catch (e) {
          return null;
        }
      }

      function listenForPartnerResponse() {
        if (!talkId) return;
        if (partnerPollTimer) clearInterval(partnerPollTimer);
        partnerPollTimer = setInterval(async () => {
          try {
            const [res, rtdbRes] = await Promise.all([
              apiCall(`/talks/history/${talkId}`),
              fetchGoNoGoStatus(),
            ]);
            if (!res.success || !res.talk) return;
            const data = res.talk;
            talkData = data || talkData;
            const freshScore = extractAnalysisScore(data);
            if (freshScore !== null && freshScore !== analysisScore) {
              analysisScore = freshScore;
              updateScoreUI();
            }

            const participants =
              rtdbRes?.participants || data?.participants || talkData?.participants || {};
            const expectedCount = Object.values(participants).filter(Boolean).length || 2;
            const goNoGo = rtdbRes?.go_no_go || extractGoNoGoMap(data);
            const goNoGoValues = Object.values(goNoGo).filter(
              (v) => v === true || v === false,
            );

            // ‚úÖ Îëò Îã§ ÏùëÎãµÌñàÎäîÏßÄ ÌåêÎã® (ID Îß§Ïπ≠ Ïã§Ìå®Ìï¥ÎèÑ ÎèôÏûë)
            if (goNoGoValues.length >= expectedCount) {
              const anyNo = goNoGoValues.some((v) => v === false);
              clearInterval(partnerPollTimer);
              partnerPollTimer = null;
              if (anyNo) {
                console.log("‚úÖ ÏµúÏ¢Ö ÏùëÎãµ: someone chose NO");
                await handleSomeoneNo("no");
              } else {
                console.log("‚úÖ ÏµúÏ¢Ö ÏùëÎãµ: both chose GO");
                await handleBothGo();
              }
              return;
            }

            // fallback: Í∏∞Ï°¥ ÌååÌä∏ÎÑà ID Îß§Ïπ≠
            let partnerId =
              participants.user_a === effectiveUserId
                ? participants.user_b
                : participants.user_a;
            if (!partnerId) {
              const ids = Object.keys(goNoGo);
              partnerId = ids.find((id) => id !== effectiveUserId);
            }

            const partnerValue =
              partnerId && Object.prototype.hasOwnProperty.call(goNoGo, partnerId)
                ? goNoGo[partnerId]
                : null;

            const partnerResponse =
              partnerValue === true ? "go" : partnerValue === false ? "no" : null;

            if (partnerResponse) {
              clearInterval(partnerPollTimer);
              partnerPollTimer = null;
              console.log(`‚úÖ ÏÉÅÎåÄÎ∞© ÏùëÎãµ: ${partnerResponse}`);

              if (myChoice === "go" && partnerResponse === "go") {
                await handleBothGo();
              } else {
                await handleSomeoneNo(partnerResponse);
              }
            }
          } catch (error) {
            if (String(error?.message || "").includes("talk_history not found")) {
              clearInterval(partnerPollTimer);
              partnerPollTimer = null;
              removeFromLocal("current_talk_id");
              alert("talk history not found");
              navigateTo("lounge.html");
              return;
            }
            console.error("Failed to poll response:", error);
          }
        }, 2000);
      }


      /* ================= Îëò Îã§ GO ================= */

      async function handleBothGo() {
        await addCocoMessage("alright, this is the profile", 500);
        await addCocoMessage(
          `this might ease a bit of your curiosity about ${getPartnerName()}`,
          1000
        );

        await addProfileCard(1500);

        showLoungeButton(2000);
      }

      async function addProfileCard(delay = 0) {
        await sleep(delay);

        const messages = document.getElementById("messages");

        const cardDiv = document.createElement("div");
        cardDiv.className = "coco-message";

        cardDiv.innerHTML = `
          <div class="coco-avatar"></div>
          <div class="coco-bubble" style="max-width: 80%; padding: 0;">
            <div class="profile-card" onclick="openProfileSheet()">
              <div class="profile-name">${getPartnerName()}</div>
              <button class="view-details-btn">view profile</button>
            </div>
          </div>
        `;

        messages.appendChild(cardDiv);
        scrollToBottom();
      }

      /* ================= Ìïú Î™ÖÏù¥ÎùºÎèÑ NO ================= */

      async function handleSomeoneNo(partnerResponse) {
        if (partnerResponse === "no") {
          await addCocoMessage(
            `sorry, ${getPartnerName()} decided not to continue`,
            500
          );
        } else {
          await addCocoMessage(
            "that's okay, there are more people waiting for you",
            500
          );
        }

        showLoungeButton(1000);
      }

      /* ================= Go to Lounge Î≤ÑÌäº ================= */

      async function showLoungeButton(delay = 0) {
        await sleep(delay);
        document.getElementById("loungeContainer").style.display = "block";
      }

      /* ================= Î∞îÌÖÄÏãúÌä∏ ================= */

      function formatFeatureLabel(key) {
        const mapping = {
          turn_taking: "Turn Taking",
          flow_continuity: "Flow Continuity",
          romantic_intent: "Romantic Intent",
          language_style_ma: "Language Style MA",
          preference_sync: "Preference Sync",
          voice_pitch: "Voice Pitch",
        };
        return mapping[key] || key.replace(/_/g, " ").replace(/\b\w/g, (m) => m.toUpperCase());
      }

      function renderAnalysisFeatures() {
        const analysis = talkData?.analysis || {};
        const baseFeatures = analysis?.features || analysis?.details?.features || {};
        const keys = [
          "turn_taking",
          "flow_continuity",
          "romantic_intent",
          "language_style_ma",
          "preference_sync",
          "voice_pitch",
        ];

        const entries = keys
          .filter((key) => typeof baseFeatures[key] === "number" && !Number.isNaN(baseFeatures[key]))
          .map((key) => [key, baseFeatures[key]]);

        if (!entries.length) {
          return "<div class='waiting-message'>analysis details not ready</div>";
        }

        const warning = analysis?.analysis_warning;
        const items = entries.sort((a, b) => b[1] - a[1]);

        const warningHtml = warning
          ? `<div class='waiting-message'>analysis warning: ${warning}</div>`
          : "";

        const featuresHtml = items
          .map(
            ([key, value]) =>
              `<div>${formatFeatureLabel(key)} <strong>${Math.round(
                value,
              )}</strong></div>`,
          )
          .join("");

        return `${warningHtml}${featuresHtml}`;
      }

      window.openAnalysisSheet = () => {
        const score = calculateScore();
        const rating = getScoreRating(score);

        document.getElementById("sheetScore").textContent =
          score === null ? "--" : score;
        document.getElementById("sheetRating").textContent = rating;
        document.getElementById("sheetKeywords").innerHTML = renderAnalysisFeatures();

        openSheet("analysisSheet");
      };

      async function fetchProfileRounds() {
        const partnerId = partner?.id || partner?.user_id || partner?.uid || partner?.userId;
        if (!partnerId) return null;
        try {
          const res = await apiCall(`/talks/history-detail/${partnerId}`);
          if (!res?.success) return null;
          return res.rounds || null;
        } catch (e) {
          return null;
        }
      }

      function roundLabel(topic) {
        if (topic === "life") return "values";
        return topic || "trial";
      }

      function renderProfileTrials(rounds) {
        if (!rounds || typeof rounds !== "object") return "";
        const items = Object.entries(rounds)
          .map(([roundKey, info]) => {
            const roundNum = Number(roundKey);
            const label = roundLabel(info?.topic);
            const scoreText = info?.score === null || info?.score === undefined ? "--" : info.score;
            return `
              <div class="profile-trial-item">
                <div class="profile-trial-title">${getOrdinal(roundNum)} trial (${label})</div>
                <div class="profile-trial-score">chemistry score ${scoreText}</div>
              </div>
            `;
          })
          .sort((a, b) => {
            return 0;
          });
        return items.join("");
      }

      window.openProfileSheet = async () => {
        const partnerName = getPartnerName();
        const score = calculateScore();

        document.getElementById("profileName").textContent = partnerName;

        const trialsEl = document.getElementById("profileTrials");
        if (trialsEl) {
          const rounds = await fetchProfileRounds();
          if (rounds) {
            trialsEl.innerHTML = `<div class="profile-trials-list">${renderProfileTrials(rounds)}</div>`;
          } else {
            trialsEl.textContent = `${getOrdinal(currentRound)} trial ¬∑ chemistry score ${
              score === null ? "--" : score
            }`;
          }
        }

        const cardsHtml = generateProfileCards();
        document.getElementById("profileCards").innerHTML = cardsHtml;

        const unlockHtml = generateUnlockText();
        document.getElementById("unlockText").innerHTML = unlockHtml;

        openSheet("profileSheet");
      };

      function generateProfileCards() {
        const unlocked = currentRound;
        const profile = partner?.onboarding_profile || {};

        const age = partner?.age ?? profile?.age ?? "--";
        const gender = partner?.gender || profile?.gender || "--";
        const drink = profile?.drink || partner?.drink || "Not provided";
        const smoke = profile?.smoke || partner?.smoke || "Not provided";
        const marijuana = profile?.marijuana || partner?.marijuana || "Not provided";
        const bio = partner?.bio || profile?.bio || "Not provided";
        const moreInfo = partner?.more_info || profile?.more_info || "Not provided";
        const phone = partner?.phone || profile?.phone || "--";
        const playlist = Array.isArray(partner?.playlist) ? partner.playlist : [];

        const lockedAfterRound1 = unlocked < 2;
        const lockedAfterRound2 = unlocked < 3;

        return `
          <div class="profile-info-card">
            <div class="profile-row">
              <span class="profile-info-label profile-label">${age} years old</span>
              <span class="profile-info-value profile-value">${gender}</span>
            </div>
          </div>
          <div class="profile-info-card stacked">
            <div class="profile-info-label profile-label">${getPartnerName()}'s playlist</div>
            <div class="playlist-chips">
              ${
                playlist.length
                  ? playlist
                      .slice(0, 6)
                      .map(
                        (t) =>
                          `<div class="playlist-chip">${t.name || "track"}</div>`,
                      )
                      .join("")
                  : `<div class="playlist-chip">no playlist</div>`
              }
            </div>
          </div>
          <div class="profile-info-card stacked ${lockedAfterRound1 ? "locked" : ""}">
            <div class="profile-info-row profile-row">
              <span class="profile-info-label profile-label">drinking</span>
              <span class="profile-info-value profile-value">${drink}</span>
            </div>
            <div class="profile-info-row profile-row">
              <span class="profile-info-label profile-label">smoking</span>
              <span class="profile-info-value profile-value">${smoke}</span>
            </div>
            <div class="profile-info-row profile-row">
              <span class="profile-info-label profile-label">marijuana</span>
              <span class="profile-info-value profile-value">${marijuana}</span>
            </div>
          </div>
          <div class="profile-info-card stacked ${lockedAfterRound1 ? "locked" : ""}">
            <div class="profile-info-label profile-label">Additional information</div>
            <div class="profile-info-value profile-value">${moreInfo !== "Not provided" ? moreInfo : bio}</div>
          </div>
          <div class="profile-info-card ${lockedAfterRound2 ? "locked" : ""}">
            <div class="profile-row">
              <span class="profile-info-label profile-label">Contact</span>
              <span class="profile-info-value profile-value">${phone}</span>
            </div>
          </div>
        `;
      }

      function generateUnlockText() {
        if (currentRound === 1) {
          return "extra information unlocks after the 2nd chat";
        }
        if (currentRound === 2) {
          return "one last chat left to reach your match";
        }
        return "";
      }

      function getOrdinal(n) {
        if (n === 1) return "1st";
        if (n === 2) return "2nd";
        if (n === 3) return "3rd";
        return `${n}th`;
      }

      function openSheet(sheetId) {
        document.getElementById("sheetOverlay").classList.add("active");
        document.getElementById(sheetId).classList.add("active");
        if (sheetId === "profileSheet") {
          document.getElementById("profileSheet").style.transform = "";
        }
        if (sheetId === "analysisSheet") {
          document.getElementById("analysisSheet").style.transform = "";
        }
      }

      window.closeSheet = () => {
        document.getElementById("sheetOverlay").classList.remove("active");
        const analysisEl = document.getElementById("analysisSheet");
        const profileEl = document.getElementById("profileSheet");
        if (analysisEl) analysisEl.style.transform = "";
        if (profileEl) profileEl.style.transform = "";
        analysisEl?.classList.remove("active");
        profileEl?.classList.remove("active");
      };

      /* ================= Bottom Sheet Drag ================= */
      const profileSheetEl = document.getElementById("profileSheet");
      const analysisSheetEl = document.getElementById("analysisSheet");

      function attachSheetDragClose(sheetEl, { topOnly = true } = {}) {
        let startY = null;
        let lastDy = 0;
        let dragging = false;

        sheetEl.addEventListener("touchstart", (e) => {
          if (!sheetEl.classList.contains("active")) return;
          if (topOnly && sheetEl.scrollTop > 0) return;
          startY = e.touches[0].clientY;
          lastDy = 0;
          dragging = true;
          sheetEl.style.transition = "none";
        });

        sheetEl.addEventListener(
          "touchmove",
          (e) => {
            if (!dragging) return;
            const dy = e.touches[0].clientY - startY;
            if (dy <= 0) return;
            lastDy = dy;
            // Prevent scroll bouncing while dragging the sheet
            if (e.cancelable) e.preventDefault();
            sheetEl.style.transform = `translateX(-50%) translateY(${dy}px)`;
          },
          { passive: false },
        );

        const finishDrag = () => {
          if (!dragging) return;
          dragging = false;
          sheetEl.style.transition = "";
          if (lastDy > 120) {
            closeSheet();
          } else {
            sheetEl.style.transform = "";
          }
        };

        sheetEl.addEventListener("touchend", finishDrag);
        sheetEl.addEventListener("touchcancel", finishDrag);
      }

      attachSheetDragClose(profileSheetEl, { topOnly: false });
      attachSheetDragClose(analysisSheetEl, { topOnly: true });

      /* ================= Score Í≥ÑÏÇ∞ ================= */

      function calculateScore() {
        return analysisScore;
      }

      function getScoreRating(score) {
        if (score === null) return "analyzing";
        if (score >= 90) return "excellent";
        if (score >= 75) return "great";
        if (score >= 60) return "good";
        if (score >= 50) return "fair";
        return "okay";
      }

      function extractAnalysisScore(data) {
        const raw = data?.analysis?.chemistry_score;
        if (typeof raw !== "number" || Number.isNaN(raw)) return null;
        return Math.max(0, Math.min(100, Math.round(raw)));
      }

      async function waitForAnalysis(maxAttempts = 15, intervalMs = 1000) {
        for (let i = 0; i < maxAttempts; i += 1) {
          await sleep(intervalMs);
          try {
            const res = await apiCall(`/talks/history/${talkId}`);
            if (!res.success || !res.talk) continue;

            const fresh = res.talk;
            const score = extractAnalysisScore(fresh);
            if (score !== null) {
              talkData = fresh;
              analysisScore = score;
              updateScoreUI();
              return;
            }
          } catch (error) {
            if (String(error?.message || "").includes("talk_history not found")) {
              removeFromLocal("current_talk_id");
              alert("talk history not found");
              navigateTo("lounge.html");
              break;
            }
          }
        }
        if (analysisScore === null) {
          alert("analysis is taking longer than expected");
        }
      }

      function updateScoreUI() {
        const scoreText = analysisScore === null ? "--" : analysisScore;
        const ratingText = getScoreRating(analysisScore);

        const scoreEl = document.getElementById("chemistryScoreValue");
        if (scoreEl) scoreEl.textContent = scoreText;

        const ratingEl = document.getElementById("chemistryScoreRating");
        if (ratingEl) ratingEl.textContent = ratingText;

        const sheetScoreEl = document.getElementById("sheetScore");
        if (sheetScoreEl) sheetScoreEl.textContent = scoreText;

        const sheetRatingEl = document.getElementById("sheetRating");
        if (sheetRatingEl) sheetRatingEl.textContent = ratingText;
        const sheetKeywordsEl = document.getElementById("sheetKeywords");
        if (sheetKeywordsEl) {
          sheetKeywordsEl.innerHTML = renderAnalysisFeatures();
        }

        const profileScoreEl = document.getElementById("profileScore");
        if (profileScoreEl) {
          profileScoreEl.textContent = `chemistry score ${scoreText}`;
        }
      }

      /* ================= Ïú†Ìã∏ ================= */

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function scrollToBottom() {
        const messages = document.getElementById("messages");
        messages.scrollTop = messages.scrollHeight;
      }

      async function loadTalkHistory() {
        if (!requestId && !talkId) {
          removeFromLocal("current_talk_id");
          return null;
        }

        if (!talkId || (requestId && talkId !== requestId)) {
          const newTalkId = await ensureTalkId(true);
          if (!newTalkId) return null;
        }

        try {
          return await apiCall(`/talks/history/${talkId}`);
        } catch (error) {
          if (String(error?.message || "").includes("talk_history not found")) {
            removeFromLocal("current_talk_id");
            const newTalkId = await ensureTalkId(true);
            if (!newTalkId) return null;
            return await apiCall(`/talks/history/${talkId}`);
          }
          throw error;
        }
      }

      async function ensureTalkId(force = false) {
        if (!requestId) return null;
        if (talkId && talkId === requestId) return talkId;
        if (talkId && !force) return talkId;

        try {
          const res = await apiCall("/talks/save-history", "POST", {
            request_id: requestId,
          });
          if (!res?.success || !res.talk_id) return null;
          talkId = res.talk_id;
          saveToLocal("current_talk_id", talkId);
          return talkId;
        } catch (error) {
          return null;
        }
      }
    </script>
  </body>
</html>
